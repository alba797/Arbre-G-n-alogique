<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Arbre G√©n√©alogique</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Lora:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --cream:#fdf6ed; --parchment:#f5e9d3; --amber:#c07a2f;
  --amber-dark:#8b5320; --amber-light:#e8a455; --brown:#4a2c11;
  --text:#2d1a0a; --muted:#7a5c3d; --white:#fff;
  --shadow:0 4px 20px rgba(74,44,17,.15);
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Lora',Georgia,serif;background:var(--cream);color:var(--text);min-height:100vh;font-size:17px}

/* BRANCH COLORS */
.b-Monsigny             {--bc:#5a9478;--bb:#B5D5C5}
.b-Pillon               {--bc:#c07a2f;--bb:#F5C6A0}
.b-Bareau               {--bc:#4a6ab5;--bb:#C5D5F0}
.b-Baranowski           {--bc:#9b5fa5;--bb:#E8C5E8}

/* HEADER */
header{background:linear-gradient(135deg,var(--brown),var(--amber-dark));padding:20px 20px 16px;position:sticky;top:0;z-index:100;box-shadow:0 2px 16px rgba(0,0,0,.3)}
.hdr-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.hdr-title{font-family:'Playfair Display',serif;color:var(--cream);font-size:22px;font-weight:700}
.hdr-sub{font-size:12px;color:var(--amber-light);font-style:italic}
.hdr-btns{display:flex;gap:8px}
.btn-hdr{background:var(--amber-light);color:var(--brown);border:none;border-radius:50px;padding:10px 18px;font-size:14px;font-weight:600;font-family:'Lora',serif;cursor:pointer;white-space:nowrap}
.btn-hdr-ghost{background:rgba(255,255,255,.2);color:var(--cream);border:2px solid rgba(255,255,255,.3);border-radius:50px;padding:10px 14px;font-size:16px;cursor:pointer}
.search-wrap{display:flex;align-items:center;background:rgba(255,255,255,.15);border:1.5px solid rgba(255,255,255,.3);border-radius:50px;padding:8px 16px;gap:8px}
.search-wrap input{background:transparent;border:none;outline:none;color:var(--cream);font-size:15px;font-family:'Lora',serif;flex:1;min-width:0}
.search-wrap input::placeholder{color:rgba(253,246,237,.6)}

/* FILTER BARS */
.filter-bar{padding:10px 16px 4px;display:flex;gap:7px;overflow-x:auto;scrollbar-width:none}
.filter-bar::-webkit-scrollbar{display:none}
.chip{background:var(--white);border:2px solid var(--parchment);border-radius:50px;padding:6px 13px;font-size:13px;font-family:'Lora',serif;color:var(--muted);cursor:pointer;white-space:nowrap;flex-shrink:0}
.chip.active{background:var(--amber);border-color:var(--amber);color:var(--white);font-weight:600}
.chip.b-Monsigny.active  {background:var(--bb);border-color:var(--bc);color:var(--bc)}
.chip.b-Pillon.active    {background:var(--bb);border-color:var(--bc);color:var(--bc)}
.chip.b-Bareau.active    {background:var(--bb);border-color:var(--bc);color:var(--bc)}
.chip.b-Baranowski.active{background:var(--bb);border-color:var(--bc);color:var(--bc)}
.chip.b-Monsigny  {border-color:#5a9478;color:#2d6b50}
.chip.b-Pillon    {border-color:#c07a2f;color:#8b4a10}
.chip.b-Bareau    {border-color:#4a6ab5;color:#2a4a8b}
.chip.b-Baranowski{border-color:#9b5fa5;color:#6b2a7a}
.stats{padding:5px 16px 10px;color:var(--muted);font-size:12px;font-style:italic}

/* GRID */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:13px;padding:0 13px 110px}
.card{background:var(--white);border-radius:16px;box-shadow:var(--shadow);overflow:hidden;cursor:pointer;animation:up .3s ease both;border-left:4px solid transparent}
.card.b-Monsigny  {border-left-color:#5a9478}
.card.b-Pillon    {border-left-color:#c07a2f}
.card.b-Bareau    {border-left-color:#4a6ab5}
.card.b-Baranowski{border-left-color:#9b5fa5}
.card:active{transform:scale(.97)}
@keyframes up{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.card-img{width:100%;aspect-ratio:1;background:var(--parchment);display:flex;align-items:center;justify-content:center;overflow:hidden}
.card-img img{width:100%;height:100%;object-fit:cover}
.card-body{padding:9px 11px 11px}
.card-name{font-family:'Playfair Display',serif;font-size:14px;font-weight:600;line-height:1.3;margin-bottom:2px}
.card-years{font-size:11px;color:var(--muted);font-style:italic;margin-bottom:4px}
.branch-tags{display:flex;flex-wrap:wrap;gap:3px}
.btag{font-size:10px;padding:2px 7px;border-radius:50px;font-weight:600}
.btag-Monsigny  {background:#B5D5C5;color:#2d6b50}
.btag-Pillon    {background:#F5C6A0;color:#8b4a10}
.btag-Bareau    {background:#C5D5F0;color:#2a4a8b}
.btag-Baranowski{background:#E8C5E8;color:#6b2a7a}

.fab{position:fixed;bottom:24px;right:20px;background:linear-gradient(135deg,var(--amber),var(--amber-dark));color:var(--white);border:none;border-radius:50px;padding:15px 22px;font-size:15px;font-family:'Lora',serif;font-weight:600;box-shadow:0 6px 24px rgba(192,122,47,.45);cursor:pointer;z-index:90}
.empty{text-align:center;padding:50px 30px;color:var(--muted);grid-column:1/-1}
.empty-icon{font-size:56px;margin-bottom:12px}
.empty-title{font-family:'Playfair Display',serif;font-size:20px;color:var(--brown);margin-bottom:6px}

/* OVERLAYS */
.overlay{position:fixed;inset:0;background:rgba(45,26,10,.65);z-index:200;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s}
.overlay.open{opacity:1;pointer-events:all}
.ov-center{align-items:center}
.sheet{background:var(--cream);border-radius:24px 24px 0 0;width:100%;max-width:600px;max-height:92vh;overflow-y:auto;transform:translateY(100%);transition:transform .35s cubic-bezier(.32,.72,0,1);padding-bottom:40px}
.overlay.open .sheet{transform:translateY(0)}
.handle{width:44px;height:5px;background:var(--parchment);border-radius:3px;margin:12px auto 0}
.sheet-hdr{background:linear-gradient(135deg,var(--brown),var(--amber-dark));padding:18px 22px;border-radius:24px 24px 0 0;display:flex;align-items:center;justify-content:space-between}
.sheet-title{font-family:'Playfair Display',serif;color:var(--cream);font-size:20px;font-weight:700}
.btn-x{background:rgba(255,255,255,.2);border:none;border-radius:50%;width:36px;height:36px;color:white;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.sheet-body{padding:18px 22px}

/* DETAIL */
.d-photo-wrap{position:relative}
.d-photo{width:100%;height:220px;background:var(--parchment);display:flex;align-items:center;justify-content:center;margin-top:12px;overflow:hidden}
.d-photo img{width:100%;height:100%;object-fit:cover}
.btn-x-abs{position:absolute;top:14px;right:14px;background:rgba(255,255,255,.9);border:none;border-radius:50%;width:36px;height:36px;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:5}
.d-body{padding:18px 22px}
.d-name{font-family:'Playfair Display',serif;font-size:26px;font-weight:700;color:var(--brown);margin-bottom:3px}
.d-dates{font-size:14px;color:var(--muted);font-style:italic;margin-bottom:10px}
.d-badges{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:14px}
.badge{display:inline-block;background:var(--amber);color:var(--white);padding:3px 12px;border-radius:50px;font-size:12px}
.sec{margin-top:14px}
.sec-title{font-family:'Playfair Display',serif;font-size:15px;color:var(--amber-dark);margin-bottom:8px;border-bottom:1.5px solid var(--parchment);padding-bottom:3px}
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.ii{background:var(--white);border-radius:12px;padding:11px 13px}
.il{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px}
.iv{font-size:14px;font-weight:500}
.bio{font-size:14px;line-height:1.75;white-space:pre-line}
.map-link{color:var(--amber);text-decoration:none;font-weight:600}
.plink{display:flex;align-items:center;gap:10px;background:var(--white);border-radius:13px;padding:9px 13px;cursor:pointer;margin-bottom:7px}
.plink:active{background:var(--parchment)}
.pl-av{width:42px;height:42px;border-radius:50%;background:var(--parchment);display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0}
.pl-av img{width:100%;height:100%;object-fit:cover}
.pl-name{font-family:'Playfair Display',serif;font-size:14px;font-weight:600}
.pl-sub{font-size:11px;color:var(--muted);font-style:italic}
.pl-arr{margin-left:auto;color:var(--amber);font-size:20px}
.d-actions{display:flex;gap:10px;margin-top:14px}
.btn-edit{flex:1;background:var(--amber);color:var(--white);border:none;border-radius:13px;padding:14px;font-size:15px;font-family:'Lora',serif;font-weight:600;cursor:pointer}
.btn-del{background:var(--white);color:#c0392b;border:2px solid #fadbd8;border-radius:13px;padding:14px 16px;font-size:15px;font-family:'Lora',serif;cursor:pointer}

/* FORM */
.fg{margin-bottom:16px}
.fl{display:block;font-size:12px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px}
.fi,.fta,.fsel{width:100%;background:var(--white);border:2px solid var(--parchment);border-radius:12px;padding:12px 15px;font-size:15px;font-family:'Lora',serif;color:var(--text);outline:none;-webkit-appearance:none}
.fi:focus,.fta:focus,.fsel:focus{border-color:var(--amber)}
.fta{min-height:110px;resize:vertical;line-height:1.6}
.f2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.photo-up{border:2.5px dashed var(--amber-light);border-radius:14px;padding:20px;text-align:center;cursor:pointer;background:var(--white)}
.ph-prev{width:100%;max-height:180px;object-fit:cover;border-radius:10px;margin-top:10px}
.btn-save{width:100%;background:linear-gradient(135deg,var(--amber),var(--amber-dark));color:var(--white);border:none;border-radius:14px;padding:16px;font-size:17px;font-family:'Lora',serif;font-weight:700;cursor:pointer;margin-top:6px;box-shadow:0 4px 16px rgba(192,122,47,.4)}

/* BRANCH CHECKBOXES */
.branch-pills{display:flex;flex-wrap:wrap;gap:7px}
.bpill{background:var(--white);border:2px solid var(--parchment);border-radius:50px;padding:8px 15px;font-size:13px;font-family:'Lora',serif;color:var(--muted);cursor:pointer;transition:all .15s;user-select:none}
.bpill.active-Monsigny  {background:#B5D5C5;border-color:#5a9478;color:#2d6b50;font-weight:600}
.bpill.active-Pillon    {background:#F5C6A0;border-color:#c07a2f;color:#8b4a10;font-weight:600}
.bpill.active-Bareau    {background:#C5D5F0;border-color:#4a6ab5;color:#2a4a8b;font-weight:600}
.bpill.active-Baranowski{background:#E8C5E8;border-color:#9b5fa5;color:#6b2a7a;font-weight:600}

/* PARENT PICKER */
.btn-pick{width:100%;background:var(--parchment);border:2px dashed var(--amber-light);border-radius:12px;padding:12px;font-size:14px;font-family:'Lora',serif;color:var(--muted);cursor:pointer;text-align:left;display:flex;align-items:center;gap:8px}
.btn-pick.chosen{background:var(--white);border:2px solid var(--amber);color:var(--text)}
.btn-clr{background:none;border:none;color:#c0392b;font-size:18px;cursor:pointer;padding:4px}
.picker-sheet{background:var(--white);border-radius:24px 24px 0 0;width:100%;max-width:600px;max-height:70vh;overflow-y:auto;transform:translateY(100%);transition:transform .35s cubic-bezier(.32,.72,0,1)}
.overlay.open .picker-sheet{transform:translateY(0)}
.picker-hdr{padding:14px 18px;border-bottom:1.5px solid var(--parchment);display:flex;align-items:center;gap:10px}
.picker-title{font-family:'Playfair Display',serif;font-size:17px;color:var(--brown);flex:1}
.picker-search{flex:2;background:var(--parchment);border:none;border-radius:50px;padding:8px 13px;font-size:14px;font-family:'Lora',serif;outline:none}
.picker-list{padding:10px 14px 40px}
.picker-item{display:flex;align-items:center;gap:10px;padding:9px 10px;border-radius:11px;cursor:pointer;margin-bottom:4px}
.picker-item:active{background:var(--parchment)}
.picker-av{width:38px;height:38px;border-radius:50%;background:var(--parchment);display:flex;align-items:center;justify-content:center;font-size:20px;overflow:hidden;flex-shrink:0}

/* AVATAR CUSTOMIZER */
.av-preview{width:72px;height:72px;background:var(--parchment);border-radius:50%;display:flex;align-items:center;justify-content:center;overflow:hidden;margin:0 auto 14px}
.color-opts{display:flex;flex-wrap:wrap;gap:8px}
.copt{width:30px;height:30px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:all .15s;flex-shrink:0}
.copt.active{border-color:var(--amber);transform:scale(1.2)}
.style-opts{display:flex;flex-wrap:wrap;gap:7px}
.sopt{background:var(--parchment);border:2px solid transparent;border-radius:50px;padding:6px 13px;font-size:13px;font-family:'Lora',serif;color:var(--muted);cursor:pointer}
.sopt.active{background:var(--amber);border-color:var(--amber);color:white;font-weight:600}

/* BULK ASSIGN */
.bulk-row{display:flex;align-items:center;gap:10px;padding:9px 16px;border-bottom:1px solid var(--parchment)}
.bulk-av{width:38px;height:38px;border-radius:50%;background:var(--parchment);display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0}
.bulk-av img{width:100%;height:100%;object-fit:cover}
.bulk-info{flex:1;min-width:0}
.bulk-name{font-family:'Playfair Display',serif;font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.bulk-years{font-size:11px;color:var(--muted)}
.bulk-pills{display:flex;flex-wrap:wrap;gap:4px;justify-content:flex-end;max-width:160px;flex-shrink:0}
.bpill-sm{font-size:10px;padding:4px 9px;border-radius:50px;border:1.5px solid var(--parchment);background:var(--white);color:var(--muted);cursor:pointer;white-space:nowrap;transition:all .15s;font-family:'Lora',serif}
.bpill-sm.active-Monsigny  {background:#B5D5C5;border-color:#5a9478;color:#2d6b50;font-weight:600}
.bpill-sm.active-Pillon    {background:#F5C6A0;border-color:#c07a2f;color:#8b4a10;font-weight:600}
.bpill-sm.active-Bareau    {background:#C5D5F0;border-color:#4a6ab5;color:#2a4a8b;font-weight:600}
.bpill-sm.active-Baranowski{background:#E8C5E8;border-color:#9b5fa5;color:#6b2a7a;font-weight:600}
.bulk-save-bar{position:sticky;bottom:0;background:var(--cream);padding:14px 18px;border-top:1.5px solid var(--parchment)}

/* CONFIRM */
.cbox{background:var(--white);border-radius:22px;padding:28px 24px;margin:20px;max-width:360px;width:calc(100% - 40px);text-align:center;transform:scale(.9);transition:transform .3s}
.overlay.open .cbox{transform:scale(1)}
.c-title{font-family:'Playfair Display',serif;font-size:20px;color:var(--brown);margin:10px 0 7px}
.c-text{font-size:14px;color:var(--muted);margin-bottom:20px;line-height:1.6}
.c-btns{display:flex;gap:10px}
.btn-cy{flex:1;background:#c0392b;color:#fff;border:none;border-radius:13px;padding:13px;font-size:15px;font-family:'Lora',serif;cursor:pointer}
.btn-cn{flex:1;background:var(--parchment);color:var(--text);border:none;border-radius:13px;padding:13px;font-size:15px;font-family:'Lora',serif;cursor:pointer}

/* PIN */
.pin-screen{position:fixed;inset:0;background:linear-gradient(135deg,var(--brown),var(--amber-dark));z-index:500;display:flex;align-items:center;justify-content:center;flex-direction:column;padding:40px 30px}
.pin-screen.hidden{display:none}
.pin-title{font-family:'Playfair Display',serif;color:var(--cream);font-size:24px;font-weight:700;text-align:center;margin-bottom:6px}
.pin-sub{color:var(--amber-light);font-size:14px;font-style:italic;text-align:center;margin-bottom:36px}
.pin-dots{display:flex;gap:14px;margin-bottom:36px}
.pin-dot{width:16px;height:16px;border-radius:50%;background:rgba(255,255,255,.3);transition:all .2s}
.pin-dot.filled{background:var(--amber-light)}
.pin-pad{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;width:100%;max-width:260px}
.pin-btn{background:rgba(255,255,255,.15);border:2px solid rgba(255,255,255,.2);border-radius:16px;padding:16px;font-size:22px;font-family:'Playfair Display',serif;color:var(--cream);cursor:pointer;text-align:center;transition:all .15s}
.pin-btn:active{background:rgba(255,255,255,.3);transform:scale(.95)}
.pin-skip{background:transparent;border-color:transparent;font-size:13px;font-family:'Lora',serif;color:var(--amber-light);padding:12px}
.pin-err{color:#ff8a80;font-size:14px;margin-top:14px;min-height:22px;text-align:center}
.lock-btn{position:fixed;bottom:24px;left:20px;background:rgba(74,44,17,.75);color:var(--cream);border:none;border-radius:50px;padding:11px 16px;font-size:13px;font-family:'Lora',serif;cursor:pointer;z-index:90}

.toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--brown);color:var(--cream);padding:11px 22px;border-radius:50px;font-size:14px;opacity:0;pointer-events:none;transition:all .3s;white-space:nowrap;z-index:999}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
</style>
</head>
<body>

<!-- PIN -->
<div class="pin-screen" id="pinScreen">
  <div style="font-size:56px;margin-bottom:14px">üå≥</div>
  <div class="pin-title">Arbre G√©n√©alogique</div>
  <div class="pin-sub">Entrez votre PIN pour modifier</div>
  <div class="pin-dots">
    <div class="pin-dot" id="d0"></div><div class="pin-dot" id="d1"></div>
    <div class="pin-dot" id="d2"></div><div class="pin-dot" id="d3"></div>
  </div>
  <div class="pin-pad">
    <button class="pin-btn" onclick="pp('1')">1</button>
    <button class="pin-btn" onclick="pp('2')">2</button>
    <button class="pin-btn" onclick="pp('3')">3</button>
    <button class="pin-btn" onclick="pp('4')">4</button>
    <button class="pin-btn" onclick="pp('5')">5</button>
    <button class="pin-btn" onclick="pp('6')">6</button>
    <button class="pin-btn" onclick="pp('7')">7</button>
    <button class="pin-btn" onclick="pp('8')">8</button>
    <button class="pin-btn" onclick="pp('9')">9</button>
    <button class="pin-btn pin-skip" onclick="pinSkip()">üëÅÔ∏è Voir seulement</button>
    <button class="pin-btn" onclick="pp('0')">0</button>
    <button class="pin-btn" onclick="pdel()">‚å´</button>
  </div>
  <div class="pin-err" id="pinErr"></div>
</div>
<button class="lock-btn" id="lockBtn" style="display:none" onclick="doLock()">üîí Sperren</button>

<!-- HEADER -->
<header>
  <div class="hdr-top">
    <div>
      <div class="hdr-title">üå≥ Arbre G√©n√©alogique</div>
      <div class="hdr-sub">Monsigny ¬∑ Bareau</div>
      <div id="syncStatus" style="font-size:11px;color:var(--amber-light);margin-top:2px;transition:opacity .5s">‚è≥ Chargement...</div>
    </div>
    <div class="hdr-btns">
      <button class="btn-hdr-ghost" onclick="openGedcom()" title="Importer GEDCOM">üì•</button>
      <button class="btn-hdr-ghost" onclick="openBulk()" title="Assigner branches">üåø</button>
      <button class="btn-hdr-ghost" onclick="loadData()" title="Actualiser">üîÑ</button>
      <button class="btn-hdr" onclick="openForm(null)">+ Ajouter</button>
    </div>
  </div>
  <div class="search-wrap">
    <span style="color:var(--amber-light)">üîç</span>
    <input type="search" id="searchInput" placeholder="Rechercher..." oninput="render()" autocomplete="off">
  </div>
</header>

<!-- SORT + BRANCH FILTER -->

<!-- MIGRATE BAR -->
<div id="migrateBar" style="display:none;background:#fff3cd;border-bottom:2px solid #ffc107;padding:12px 18px;align-items:center;gap:12px;flex-wrap:wrap">
  <span style="font-size:14px;font-family:'Lora',serif;flex:1">üì± Donn√©es locales trouv√©es sur cet appareil ‚Äì les exporter vers le cloud ?</span>
  <button onclick="migrateToCloud()" style="background:#c07a2f;color:white;border:none;border-radius:50px;padding:8px 18px;font-size:13px;font-family:'Lora',serif;font-weight:600;cursor:pointer;white-space:nowrap">‚òÅÔ∏è Exporter maintenant</button>
  <button onclick="document.getElementById('migrateBar').style.display='none'" style="background:none;border:none;font-size:18px;cursor:pointer;color:#888">‚úï</button>
</div>

<div class="filter-bar">
  <span style="font-size:12px;color:var(--muted);align-self:center;flex-shrink:0">Trier :</span>
  <div class="chip" onclick="setSort('prenom',this)">Pr√©nom A‚ÄìZ</div>
  <div class="chip" onclick="setSort('nom',this)">Nom A‚ÄìZ</div>
  <div class="chip" onclick="setSort('naissance',this)">Naissance</div>
  <div class="chip active" onclick="setSort('generation',this)">G√©n√©ration</div>
</div>
<div class="filter-bar">
  <span style="font-size:12px;color:var(--muted);align-self:center;flex-shrink:0">Branche :</span>
  <div class="chip active" onclick="setBranche('',this)">Toutes</div>
  <div class="chip b-Monsigny"  onclick="setBranche('Monsigny',this)">üü¢ Monsigny</div>
  <div class="chip b-Pillon"    onclick="setBranche('Pillon',this)">üü† Pillon</div>
  <div class="chip b-Bareau"    onclick="setBranche('Bareau',this)">üîµ Bareau</div>
  <div class="chip b-Baranowski" onclick="setBranche('Baranowski de Rawiez',this)">üü£ Baranowski</div>
</div>
<div style="padding:0 16px 4px;font-size:11px;color:var(--muted);font-style:italic">üí° Plusieurs branches s√©lectionnables</div>
<div class="stats" id="stats"></div>
<div style="padding:0 16px 6px;font-size:11px;color:var(--muted);font-style:italic" id="coupleLegend" style="display:none">‚óè Le point de couleur indique les couples (m√™me couleur = en couple)</div>
<div class="grid" id="grid"></div>
<button class="fab" onclick="openForm(null)">+ Ajouter une personne</button>

<!-- DETAIL -->
<div class="overlay" id="detailOv" onclick="closeOv('detailOv')">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="handle"></div>
    <div class="d-photo-wrap">
      <div class="d-photo" id="dPhoto"></div>
      <button class="btn-x-abs" onclick="closeOv('detailOv')">‚úï</button>
    </div>
    <div class="d-body">
      <div class="d-name" id="dName"></div>
      <div class="d-dates" id="dDates"></div>
      <div class="d-badges" id="dBadges"></div>
      <div class="info-grid" id="dInfo"></div>
      <div id="dBio"></div>
      <div id="dParents"></div>
      <div id="dChildren"></div>
      <div id="dSiblings"></div>
      <div id="dPartners"></div>
      <div class="d-actions" style="margin-top:16px">
        <button class="btn-edit" id="btnEdit">‚úèÔ∏è Modifier</button>
        <button class="btn-del" id="btnDel">üóëÔ∏è</button>
      </div>
    </div>
  </div>
</div>

<!-- FORM -->
<div class="overlay" id="formOv" onclick="closeOv('formOv')">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="sheet-hdr">
      <div class="sheet-title" id="formTitle">Ajouter</div>
      <button class="btn-x" onclick="closeOv('formOv')">‚úï</button>
    </div>
    <div class="sheet-body">
      <!-- AVATAR -->
      <div class="fg">
        <label class="fl">üé® Avatar</label>
        <div style="background:var(--white);border-radius:14px;padding:14px">
          <div class="av-preview" id="avPreview"></div>
          <div class="fg" style="margin-bottom:10px">
            <div class="fl">Teint</div>
            <div class="color-opts" id="skinOpts">
              <div class="copt" data-type="skin" data-val="#FDBCB4" style="background:#FDBCB4" onclick="setAv(this)"></div>
              <div class="copt" data-type="skin" data-val="#F1C27D" style="background:#F1C27D" onclick="setAv(this)"></div>
              <div class="copt" data-type="skin" data-val="#E0AC69" style="background:#E0AC69" onclick="setAv(this)"></div>
              <div class="copt" data-type="skin" data-val="#C68642" style="background:#C68642" onclick="setAv(this)"></div>
              <div class="copt" data-type="skin" data-val="#8D5524" style="background:#8D5524" onclick="setAv(this)"></div>
              <div class="copt" data-type="skin" data-val="#4a2c11" style="background:#4a2c11" onclick="setAv(this)"></div>
            </div>
          </div>
          <div class="fg" style="margin-bottom:10px">
            <div class="fl">Couleur des cheveux</div>
            <div class="color-opts" id="hairOpts">
              <div class="copt" data-type="hair" data-val="#1a0a00" style="background:#1a0a00" onclick="setAv(this)"></div>
              <div class="copt" data-type="hair" data-val="#4a2c11" style="background:#4a2c11" onclick="setAv(this)"></div>
              <div class="copt" data-type="hair" data-val="#8B4513" style="background:#8B4513" onclick="setAv(this)"></div>
              <div class="copt" data-type="hair" data-val="#c07a2f" style="background:#c07a2f" onclick="setAv(this)"></div>
              <div class="copt" data-type="hair" data-val="#D4A017" style="background:#D4A017" onclick="setAv(this)"></div>
              <div class="copt" data-type="hair" data-val="#F5CBA7" style="background:#F5CBA7" onclick="setAv(this)"></div>
              <div class="copt" data-type="hair" data-val="#CC0000" style="background:#CC0000" onclick="setAv(this)"></div>
              <div class="copt" data-type="hair" data-val="#aaaaaa" style="background:#aaaaaa" onclick="setAv(this)"></div>
              <div class="copt" data-type="hair" data-val="#eeeeee" style="background:#eeeeee;border:1px solid #ccc" onclick="setAv(this)"></div>
            </div>
          </div>
          <div class="fg" style="margin-bottom:0">
            <div class="fl">Coiffure</div>
            <div class="style-opts" id="styleOpts">
              <div class="sopt" data-val="court" onclick="setAvStyle(this)">Court</div>
              <div class="sopt" data-val="long"  onclick="setAvStyle(this)">Long</div>
              <div class="sopt" data-val="boucle" onclick="setAvStyle(this)">Boucl√©</div>
              <div class="sopt" data-val="chignon" onclick="setAvStyle(this)">Chignon</div>
              <div class="sopt" data-val="tresses" onclick="setAvStyle(this)">Tresses</div>
              <div class="sopt" data-val="chauve" onclick="setAvStyle(this)">Chauve</div>
            </div>
          </div>
        </div>
      </div>
      <!-- PHOTO -->
      <div class="fg">
        <label class="fl">üì∑ Photo (remplace l'avatar)</label>
        <div class="photo-up" onclick="document.getElementById('photoIn').click()">
          <div style="font-size:34px;color:var(--amber)">üì∏</div>
          <div style="font-size:13px;color:var(--muted);margin-top:5px">Choisir depuis la galerie</div>
          <img id="phPrev" class="ph-prev" style="display:none">
        </div>
        <input type="file" id="photoIn" accept="image/*" style="display:none" onchange="handlePhoto(event)">
      </div>
      <!-- NAME -->
      <div class="f2">
        <div class="fg"><label class="fl">Pr√©nom(s) *</label><input class="fi" id="fPre" placeholder="ex. Marie"></div>
        <div class="fg"><label class="fl">Nom</label><input class="fi" id="fNom" placeholder="ex. Dupont"></div>
      </div>
      <!-- DATES -->
      <div class="f2">
        <div class="fg"><label class="fl">üéÇ Naissance</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input class="fi" id="fNais" placeholder="JJ.MM.AAAA" style="flex:1">
          <button type="button" onclick="setUnknown('fNais')" style="background:var(--parchment);border:2px solid var(--parchment);border-radius:10px;padding:10px;font-size:12px;font-family:'Lora',serif;color:var(--muted);cursor:pointer;white-space:nowrap">Inconnu</button>
        </div></div>
        <div class="fg"><label class="fl">‚úù D√©c√®s</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input class="fi" id="fDec" placeholder="JJ.MM.AAAA" style="flex:1">
          <button type="button" onclick="setUnknown('fDec')" style="background:var(--parchment);border:2px solid var(--parchment);border-radius:10px;padding:10px;font-size:12px;font-family:'Lora',serif;color:var(--muted);cursor:pointer;white-space:nowrap">Inconnu</button>
        </div></div>
      </div>
      <!-- LIEUX -->
      <div class="f2">
        <div class="fg"><label class="fl">üìç Lieu de naissance</label><input class="fi" id="fLN" placeholder="ex. Paris"></div>
        <div class="fg"><label class="fl">üìç Lieu de d√©c√®s</label><input class="fi" id="fLD" placeholder="ex. Lyon"></div>
      </div>
      <!-- BRANCHES -->
      <div class="fg">
        <label class="fl">üåø Branche(s) ‚Äî plusieurs possible</label>
        <div class="branch-pills">
          <div class="bpill" data-b="Monsigny"             onclick="toggleBpill(this)">üü¢ Monsigny</div>
          <div class="bpill" data-b="Pillon"               onclick="toggleBpill(this)">üü† Pillon</div>
          <div class="bpill" data-b="Bareau"               onclick="toggleBpill(this)">üîµ Bareau</div>
          <div class="bpill" data-b="Baranowski de Rawiez" onclick="toggleBpill(this)">üü£ Baranowski</div>
        </div>
      </div>
      <!-- PARTNER -->
      <div class="fg">
        <label class="fl">üíë Partenaire(s)</label>
        <div id="partnerList" style="display:flex;flex-direction:column;gap:6px;margin-bottom:6px"></div>
        <button type="button" class="btn-pick" onclick="openPicker('partner')">+ Ajouter un(e) partenaire</button>
      </div>

      <!-- PARENTS -->
      <div class="fg">
        <label class="fl">üë® P√®re</label>
        <div style="display:flex;align-items:center;gap:8px">
          <button type="button" class="btn-pick" id="btnPere" onclick="openPicker('pere')">‚Äî Choisir le p√®re ‚Äî</button>
          <button type="button" class="btn-clr" id="clrPere" onclick="clearParent('pere')" style="display:none">‚úï</button>
        </div>
      </div>
      <div class="fg">
        <label class="fl">üë© M√®re</label>
        <div style="display:flex;align-items:center;gap:8px">
          <button type="button" class="btn-pick" id="btnMere" onclick="openPicker('mere')">‚Äî Choisir la m√®re ‚Äî</button>
          <button type="button" class="btn-clr" id="clrMere" onclick="clearParent('mere')" style="display:none">‚úï</button>
        </div>
      </div>
      <!-- BIO -->
      <div class="fg"><label class="fl">üìñ Biographie</label><textarea class="fta" id="fBio" placeholder="Souvenirs, histoire de vie..."></textarea></div>
      <div class="fg"><label class="fl">‚ú® Anecdotes</label><textarea class="fta" id="fAne" placeholder="Petites histoires, moments dr√¥les..."></textarea></div>
      <button class="btn-save" onclick="savePerson()">üíæ Enregistrer</button>
    </div>
  </div>
</div>

<!-- PARENT PICKER -->
<div class="overlay" id="pickerOv" onclick="closeOv('pickerOv')">
  <div class="picker-sheet" onclick="event.stopPropagation()">
    <div class="picker-hdr">
      <div class="picker-title" id="pickerTitle">Choisir</div>
      <input class="picker-search" id="pickerQ" type="text" placeholder="üîç Rechercher..." oninput="renderPicker()">
      <button class="btn-x" style="background:var(--parchment);color:var(--text)" onclick="closeOv('pickerOv')">‚úï</button>
    </div>
    <div class="picker-list" id="pickerList"></div>
  </div>
</div>

<!-- BULK ASSIGN -->
<div class="overlay" id="bulkOv" onclick="closeOv('bulkOv')">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="sheet-hdr">
      <div>
        <div class="sheet-title">üåø Assigner les branches</div>
        <input style="background:rgba(255,255,255,.15);border:1.5px solid rgba(255,255,255,.3);border-radius:50px;padding:7px 14px;color:var(--cream);font-size:14px;font-family:'Lora',serif;outline:none;width:100%;margin-top:10px" 
          type="text" id="bulkQ" placeholder="üîç Rechercher..." oninput="renderBulk()">
      </div>
      <button class="btn-x" onclick="closeOv('bulkOv')">‚úï</button>
    </div>
    <!-- Bulk filters -->
    <div class="filter-bar" style="padding-top:10px">
      <div class="chip active" onclick="setBulkF('',this)">Tous</div>
      <div class="chip" onclick="setBulkF('none',this)">‚ö†Ô∏è Sans branche</div>
      <div class="chip b-Monsigny"   onclick="setBulkF('Monsigny',this)">üü¢ Monsigny</div>
      <div class="chip b-Pillon"     onclick="setBulkF('Pillon',this)">üü† Pillon</div>
      <div class="chip b-Bareau"     onclick="setBulkF('Bareau',this)">üîµ Bareau</div>
      <div class="chip b-Baranowski" onclick="setBulkF('Baranowski de Rawiez',this)">üü£ Baranowski</div>
    </div>
    <div class="stats" id="bulkStats"></div>
    <div id="bulkList"></div>
    <div class="bulk-save-bar">
      <button class="btn-save" style="margin-top:0" onclick="saveBulk()">üíæ Tout enregistrer</button>
    </div>
  </div>
</div>



<!-- GEDCOM IMPORT -->
<div class="overlay" id="gedcomOv" onclick="closeOv('gedcomOv')">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="sheet-hdr">
      <div>
        <div class="sheet-title">üì• Importer GEDCOM</div>
        <div style="font-size:12px;color:var(--amber-light);margin-top:3px">Fichier .ged depuis MyHeritage, Geneanet...</div>
      </div>
      <button class="btn-x" onclick="closeOv('gedcomOv')">‚úï</button>
    </div>
    <div class="sheet-body">

      <!-- STEP 1: Upload -->
      <div id="gedStep1">
        <div style="background:var(--white);border-radius:14px;padding:20px;text-align:center;margin-bottom:16px">
          <div style="font-size:48px;margin-bottom:10px">üìÇ</div>
          <div style="font-family:'Playfair Display',serif;font-size:17px;color:var(--brown);margin-bottom:6px">Choisir un fichier .ged</div>
          <div style="font-size:13px;color:var(--muted);margin-bottom:16px">Export√© depuis MyHeritage, Geneanet, Ancestry...</div>
          <button onclick="document.getElementById('gedFile').click()" class="btn-save" style="margin-top:0;width:auto;padding:12px 28px">Choisir le fichier</button>
          <input type="file" id="gedFile" accept=".ged,.gedcom" style="display:none" onchange="parseGedcom(event)">
        </div>
        <div style="background:var(--parchment);border-radius:14px;padding:16px">
          <div style="font-family:'Playfair Display',serif;font-size:15px;color:var(--brown);margin-bottom:12px">üìñ Comment exporter ?</div>
          <div style="margin-bottom:12px">
            <div style="font-weight:600;font-size:14px;color:var(--amber-dark);margin-bottom:4px">üîµ MyHeritage</div>
            <div style="font-size:13px;line-height:1.7">G√©rer l'arbre ‚Üí <b>Exporter l'arbre</b> ‚Üí GEDCOM</div>
          </div>
          <div>
            <div style="font-weight:600;font-size:14px;color:var(--amber-dark);margin-bottom:4px">üü¢ Geneanet</div>
            <div style="font-size:13px;line-height:1.7">Mon Espace ‚Üí ton arbre ‚Üí <b>Exporter</b> ‚Üí Format GEDCOM</div>
          </div>
        </div>
      </div>

      <!-- STEP 2: Filter choice -->
      <div id="gedStep2" style="display:none">
        <div id="gedSummary" style="background:var(--white);border-radius:14px;padding:16px;margin-bottom:14px;text-align:center"></div>
        
        <!-- Filter mode -->
        <div style="background:var(--white);border-radius:14px;padding:16px;margin-bottom:14px">
          <div style="font-family:'Playfair Display',serif;font-size:15px;color:var(--brown);margin-bottom:12px">üîç Que voulez-vous importer ?</div>
          
          <!-- Root person picker -->
          <div style="margin-bottom:12px">
            <div style="font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Personne de r√©f√©rence</div>
            <input class="fi" id="gedRootSearch" placeholder="üîç Chercher une personne..." oninput="filterGedRoot()" style="margin-bottom:6px">
            <select class="fsel" id="gedRootSelect" style="margin-bottom:0" onchange="updateGedPreview()">
              <option value="">‚Äî Choisir une personne de r√©f√©rence ‚Äî</option>
            </select>
          </div>

          <div style="display:flex;flex-direction:column;gap:8px">
            <label style="display:flex;align-items:center;gap:10px;background:var(--parchment);border-radius:10px;padding:10px 12px;cursor:pointer">
              <input type="radio" name="gedMode" value="all" checked onchange="updateGedPreview()" style="width:18px;height:18px;accent-color:var(--amber)">
              <div><div style="font-size:14px;font-weight:600">Tout importer</div><div style="font-size:12px;color:var(--muted)">Toutes les personnes du fichier</div></div>
            </label>
            <label style="display:flex;align-items:center;gap:10px;background:var(--parchment);border-radius:10px;padding:10px 12px;cursor:pointer">
              <input type="radio" name="gedMode" value="ancestors" onchange="updateGedPreview()" style="width:18px;height:18px;accent-color:var(--amber)">
              <div><div style="font-size:14px;font-weight:600">‚¨ÜÔ∏è Seulement les anc√™tres directs</div><div style="font-size:12px;color:var(--muted)">Parents, grands-parents, arri√®re-grands-parents...</div></div>
            </label>
            <label style="display:flex;align-items:center;gap:10px;background:var(--parchment);border-radius:10px;padding:10px 12px;cursor:pointer">
              <input type="radio" name="gedMode" value="descendants" onchange="updateGedPreview()" style="width:18px;height:18px;accent-color:var(--amber)">
              <div><div style="font-size:14px;font-weight:600">‚¨áÔ∏è Seulement les descendants directs</div><div style="font-size:12px;color:var(--muted)">Enfants, petits-enfants, arri√®re-petits-enfants...</div></div>
            </label>
            <label style="display:flex;align-items:center;gap:10px;background:var(--parchment);border-radius:10px;padding:10px 12px;cursor:pointer">
              <input type="radio" name="gedMode" value="both" onchange="updateGedPreview()" style="width:18px;height:18px;accent-color:var(--amber)">
              <div><div style="font-size:14px;font-weight:600">‚¨ÜÔ∏è‚¨áÔ∏è Anc√™tres + Descendants</div><div style="font-size:12px;color:var(--muted)">Toute la ligne directe</div></div>
            </label>
            <label style="display:flex;align-items:center;gap:10px;background:var(--parchment);border-radius:10px;padding:10px 12px;cursor:pointer">
              <input type="radio" name="gedMode" value="manual" onchange="updateGedPreview()" style="width:18px;height:18px;accent-color:var(--amber)">
              <div><div style="font-size:14px;font-weight:600">‚úã S√©lection manuelle</div><div style="font-size:12px;color:var(--muted)">Choisir chaque personne individuellement</div></div>
            </label>
          </div>
        </div>

        <!-- Preview list -->
        <div style="font-family:'Playfair Display',serif;font-size:14px;color:var(--brown);margin-bottom:8px">
          Aper√ßu : <span id="gedSelCount">0</span> personne(s) s√©lectionn√©e(s)
        </div>
        <div id="gedPreview" style="max-height:260px;overflow-y:auto;background:var(--white);border-radius:14px;padding:10px;margin-bottom:14px"></div>
        
        <div style="display:flex;gap:10px">
          <button onclick="gedReset()" style="flex:1;background:var(--parchment);border:none;border-radius:13px;padding:14px;font-size:15px;font-family:'Lora',serif;cursor:pointer">‚Üê Retour</button>
          <button onclick="gedImport()" class="btn-save" style="flex:2;margin-top:0">‚úÖ Importer</button>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- CONFIRM -->
<div class="overlay ov-center" id="confirmOv">
  <div class="cbox">
    <div style="font-size:44px">‚ö†Ô∏è</div>
    <div class="c-title">Supprimer ?</div>
    <div class="c-text" id="confirmTxt"></div>
    <div class="c-btns">
      <button class="btn-cn" onclick="closeOv('confirmOv')">Annuler</button>
      <button class="btn-cy" id="btnYes">Supprimer</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============================================================
// CONSTANTS
// ============================================================
const PIN = '2225';
const KEY = 'arbre-v5';
const BRANCHES = ['Monsigny','Pillon','Bareau','Baranowski de Rawiez'];
const BC = {
  'Monsigny':             {bg:'#B5D5C5', text:'#2d6b50'},
  'Pillon':               {bg:'#F5C6A0', text:'#8b4a10'},
  'Bareau':               {bg:'#C5D5F0', text:'#2a4a8b'},
  'Baranowski de Rawiez': {bg:'#E8C5E8', text:'#6b2a7a'},
};
const HAIRSTYLES = {
  court:   (c) => `<ellipse cx="50" cy="26" rx="21" ry="9" fill="${c}"/>`,
  long:    (c) => `<ellipse cx="50" cy="26" rx="21" ry="9" fill="${c}"/><rect x="29" y="26" width="7" height="28" rx="4" fill="${c}"/><rect x="64" y="26" width="7" height="28" rx="4" fill="${c}"/>`,
  boucle:  (c) => `<circle cx="31" cy="27" r="10" fill="${c}"/><circle cx="43" cy="21" r="10" fill="${c}"/><circle cx="57" cy="21" r="10" fill="${c}"/><circle cx="69" cy="27" r="10" fill="${c}"/>`,
  chignon: (c) => `<ellipse cx="50" cy="26" rx="21" ry="9" fill="${c}"/><circle cx="50" cy="14" r="8" fill="${c}"/>`,
  chauve:  ()  => '',
  tresses: (c) => `<ellipse cx="50" cy="26" rx="21" ry="9" fill="${c}"/><rect x="30" y="28" width="6" height="32" rx="3" fill="${c}"/><rect x="64" y="28" width="6" height="32" rx="3" fill="${c}"/>`,
};

// ============================================================
// DATA
// ============================================================
let persons = [];
let sortMode = 'generation';
let brancheFilters = new Set(); // multiple branches can be active
let editingId = null;
let photoData = null;
let formPereId = null;
let formMereId = null;
let formAv = {skin:'#FDBCB4', hair:'#4a2c11', style:'court'};
let pickerTarget = null;
let bulkChanges = {};
let bulkFilter = '';
let isUnlocked = false;
let pinInput = '';

const BIN_ID = '69975946d0ea881f40c79dfb';
const BIN_KEY = '$2a$10$V1K8NkM0TF2TJs.85JhsO.2TU/8SHOE5ChbUCU8ZI0rHVUKHKyhQK';
const BIN_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

async function loadData() {
  showSyncStatus('‚è≥ Chargement...');
  try {
    const r = await fetch(BIN_URL + '/latest', {
      headers: { 'X-Master-Key': BIN_KEY }
    });
    if (r.ok) {
      const data = await r.json();
      const cloudPersons = data.record.persons || [];
      
      // Check if cloud is empty but local has data ‚Üí offer migration
      let localPersons = [];
      try { const l = localStorage.getItem(KEY); localPersons = l ? JSON.parse(l) : []; } catch {}
      // Also check old key
      let oldPersons = [];
      try { const l = localStorage.getItem('arbre-v3'); oldPersons = l ? JSON.parse(l) : []; } catch {}
      const bestLocal = localPersons.length >= oldPersons.length ? localPersons : oldPersons;

      if (cloudPersons.length === 0 && bestLocal.length > 0) {
        persons = bestLocal;
        render();
        showSyncStatus('‚ö†Ô∏è Donn√©es locales trouv√©es');
        setTimeout(() => {
          document.getElementById('migrateBar').style.display = 'flex';
        }, 500);
        return;
      }
      
      persons = cloudPersons;
      showSyncStatus('‚úÖ Synchronis√©');
      setTimeout(() => hideSyncStatus(), 2000);
    } else {
      throw new Error('fetch failed');
    }
  } catch {
    try { const l = localStorage.getItem(KEY); persons = l ? JSON.parse(l) : demo(); } catch { persons = demo(); }
    showSyncStatus('‚ö†Ô∏è Hors ligne');
    setTimeout(() => hideSyncStatus(), 3000);
  }
  render();
}

async function migrateToCloud() {
  document.getElementById('migrateBar').style.display = 'none';
  showSyncStatus('üîÑ Export vers le cloud...');
  try {
    const r = await fetch(BIN_URL, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'X-Master-Key': BIN_KEY },
      body: JSON.stringify({ persons })
    });
    if (r.ok) {
      showSyncStatus('‚úÖ Toutes les donn√©es sont dans le cloud !');
      setTimeout(() => hideSyncStatus(), 3000);
      showToast('üéâ ' + persons.length + ' personnes export√©es !');
    }
  } catch {
    showSyncStatus('‚ö†Ô∏è Erreur export');
    setTimeout(() => hideSyncStatus(), 3000);
  }
}

async function saveData() {
  // Save full data locally (with photos)
  try { localStorage.setItem(KEY, JSON.stringify(persons)); } catch {}
  
  showSyncStatus('üîÑ Synchronisation...');
  try {
    const r = await fetch(BIN_URL, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'X-Master-Key': BIN_KEY },
      body: JSON.stringify({ persons })
    });
    if (r.ok) {
      showSyncStatus('‚úÖ Synchronis√©');
      setTimeout(() => hideSyncStatus(), 2000);
    } else throw new Error('save failed');
  } catch {
    showSyncStatus('‚ö†Ô∏è Sauvegarde locale seulement');
    setTimeout(() => hideSyncStatus(), 3000);
  }
}

function showSyncStatus(msg) {
  let el = document.getElementById('syncStatus');
  if (!el) return;
  el.textContent = msg;
  el.style.opacity = '1';
}
function hideSyncStatus() {
  let el = document.getElementById('syncStatus');
  if (el) el.style.opacity = '0';
}

function demo() {
  return [
    {id:'p1', pre:'Herv√© Gilles',         nom:'Bareau',   nais:'20.12.1940', dec:'',   lieuN:'Paris',      lieuD:'', photo:'', bio:'', ane:'', branches:['Bareau'],    pereId:null, mereId:null, av:{skin:'#FDBCB4',hair:'#4a2c11',style:'court'}},
    {id:'p2', pre:'Mich√®le Marie-Louise', nom:'Monsigny', nais:'30.09.1935', dec:'',   lieuN:'Paris',      lieuD:'', photo:'', bio:'', ane:'', branches:['Monsigny'],   pereId:null, mereId:null, av:{skin:'#F1C27D',hair:'#1a0a00',style:'long'}},
    {id:'p3', pre:'Alexandrine',          nom:'Bareau',   nais:'18.09.1974', dec:'',   lieuN:'Winterthur', lieuD:'', photo:'', bio:'', ane:'', branches:['Bareau','Monsigny'], pereId:'p1', mereId:'p2', av:{skin:'#FDBCB4',hair:'#8B4513',style:'long'}},
    {id:'p4', pre:'G√©raldine',            nom:'Bareau',   nais:'20.04.1976', dec:'',   lieuN:'Winterthur', lieuD:'', photo:'', bio:'', ane:'', branches:['Bareau','Monsigny'], pereId:'p1', mereId:'p2', av:{skin:'#FDBCB4',hair:'#c07a2f',style:'boucle'}},
    {id:'p5', pre:'Virginie',             nom:'Flesch',   nais:'23.11.1956', dec:'',   lieuN:'Winterthur', lieuD:'', photo:'', bio:'', ane:'', branches:['Monsigny'],   pereId:null, mereId:'p2', av:{skin:'#E0AC69',hair:'#D4A017',style:'chignon'}},
  ];
}

// ============================================================
// HELPERS
// ============================================================
function getBranches(p) {
  if (!p.branches) return p.branche ? (Array.isArray(p.branche)?p.branche:[p.branche]) : [];
  return Array.isArray(p.branches) ? p.branches : [p.branches];
}


// Raw generation based on ancestors in system
function _rawGen(p, visited) {
  if (!visited) visited = new Set();
  if (visited.has(p.id)) return 0;
  visited.add(p.id);
  const pere = p.pereId ? persons.find(x=>x.id===p.pereId) : null;
  const mere = p.mereId ? persons.find(x=>x.id===p.mereId) : null;
  if (!pere && !mere) return 0;
  const pg = pere ? _rawGen(pere, visited)+1 : 0;
  const mg = mere ? _rawGen(mere, visited)+1 : 0;
  return Math.max(pg, mg);
}

// Cache with couple normalization
let _genCache = null;
function buildGenCache() {
  _genCache = {};
  // First pass: raw generations
  persons.forEach(p => { _genCache[p.id] = _rawGen(p); });
  
  // Second pass: normalize couples to same generation
  // Get all couples (explicit partners + inferred from shared children)
  const couples = new Set();
  persons.forEach(p => {
    // explicit partners
    (p.partnerIds||[]).forEach(pid => {
      const key = [p.id,pid].sort().join('|');
      couples.add(key);
    });
    // inferred from children
    const children = persons.filter(x=>x.pereId===p.id||x.mereId===p.id);
    children.forEach(c => {
      if (c.pereId && c.mereId && c.pereId!==c.mereId) {
        const key = [c.pereId,c.mereId].sort().join('|');
        couples.add(key);
      }
    });
  });
  
  // For each couple, set both to same (max) generation
  couples.forEach(key => {
    const [id1,id2] = key.split('|');
    if (_genCache[id1]!==undefined && _genCache[id2]!==undefined) {
      const maxGen = Math.max(_genCache[id1], _genCache[id2]);
      _genCache[id1] = maxGen;
      _genCache[id2] = maxGen;
    }
  });
}

function getGeneration(p) {
  if (!_genCache) buildGenCache();
  return _genCache[p.id] ?? _rawGen(p);
}

function calcAge(b) {
  if (!b) return 50;
  const p = b.split('.'); return p.length>=3 ? new Date().getFullYear()-parseInt(p[2]) : 50;
}

function birthYear(p) {
  if (!p.nais) return null;
  const pts = p.nais.split('.'); return pts.length>=3 ? parseInt(pts[2]) : null;
}

function fmtYears(p) {
  if (p.nais && p.dec) return `* ${p.nais}  ‚úù ${p.dec}`;
  if (p.nais) return `* ${p.nais}`;
  return '';
}

function avatar(p, size) {
  const av = p.av || {};
  const skin = av.skin || '#FDBCB4';
  const hair = av.hair || '#4a2c11';
  const style = av.style || 'court';
  const w = size==='lg' ? 100 : size==='sm' ? 42 : 76;
  const hairFn = HAIRSTYLES[style] || HAIRSTYLES.court;
  return `<svg width="${w}" height="${w}" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
    <ellipse cx="50" cy="88" rx="30" ry="16" fill="${skin}" opacity=".5"/>
    <rect x="44" y="57" width="12" height="12" rx="5" fill="${skin}"/>
    <circle cx="50" cy="44" r="22" fill="${skin}"/>
    ${hairFn(hair)}
    <circle cx="43" cy="42" r="2.5" fill="#2d1a0a"/>
    <circle cx="57" cy="42" r="2.5" fill="#2d1a0a"/>
    <circle cx="44" cy="41" r="1" fill="white"/>
    <circle cx="58" cy="41" r="1" fill="white"/>
    <path d="M43 52 Q50 57 57 52" stroke="#2d1a0a" stroke-width="1.8" fill="none" stroke-linecap="round"/>
  </svg>`;
}

function branchTagsHtml(branches) {
  return branches.map(b => {
    const key = b.split(' ')[0];
    return `<span class="btag btag-${key}">${b}</span>`;
  }).join('');
}

function personImgHtml(p, size) {
  return p.photo ? `<img src="${p.photo}" style="width:100%;height:100%;object-fit:cover">` : avatar(p, size);
}

// ============================================================
// RENDER GRID
// ============================================================

function getCoupleKey(p) {
  // Get all partner IDs for p (explicit + inferred from children)
  const pids = new Set(p.partnerIds||[]);
  persons.forEach(c => {
    if ((c.pereId===p.id||c.mereId===p.id) && c.pereId && c.mereId) {
      const other = c.pereId===p.id ? c.mereId : c.pereId;
      pids.add(other);
    }
  });
  persons.forEach(x => { if((x.partnerIds||[]).includes(p.id)) pids.add(x.id); });
  if (pids.size === 0) return p.id;
  return [p.id, ...pids].sort().join('|');
}

function sortByGenerationWithCouples(list) {
  // Group by generation
  const byGen = {};
  list.forEach(p => {
    const g = getGeneration(p);
    if (!byGen[g]) byGen[g] = [];
    byGen[g].push(p);
  });
  
  const result = [];
  Object.keys(byGen).sort((a,b)=>a-b).forEach(g => {
    const group = byGen[g];
    const placed = new Set();
    const ordered = [];
    
    // First pass: place couples together
    group.forEach(p => {
      if (placed.has(p.id)) return;
      placed.add(p.id);
      ordered.push(p);
      
      // Find partner(s) in same generation group
      const pids = new Set(p.partnerIds||[]);
      persons.forEach(c => {
        if ((c.pereId===p.id||c.mereId===p.id) && c.pereId && c.mereId) {
          const other = c.pereId===p.id ? c.mereId : c.pereId;
          pids.add(other);
        }
      });
      persons.forEach(x => { if((x.partnerIds||[]).includes(p.id)) pids.add(x.id); });
      
      pids.forEach(pid => {
        const partner = group.find(x=>x.id===pid);
        if (partner && !placed.has(partner.id)) {
          placed.add(partner.id);
          ordered.push(partner);
        }
      });
    });
    
    result.push(...ordered);
  });
  
  return result;
}


function render() {
  const q = (document.getElementById('searchInput').value||'').toLowerCase().trim();
  let list = persons.filter(p => {
    const full = (p.pre+' '+p.nom).toLowerCase();
    const matchQ = !q || full.includes(q) || (p.lieuN||'').toLowerCase().includes(q);
    const branches = getBranches(p);
    const matchB = brancheFilters.size === 0 || branches.some(b => brancheFilters.has(b));
    return matchQ && matchB;
  });

  if (sortMode === 'generation') {
    list = sortByGenerationWithCouples(list);
  } else {
    list.sort((a,b) => {
      if (sortMode==='naissance') return (birthYear(a)||9999)-(birthYear(b)||9999);
      if (sortMode==='nom') {
        const nc = (a.nom||'').localeCompare(b.nom||'','fr');
        return nc !== 0 ? nc : a.pre.localeCompare(b.pre,'fr');
      }
      return a.pre.localeCompare(b.pre,'fr');
    });
  }

  const genLabel = sortMode==='generation' ? ' ¬∑ tri√© par g√©n√©ration' : '';
  const legendEl = document.getElementById('coupleLegend');
  if (legendEl) legendEl.style.display = sortMode==='generation' ? 'block' : 'none';
  const brancheLabel = brancheFilters.size > 1 ? ` ¬∑ ${brancheFilters.size} branches` : '';
  document.getElementById('stats').textContent = list.length===persons.length
    ? `${persons.length} personne${persons.length>1?'s':''} dans l'arbre${genLabel}${brancheLabel}`
    : `${list.length} sur ${persons.length} personnes${genLabel}${brancheLabel}`;

  const grid = document.getElementById('grid');
  if (!list.length) {
    grid.innerHTML = `<div class="empty"><div class="empty-icon">üîç</div><div class="empty-title">Aucun r√©sultat</div></div>`;
    return;
  }

  // Build couple color map
  const coupleColors = ['#e8a0a0','#a0c4e8','#a0e8b0','#e8d0a0','#c4a0e8','#e8c0e0','#a0e8e0','#e8e0a0'];
  const coupleMap = {}; // personId -> colorIndex
  let colorIdx = 0;
  const assignedCouples = new Set();
  persons.forEach(p => {
    const pids = new Set(p.partnerIds||[]);
    persons.forEach(c => {
      if ((c.pereId===p.id||c.mereId===p.id)&&c.pereId&&c.mereId) {
        const other = c.pereId===p.id?c.mereId:c.pereId; pids.add(other);
      }
    });
    persons.forEach(x => { if((x.partnerIds||[]).includes(p.id)) pids.add(x.id); });
    if (pids.size > 0) {
      const key = [p.id,...pids].sort().join('|');
      if (!assignedCouples.has(key)) {
        assignedCouples.add(key);
        const col = coupleColors[colorIdx % coupleColors.length]; colorIdx++;
        [p.id,...pids].forEach(id => { if(!coupleMap[id]) coupleMap[id]=col; });
      }
    }
  });

  // generation dividers handled inline
  let _lastGen = -1;
  grid.innerHTML = list.map((p,i) => {
    let _divider = '';
    if (sortMode === 'generation') {
      const _g = getGeneration(p);
      if (_g !== _lastGen) {
        _lastGen = _g;
        const _gNames = ['G√©n√©ration 1 ‚Äì Fondateurs','G√©n√©ration 2','G√©n√©ration 3','G√©n√©ration 4','G√©n√©ration 5'];
        _divider = `<div style="grid-column:1/-1;padding:10px 4px 4px;font-family:'Playfair Display',serif;font-size:15px;font-weight:600;color:var(--amber-dark);border-bottom:2px solid var(--parchment);margin-top:4px">${_gNames[_g]||'G√©n√©ration '+(_g+1)}</div>`;
      }
    }
        const branches = getBranches(p);
    const firstKey = branches.length ? branches[0].split(' ')[0] : '';
    
    const coupleCol = coupleMap[p.id];
    const coupleDot = coupleCol ? `<div title="En couple" style="position:absolute;top:8px;right:8px;width:12px;height:12px;border-radius:50%;background:${coupleCol};border:2px solid white;box-shadow:0 1px 4px rgba(0,0,0,.2)"></div>` : '';
    return _divider + `<div class="card ${firstKey?'b-'+firstKey:''}" style="animation-delay:${Math.min(i*.04,.6)}s;position:relative" onclick="openDetail('${p.id}')">
      ${coupleDot}
      <div class="card-img">${personImgHtml(p,'md')}</div>
      <div class="card-body">
        <div class="card-name">${p.pre} ${p.nom}</div>
        <div class="card-years">${fmtYears(p)}</div>
        <div class="branch-tags">${branchTagsHtml(branches)}</div>
      </div>
    </div>`;

  }).join('');
}

function setSort(mode, el) {
  sortMode = mode;
  document.querySelectorAll('.filter-bar .chip').forEach(c => { if(!c.classList.contains('b-Monsigny')&&!c.classList.contains('b-Pillon')&&!c.classList.contains('b-Bareau')&&!c.classList.contains('b-Baranowski')) c.classList.remove('active'); });
  el.classList.add('active');
  render();
}

function setBranche(b, el) {
  const bars = document.querySelectorAll('.filter-bar');
  const allChip = bars[1].querySelector('.chip');
  
  if (b === '') {
    // "Toutes" clicked ‚Üí clear all
    brancheFilters.clear();
    bars[1].querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
    allChip.classList.add('active');
  } else {
    // Toggle this branch
    if (brancheFilters.has(b)) {
      brancheFilters.delete(b);
      el.classList.remove('active');
    } else {
      brancheFilters.add(b);
      el.classList.add('active');
    }
    // Update "Toutes" chip
    if (brancheFilters.size === 0) allChip.classList.add('active');
    else allChip.classList.remove('active');
  }
  render();
}

// ============================================================
// DETAIL
// ============================================================
function openDetail(id) {
  const p = persons.find(x=>x.id===id); if(!p) return;

  document.getElementById('dPhoto').innerHTML = p.photo
    ? `<img src="${p.photo}" style="width:100%;height:100%;object-fit:cover">`
    : `<div style="display:flex;align-items:center;justify-content:center;width:100%;height:100%">${avatar(p,'lg')}</div>`;

  document.getElementById('dName').textContent = `${p.pre} ${p.nom}`;
  document.getElementById('dDates').textContent = fmtYears(p);

  const branches = getBranches(p);
  document.getElementById('dBadges').innerHTML = branchTagsHtml(branches);

  let info = '';
  if (p.lieuN) info += `<div class="ii"><div class="il">üìç Lieu de naissance</div><div class="iv"><a class="map-link" href="https://www.google.com/maps/search/${encodeURIComponent(p.lieuN)}" target="_blank">${p.lieuN} üó∫Ô∏è</a></div></div>`;
  if (p.lieuD) info += `<div class="ii"><div class="il">üìç Lieu de d√©c√®s</div><div class="iv"><a class="map-link" href="https://www.google.com/maps/search/${encodeURIComponent(p.lieuD)}" target="_blank">${p.lieuD} üó∫Ô∏è</a></div></div>`;
  document.getElementById('dInfo').innerHTML = info;

  let bio = '';
  if (p.bio) bio += `<div class="sec"><div class="sec-title">üìñ Biographie</div><div class="bio">${p.bio}</div></div>`;
  if (p.ane) bio += `<div class="sec"><div class="sec-title">‚ú® Anecdotes</div><div class="bio">${p.ane}</div></div>`;
  document.getElementById('dBio').innerHTML = bio;

  // Parents
  const pere = p.pereId ? persons.find(x=>x.id===p.pereId) : null;
  const mere = p.mereId ? persons.find(x=>x.id===p.mereId) : null;
  let parHtml = '';
  if (pere||mere) {
    parHtml = `<div class="sec"><div class="sec-title">üë®üë© Parents</div>`;
    if (pere) parHtml += plink(pere, 'üë® P√®re');
    if (mere) parHtml += plink(mere, 'üë© M√®re');
    parHtml += `</div>`;
  }
  document.getElementById('dParents').innerHTML = parHtml;

  // Children
  const children = persons.filter(x => x.pereId===p.id || x.mereId===p.id)
    .sort((a,b)=>(birthYear(a)||9999)-(birthYear(b)||9999));
  document.getElementById('dChildren').innerHTML = children.length
    ? `<div class="sec"><div class="sec-title">üë∂ Enfants (${children.length})</div>${children.map(c=>plink(c,fmtYears(c))).join('')}</div>`
    : '';

  // Siblings
  const sibs = persons.filter(x => x.id!==p.id && ((p.pereId&&x.pereId===p.pereId)||(p.mereId&&x.mereId===p.mereId)))
    .sort((a,b)=>(birthYear(a)||9999)-(birthYear(b)||9999));
  document.getElementById('dSiblings').innerHTML = sibs.length
    ? `<div class="sec"><div class="sec-title">üë´ Fr√®res & S≈ìurs (${sibs.length})</div>${sibs.map(s=>plink(s,fmtYears(s))).join('')}</div>`
    : '';

  // Partners: explicit + inferred from shared children
  const partnerSet = new Set(p.partnerIds||[]);
  children.forEach(c => {
    if (c.pereId && c.pereId!==p.id) partnerSet.add(c.pereId);
    if (c.mereId && c.mereId!==p.id) partnerSet.add(c.mereId);
  });
  // Also check if other people list p as their partner
  persons.forEach(x => { if((x.partnerIds||[]).includes(p.id)) partnerSet.add(x.id); });
  let partHtml = '';
  if (partnerSet.size) {
    partHtml = `<div class="sec"><div class="sec-title">üíë Partenaire(s)</div>`;
    partnerSet.forEach(pid => { const pp=persons.find(x=>x.id===pid); if(pp) partHtml+=plink(pp,fmtYears(pp)); });
    partHtml += `</div>`;
  }
  document.getElementById('dPartners').innerHTML = partHtml;

  document.getElementById('btnEdit').onclick = () => { closeOv('detailOv'); setTimeout(()=>openForm(p.id),200); };
  document.getElementById('btnDel').onclick = () => doDelete(p.id, `${p.pre} ${p.nom}`);
  openOv('detailOv');
}

function plink(p, sub) {
  return `<div class="plink" onclick="switchDetail('${p.id}')">
    <div class="pl-av">${personImgHtml(p,'sm')}</div>
    <div><div class="pl-name">${p.pre} ${p.nom}</div><div class="pl-sub">${sub}</div></div>
    <div class="pl-arr">‚Ä∫</div>
  </div>`;
}

function switchDetail(id) { closeOv('detailOv'); setTimeout(()=>openDetail(id),280); }

// ============================================================
// FORM
// ============================================================
function openForm(id) {
  if (!isUnlocked) { showToast('üîí PIN erforderlich ‚Äì bitte einloggen'); return; }
  editingId = id; photoData = null; formPereId = null; formMereId = null; formPartnerIds = [];
  formAv = {skin:'#FDBCB4', hair:'#4a2c11', style:'court'};

  if (id) {
    const p = persons.find(x=>x.id===id);
    document.getElementById('formTitle').textContent = 'Modifier';
    document.getElementById('fPre').value  = p.pre||'';
    document.getElementById('fNom').value  = p.nom||'';
    document.getElementById('fNais').value = p.nais||'';
    document.getElementById('fDec').value  = p.dec||'';
    document.getElementById('fLN').value   = p.lieuN||'';
    document.getElementById('fLD').value   = p.lieuD||'';
    document.getElementById('fBio').value  = p.bio||'';
    document.getElementById('fAne').value  = p.ane||'';
    photoData = p.photo||null;
    if (p.photo) { document.getElementById('phPrev').src=p.photo; document.getElementById('phPrev').style.display='block'; }
    else document.getElementById('phPrev').style.display='none';
    formPereId = p.pereId||null;
    formMereId = p.mereId||null;
    formPartnerIds = p.partnerIds ? [...p.partnerIds] : [];
    formAv = p.av ? {...p.av} : {skin:'#FDBCB4',hair:'#4a2c11',style:'court'};
    // Set branches
    const branches = getBranches(p);
    document.querySelectorAll('.bpill').forEach(el => {
      const b = el.dataset.b;
      el.className = 'bpill' + (branches.includes(b) ? ' active-'+b.split(' ')[0] : '');
    });
  } else {
    document.getElementById('formTitle').textContent = 'Ajouter une personne';
    ['fPre','fNom','fNais','fDec','fLN','fLD','fBio','fAne'].forEach(i=>document.getElementById(i).value='');
    document.getElementById('phPrev').style.display='none';
    document.querySelectorAll('.bpill').forEach(el => el.className='bpill');
    formPartnerIds = [];
  }
  updateParentBtns();
  updatePartnerList();
  initAvForm();
  openOv('formOv');
}


function setUnknown(fieldId) {
  const el = document.getElementById(fieldId);
  el.value = el.value === '?' ? '' : '?';
}

function handlePhoto(e) {
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=ev=>{
    const img=new Image();
    img.onload=()=>{
      const canvas=document.createElement('canvas');
      const MAX=300;
      let w=img.width, h=img.height;
      if(w>h){ if(w>MAX){h=Math.round(h*MAX/w);w=MAX;} }
      else { if(h>MAX){w=Math.round(w*MAX/h);h=MAX;} }
      canvas.width=w; canvas.height=h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      photoData=canvas.toDataURL('image/jpeg',0.7);
      document.getElementById('phPrev').src=photoData;
      document.getElementById('phPrev').style.display='block';
    };
    img.src=ev.target.result;
  };
  reader.readAsDataURL(file);
}

// Branch pills in form
function toggleBpill(el) {
  const b = el.dataset.b;
  const key = b.split(' ')[0];
  const isActive = el.classList.contains('active-'+key);
  el.className = isActive ? 'bpill' : 'bpill active-'+key;
}

function getFormBranches() {
  return [...document.querySelectorAll('.bpill')].filter(el => {
    const b = el.dataset.b; return el.classList.contains('active-'+b.split(' ')[0]);
  }).map(el=>el.dataset.b);
}

// Avatar form
function initAvForm() {
  // skin
  document.querySelectorAll('#skinOpts .copt').forEach(el => el.classList.toggle('active', el.dataset.val===formAv.skin));
  // hair
  document.querySelectorAll('#hairOpts .copt').forEach(el => el.classList.toggle('active', el.dataset.val===formAv.hair));
  // style
  document.querySelectorAll('#styleOpts .sopt').forEach(el => el.classList.toggle('active', el.dataset.val===formAv.style));
  updateAvPreview();
}

function setAv(el) {
  formAv[el.dataset.type] = el.dataset.val;
  if (el.dataset.type==='skin') document.querySelectorAll('#skinOpts .copt').forEach(e=>e.classList.toggle('active',e.dataset.val===formAv.skin));
  else document.querySelectorAll('#hairOpts .copt').forEach(e=>e.classList.toggle('active',e.dataset.val===formAv.hair));
  updateAvPreview();
}

function setAvStyle(el) {
  formAv.style = el.dataset.val;
  document.querySelectorAll('#styleOpts .sopt').forEach(e=>e.classList.toggle('active',e.dataset.val===formAv.style));
  updateAvPreview();
}

function updateAvPreview() {
  const pv = document.getElementById('avPreview');
  if (pv) pv.innerHTML = avatar({av:formAv}, 'md');
}

// Parents
function openPicker(target) {
  pickerTarget = target;
  document.getElementById('pickerTitle').textContent = target==='pere' ? 'Choisir le p√®re' : 'Choisir la m√®re';
  document.getElementById('pickerQ').value = '';
  renderPicker();
  openOv('pickerOv');
}

function renderPicker() {
  const q = (document.getElementById('pickerQ').value||'').toLowerCase();
  const list = persons.filter(p => p.id!==editingId && (!q||(p.pre+' '+p.nom).toLowerCase().includes(q)))
    .sort((a,b)=>a.pre.localeCompare(b.pre,'fr'));
  document.getElementById('pickerList').innerHTML = list.map(p=>`
    <div class="picker-item" onclick="selectParent('${p.id}')">
      <div class="picker-av">${personImgHtml(p,'sm')}</div>
      <div><div style="font-family:'Playfair Display',serif;font-size:14px;font-weight:600">${p.pre} ${p.nom}</div>
      <div style="font-size:11px;color:var(--muted)">${fmtYears(p)}</div></div>
    </div>`).join('') || '<div style="padding:20px;color:var(--muted);text-align:center">Aucun r√©sultat</div>';
}

function selectParent(id) {
  if (pickerTarget==='partner') {
    if (!formPartnerIds.includes(id)) formPartnerIds.push(id);
    closeOv('pickerOv'); updatePartnerList(); return;
  }
  if (pickerTarget==='pere') formPereId=id; else formMereId=id;
  closeOv('pickerOv'); updateParentBtns();
}

function updatePartnerList() {
  const el = document.getElementById('partnerList');
  if (!el) return;
  el.innerHTML = formPartnerIds.map(pid => {
    const p = persons.find(x=>x.id===pid);
    if (!p) return '';
    return `<div style="display:flex;align-items:center;gap:8px;background:var(--white);border:2px solid var(--amber-light);border-radius:12px;padding:8px 12px">
      <div style="width:32px;height:32px;border-radius:50%;overflow:hidden;background:var(--parchment);display:flex;align-items:center;justify-content:center;flex-shrink:0">${personImgHtml(p,'sm')}</div>
      <div style="flex:1;font-family:'Playfair Display',serif;font-size:14px">üíë ${p.pre} ${p.nom}</div>
      <button type="button" onclick="removePartner('${pid}')" style="background:none;border:none;color:#c0392b;font-size:18px;cursor:pointer">‚úï</button>
    </div>`;
  }).join('');
}

function removePartner(pid) {
  formPartnerIds = formPartnerIds.filter(id=>id!==pid);
  updatePartnerList();
}

function clearParent(which) {
  if (which==='pere') formPereId=null; else formMereId=null;
  updateParentBtns();
}

function updateParentBtns() {
  const pe = formPereId ? persons.find(x=>x.id===formPereId) : null;
  const me = formMereId ? persons.find(x=>x.id===formMereId) : null;
  const bp = document.getElementById('btnPere'), cp = document.getElementById('clrPere');
  const bm = document.getElementById('btnMere'), cm = document.getElementById('clrMere');
  bp.textContent = pe ? `üë® ${pe.pre} ${pe.nom}` : '‚Äî Choisir le p√®re ‚Äî';
  bp.className = 'btn-pick' + (pe?' chosen':'');
  bm.textContent = me ? `üë© ${me.pre} ${me.nom}` : '‚Äî Choisir la m√®re ‚Äî';
  bm.className = 'btn-pick' + (me?' chosen':'');
  cp.style.display = pe?'block':'none';
  cm.style.display = me?'block':'none';
}

function savePerson() {
  const pre = document.getElementById('fPre').value.trim();
  if (!pre) { showToast('‚ö†Ô∏è Veuillez saisir le pr√©nom'); return; }
  const data = {
    pre, nom: document.getElementById('fNom').value.trim(),
    nais: document.getElementById('fNais').value.trim(),
    dec:  document.getElementById('fDec').value.trim(),
    lieuN: document.getElementById('fLN').value.trim(),
    lieuD: document.getElementById('fLD').value.trim(),
    bio:  document.getElementById('fBio').value.trim(),
    ane:  document.getElementById('fAne').value.trim(),
    photo: photoData||'',
    branches: getFormBranches(),
    av: {...formAv},
    partnerIds: [...formPartnerIds],
    pereId: formPereId,
    mereId: formMereId,
  };
  if (editingId) {
    const idx = persons.findIndex(p=>p.id===editingId);
    persons[idx] = {...persons[idx], ...data};
    showToast('‚úÖ Enregistr√© !');
  } else {
    data.id = 'p'+Date.now();
    persons.push(data);
    showToast('üéâ Personne ajout√©e !');
  }
  _genCache = null; saveData(); closeOv('formOv'); render();
}

// ============================================================
// BULK ASSIGN
// ============================================================
function openBulk() {
  if (!isUnlocked) { showToast('üîí PIN erforderlich ‚Äì bitte einloggen'); return; }
  bulkChanges = {};
  bulkFilter = '';
  document.getElementById('bulkQ').value = '';
  // reset chips
  const chips = document.querySelectorAll('#bulkOv .chip');
  chips.forEach(c=>c.classList.remove('active'));
  chips[0].classList.add('active');
  renderBulk();
  openOv('bulkOv');
}

function setBulkF(f, el) {
  bulkFilter = f;
  document.querySelectorAll('#bulkOv .chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  renderBulk();
}

function renderBulk() {
  const q = (document.getElementById('bulkQ').value||'').toLowerCase();
  let list = [...persons];
  if (q) list = list.filter(p=>(p.pre+' '+p.nom).toLowerCase().includes(q));

  const getB = (p) => bulkChanges[p.id] !== undefined ? bulkChanges[p.id] : getBranches(p);

  if (bulkFilter==='none') list = list.filter(p=>getB(p).length===0);
  else if (bulkFilter) list = list.filter(p=>getB(p).includes(bulkFilter));

  list.sort((a,b)=>a.pre.localeCompare(b.pre,'fr'));

  const noB = persons.filter(p=>getBranches(p).length===0).length;
  document.getElementById('bulkStats').textContent = `${persons.length} personnes ¬∑ ${noB} sans branche`;

  document.getElementById('bulkList').innerHTML = list.map(p => {
    const curBranches = getB(p);
    return `<div class="bulk-row">
      <div class="bulk-av">${personImgHtml(p,'sm')}</div>
      <div class="bulk-info">
        <div class="bulk-name">${p.pre} ${p.nom}</div>
        <div class="bulk-years">${fmtYears(p)}</div>
      </div>
      <div class="bulk-pills">
        ${BRANCHES.map(b => {
          const key = b.split(' ')[0];
          const isActive = curBranches.includes(b);
          const label = b==='Baranowski de Rawiez'?'Baran.':b;
          return `<span class="bpill-sm ${isActive?'active-'+key:''}" onclick="toggleBulk('${p.id}','${b}',this)">${label}</span>`;
        }).join('')}
      </div>
    </div>`;
  }).join('') || '<div style="padding:24px;text-align:center;color:var(--muted);font-style:italic">Aucune personne trouv√©e</div>';
}

function toggleBulk(pid, branch, el) {
  const p = persons.find(x=>x.id===pid);
  let cur = bulkChanges[pid] !== undefined ? [...bulkChanges[pid]] : [...getBranches(p)];
  if (cur.includes(branch)) cur = cur.filter(b=>b!==branch);
  else cur.push(branch);
  bulkChanges[pid] = cur;
  const key = branch.split(' ')[0];
  el.className = 'bpill-sm' + (cur.includes(branch) ? ' active-'+key : '');
}

function saveBulk() {
  const count = Object.keys(bulkChanges).length;
  if (!count) { showToast('‚ÑπÔ∏è Aucune modification'); return; }
  persons = persons.map(p => bulkChanges[p.id]!==undefined ? {...p, branches:bulkChanges[p.id]} : p);
  _genCache=null; saveData(); render();
  bulkChanges = {}; renderBulk();
  showToast(`‚úÖ ${count} personne${count>1?'s':''} mise${count>1?'s':''} √† jour !`);
}

// ============================================================
// DELETE
// ============================================================
function doDelete(id, name) {
  if (!isUnlocked) { showToast('üîí PIN erforderlich'); return; }
  document.getElementById('confirmTxt').textContent = `"${name}" sera d√©finitivement supprim√©(e).`;
  document.getElementById('btnYes').onclick = () => {
    persons = persons.filter(p=>p.id!==id).map(p=>({...p, pereId:p.pereId===id?null:p.pereId, mereId:p.mereId===id?null:p.mereId}));
    _genCache=null; saveData(); closeOv('confirmOv'); closeOv('detailOv'); render(); showToast('üóëÔ∏è Supprim√©');
  };
  closeOv('detailOv'); setTimeout(()=>openOv('confirmOv'),200);
}

// ============================================================
// PIN
// ============================================================
function pp(digit) {
  if (pinInput.length>=4) return;
  pinInput += digit;
  for(let i=0;i<4;i++) document.getElementById('d'+i).classList.toggle('filled',i<pinInput.length);
  if (pinInput.length===4) setTimeout(checkPin,200);
}
function pdel() {
  pinInput = pinInput.slice(0,-1);
  for(let i=0;i<4;i++) document.getElementById('d'+i).classList.toggle('filled',i<pinInput.length);
  document.getElementById('pinErr').textContent='';
}
function checkPin() {
  if (pinInput===PIN) {
    isUnlocked=true;
    document.getElementById('pinScreen').classList.add('hidden');
    document.getElementById('lockBtn').style.display='block';
    showToast('üîì Mode √©dition activ√©');
  } else {
    document.getElementById('pinErr').textContent='‚ùå Code incorrect, r√©essayez';
    pinInput='';
    for(let i=0;i<4;i++) document.getElementById('d'+i).classList.remove('filled');
  }
}
function pinSkip() {
  isUnlocked=false;
  document.getElementById('pinScreen').classList.add('hidden');
}
function doLock() {
  isUnlocked=false; pinInput='';
  for(let i=0;i<4;i++) document.getElementById('d'+i).classList.remove('filled');
  document.getElementById('pinErr').textContent='';
  document.getElementById('pinScreen').classList.remove('hidden');
  document.getElementById('lockBtn').style.display='none';
  closeOv('detailOv'); closeOv('formOv');
}



// ============================================================
// GEDCOM IMPORT
// ============================================================
let gedAllPersons = [];
let gedSelected = new Set();

function openGedcom() {
  if (!isUnlocked) { showToast('üîí PIN erforderlich ‚Äì bitte einloggen'); return; }
  gedReset();
  openOv('gedcomOv');
}

function gedReset() {
  gedAllPersons = []; gedSelected = new Set();
  document.getElementById('gedStep1').style.display = 'block';
  document.getElementById('gedStep2').style.display = 'none';
  document.getElementById('gedFile').value = '';
}

function parseGedcom(e) {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      gedAllPersons = parseGedcomText(ev.target.result);
      // Populate root select
      const sel = document.getElementById('gedRootSelect');
      sel.innerHTML = '<option value="">‚Äî Choisir une personne de r√©f√©rence ‚Äî</option>';
      [...gedAllPersons].sort((a,b)=>a.pre.localeCompare(b.pre,'fr')).forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id; opt.textContent = `${p.pre} ${p.nom}${p.nais?' ('+p.nais+')':''}`;
        sel.appendChild(opt);
      });
      document.getElementById('gedSummary').innerHTML = `
        <div style="font-size:36px;margin-bottom:6px">üéâ</div>
        <div style="font-family:'Playfair Display',serif;font-size:18px;color:var(--brown)">${gedAllPersons.length} personnes trouv√©es dans le fichier</div>
      `;
      document.getElementById('gedStep1').style.display = 'none';
      document.getElementById('gedStep2').style.display = 'block';
      updateGedPreview();
    } catch(err) { showToast('‚ùå Erreur: ' + err.message); }
  };
  reader.readAsText(file, 'UTF-8');
}

function filterGedRoot() {
  const q = document.getElementById('gedRootSearch').value.toLowerCase();
  const sel = document.getElementById('gedRootSelect');
  [...sel.options].forEach(opt => {
    opt.style.display = (!q || opt.textContent.toLowerCase().includes(q)) ? '' : 'none';
  });
}

function getGedAncestors(id, result) {
  if (!id || result.has(id)) return;
  result.add(id);
  const p = gedAllPersons.find(x=>x.id===id);
  if (!p) return;
  if (p.pereId) getGedAncestors(p.pereId, result);
  if (p.mereId) getGedAncestors(p.mereId, result);
  // Include partners of ancestors
  (p.partnerIds||[]).forEach(pid => result.add(pid));
}

function getGedDescendants(id, result) {
  if (!id || result.has(id)) return;
  result.add(id);
  const children = gedAllPersons.filter(x=>x.pereId===id||x.mereId===id);
  children.forEach(c => getGedDescendants(c.id, result));
  // Include partners
  const p = gedAllPersons.find(x=>x.id===id);
  if (p) (p.partnerIds||[]).forEach(pid => result.add(pid));
}

function updateGedPreview() {
  const mode = document.querySelector('input[name="gedMode"]:checked').value;
  const rootId = document.getElementById('gedRootSelect').value;
  let filtered = new Set();

  if (mode === 'all') {
    gedAllPersons.forEach(p => filtered.add(p.id));
  } else if (mode === 'ancestors') {
    if (rootId) getGedAncestors(rootId, filtered);
    filtered.add(rootId);
  } else if (mode === 'descendants') {
    if (rootId) getGedDescendants(rootId, filtered);
  } else if (mode === 'both') {
    if (rootId) { getGedAncestors(rootId, filtered); getGedDescendants(rootId, filtered); }
    filtered.add(rootId);
  } else if (mode === 'manual') {
    // Keep current manual selection
    filtered = new Set(gedSelected);
  }

  if (mode !== 'manual') gedSelected = new Set(filtered);

  const list = gedAllPersons.filter(p => gedSelected.has(p.id));
  document.getElementById('gedSelCount').textContent = list.length;

  document.getElementById('gedPreview').innerHTML = gedAllPersons.map(p => {
    const checked = gedSelected.has(p.id);
    const isManual = mode === 'manual';
    return `<div style="display:flex;align-items:center;gap:10px;padding:7px 6px;border-bottom:1px solid var(--parchment);${checked?'':'opacity:.45'}">
      ${isManual ? `<input type="checkbox" ${checked?'checked':''} onchange="toggleGedPerson('${p.id}',this)" style="width:18px;height:18px;accent-color:var(--amber);flex-shrink:0">` : `<div style="font-size:16px">${checked?'‚úÖ':'‚óã'}</div>`}
      <div style="width:30px;height:30px;border-radius:50%;overflow:hidden;background:var(--parchment);display:flex;align-items:center;justify-content:center;flex-shrink:0">${avatar(p,'sm')}</div>
      <div style="flex:1;min-width:0">
        <div style="font-family:'Playfair Display',serif;font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.pre} ${p.nom}</div>
        <div style="font-size:11px;color:var(--muted)">${fmtYears(p)}</div>
      </div>
    </div>`;
  }).join('');
}

function toggleGedPerson(id, cb) {
  if (cb.checked) gedSelected.add(id);
  else gedSelected.delete(id);
  document.getElementById('gedSelCount').textContent = gedSelected.size;
  updateGedPreview();
}

function gedImport() {
  const toImport = gedAllPersons.filter(p => gedSelected.has(p.id));
  if (!toImport.length) { showToast('‚ö†Ô∏è Aucune personne s√©lectionn√©e'); return; }
  let added = 0, skipped = 0;
  toImport.forEach(np => {
    const exists = persons.find(e => e.pre===np.pre && e.nom===np.nom && e.nais===np.nais);
    if (!exists) { persons.push(np); added++; } else skipped++;
  });
  _genCache = null; saveData(); render();
  closeOv('gedcomOv');
  showToast(`üéâ ${added} import√©es !${skipped?' ('+skipped+' doublons ignor√©s)':''}`, 4000);
}

function parseGedcomText(text) {
  const lines = text.split(/\r?\n/);
  const indiMap = {}, famMap = {};
  let cur = null, curType = null, curTag = null;
  for (let line of lines) {
    line = line.trim(); if (!line) continue;
    const m = line.match(/^(\d+)\s+(\S+)(?:\s+(.*))?$/);
    if (!m) continue;
    const level = parseInt(m[1]), tagStr = m[2], valStr = m[3]||'';
    if (level===0) {
      curTag=null;
      if (tagStr.startsWith('@')&&valStr==='INDI') { curType='INDI'; cur={id:tagStr.replace(/@/g,''),events:{}}; indiMap[cur.id]=cur; }
      else if (tagStr.startsWith('@')&&valStr==='FAM') { curType='FAM'; cur={id:tagStr.replace(/@/g,''),children:[]}; famMap[cur.id]=cur; }
      else { cur=null; curType=null; }
      continue;
    }
    if (!cur) continue;
    if (curType==='INDI') {
      if (level===1&&tagStr==='NAME') {
        const sn=valStr.match(/\/([^/]*)\//)
        cur.nom=sn?sn[1].trim():valStr.split(' ').pop();
        cur.pre=sn?valStr.replace(/\/[^/]*\//,'').replace(/\//g,'').trim():valStr.split(' ').slice(0,-1).join(' ');
        if(!cur.pre)cur.pre=valStr.replace(/\//g,'').trim();
      }
      if (level===1&&tagStr==='SEX') cur.sex=valStr;
      if (level===1&&(tagStr==='BIRT'||tagStr==='DEAT')) { curTag=tagStr; if(!cur.events[curTag])cur.events[curTag]={}; }
      if (level===2&&curTag) { if(tagStr==='DATE')cur.events[curTag].date=valStr; if(tagStr==='PLAC')cur.events[curTag].plac=valStr; }
      if (level===1&&tagStr!=='BIRT'&&tagStr!=='DEAT') curTag=null;
      if (level===1&&tagStr==='FAMS') cur.fams=(cur.fams||[]).concat(valStr.replace(/@/g,''));
      if (level===1&&tagStr==='FAMC') cur.famc=(cur.famc||[]).concat(valStr.replace(/@/g,''));
    }
    if (curType==='FAM') {
      if (level===1&&tagStr==='HUSB') cur.husb=valStr.replace(/@/g,'');
      if (level===1&&tagStr==='WIFE') cur.wife=valStr.replace(/@/g,'');
      if (level===1&&tagStr==='CHIL') cur.children.push(valStr.replace(/@/g,''));
    }
  }
  const idMap={};
  const result=Object.values(indiMap).map(p=>{
    const nid='ged_'+p.id.replace(/[^a-zA-Z0-9]/g,'_');
    idMap[p.id]=nid;
    const b=p.events['BIRT']||{}, d=p.events['DEAT']||{};
    return {id:nid,pre:p.pre||'?',nom:p.nom||'',nais:fmtGedDate(b.date||''),dec:fmtGedDate(d.date||''),lieuN:b.plac||'',lieuD:d.plac||'',bio:'',ane:'',photo:'',branches:[],partnerIds:[],pereId:null,mereId:null,av:{skin:'#FDBCB4',hair:'#4a2c11',style:p.sex==='F'?'long':'court'},_ged:p.id,_fams:p.fams||[]};
  });
  Object.values(famMap).forEach(fam=>{
    const hn=fam.husb?idMap[fam.husb]:null, wn=fam.wife?idMap[fam.wife]:null;
    if(hn&&wn){const h=result.find(x=>x.id===hn),w=result.find(x=>x.id===wn);if(h&&!h.partnerIds.includes(wn))h.partnerIds.push(wn);if(w&&!w.partnerIds.includes(hn))w.partnerIds.push(hn);}
    fam.children.forEach(cg=>{const cn=idMap[cg],c=result.find(x=>x.id===cn);if(c){if(hn&&!c.pereId)c.pereId=hn;if(wn&&!c.mereId)c.mereId=wn;}});
  });
  result.forEach(p=>{delete p._ged;delete p._fams;});
  return result;
}

function fmtGedDate(d) {
  if(!d)return'';
  const mo={JAN:'01',FEB:'02',MAR:'03',APR:'04',MAY:'05',JUN:'06',JUL:'07',AUG:'08',SEP:'09',OCT:'10',NOV:'11',DEC:'12'};
  const m=d.match(/(\d{1,2})\s+([A-Z]{3})\s+(\d{4})/);
  if(m)return m[1].padStart(2,'0')+'.'+( mo[m[2]]||'??')+'.'+m[3];
  const y=d.match(/(\d{4})/);return y?y[1]:d;
}


// ============================================================
// OVERLAY UTILS
// ============================================================
function openOv(id)  { document.getElementById(id).classList.add('open');    document.body.style.overflow='hidden'; }
function closeOv(id) { document.getElementById(id).classList.remove('open'); document.body.style.overflow=''; }
function showToast(msg, dur) {
  const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),dur||2500);
}

loadData();
</script>
</body>
</html>
