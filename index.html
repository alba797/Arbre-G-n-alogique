<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Arbre GÃ©nÃ©alogique</title>
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="theme-color" content="#4a2c11">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Lora:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --cream:#fdf6ed; --parchment:#f0e0c0; --amber:#c07a2f;
  --amber-dark:#8b5320; --amber-light:#e8a455; --brown:#4a2c11;
  --text:#2d1a0a; --muted:#7a5c3d; --white:#fff;
  --green:#5a9478; --blue:#4a6ab5; --purple:#9b5fa5; --orange:#c07a2f;
  --shadow:0 4px 24px rgba(74,44,17,.18);
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{font-family:'Lora',Georgia,serif;background:var(--cream);color:var(--text);font-size:16px}

/* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#hdr{
  position:fixed;top:0;left:0;right:0;z-index:100;
  background:linear-gradient(135deg,var(--brown) 0%,var(--amber-dark) 100%);
  padding:14px 18px 12px;
  display:flex;align-items:center;justify-content:space-between;
  box-shadow:0 3px 16px rgba(0,0,0,.3);
}
.hdr-left{display:flex;flex-direction:column}
.hdr-title{font-family:'Playfair Display',serif;color:var(--cream);font-size:21px;font-weight:700;letter-spacing:.3px}
.hdr-sub{font-size:11px;color:var(--amber-light);font-style:italic;margin-top:1px}
.hdr-right{display:flex;gap:10px;align-items:center}
#syncLbl{font-size:11px;color:var(--amber-light);font-style:italic;opacity:0;transition:opacity .4s}
.hdr-btn{
  background:rgba(255,255,255,.18);color:var(--cream);
  border:1.5px solid rgba(255,255,255,.3);border-radius:50%;
  width:40px;height:40px;font-size:17px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:background .2s;
}
.hdr-btn:active,.hdr-btn.active{background:var(--amber-light);color:var(--brown)}

/* â”€â”€ TREE CONTAINER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#treeWrap{
  position:fixed;top:72px;bottom:0;left:0;right:0;
  overflow:auto;-webkit-overflow-scrolling:touch;
  background:var(--cream);
}
#treeInner{position:relative;} /* sized dynamically */

/* â”€â”€ PERSON NODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pnode{
  position:absolute;
  width:110px;
  background:var(--white);
  border-radius:14px;
  box-shadow:0 3px 14px rgba(74,44,17,.14);
  cursor:pointer;
  border:2.5px solid transparent;
  transition:transform .15s,box-shadow .15s,border-color .15s;
  overflow:hidden;
  user-select:none;
}
.pnode:active{transform:scale(.96)}
.pnode.selected{border-color:var(--amber)!important;box-shadow:0 0 0 3px rgba(192,122,47,.3),0 4px 20px rgba(192,122,47,.3)!important}
.pnode.ancestor{border-color:var(--amber)!important}
.pnode.root-node{border-color:var(--amber-dark)!important;border-width:3px!important;box-shadow:0 0 0 4px rgba(192,122,47,.25),0 4px 24px rgba(192,122,47,.35)!important}
.pnode-img{width:100%;aspect-ratio:1;background:var(--parchment);display:flex;align-items:center;justify-content:center;overflow:hidden}
.pnode-img img{width:100%;height:100%;object-fit:cover}
.pnode-body{padding:7px 8px 8px;background:var(--white)}
.pnode-name{font-family:'Playfair Display',serif;font-size:11.5px;font-weight:600;line-height:1.3;color:var(--brown);word-break:break-word}
.pnode-years{font-size:9.5px;color:var(--muted);font-style:italic;margin-top:2px}
.pnode-root-badge{
  position:absolute;top:4px;right:4px;
  background:var(--amber);color:white;
  font-size:8px;font-weight:700;letter-spacing:.3px;
  padding:2px 5px;border-radius:50px;
  font-family:'Lora',serif;
}
.ancestor-banner{
  background:linear-gradient(135deg,var(--amber),var(--amber-dark));
  color:white;font-size:8px;font-weight:700;text-align:center;
  padding:2px 0;font-family:'Lora',serif;letter-spacing:.4px;
}
/* couple connector */
.couple-bar{
  position:absolute;
  height:3px;background:var(--parchment);
  border-radius:2px;
  display:flex;align-items:center;justify-content:center;
}
.couple-heart{font-size:12px;background:var(--white);padding:0 3px;border-radius:50%}

/* Branch colors */
.bn-Monsigny  .pnode-body{background:#f0f8f4}
.bn-Pillon    .pnode-body{background:#fdf4ec}
.bn-Bareau    .pnode-body{background:#eff3fb}
.bn-Baranowski.pnode-body{background:#f8f0fb}
.bn-Monsigny  {border-color:#5a9478}
.bn-Pillon    {border-color:#c07a2f}
.bn-Bareau    {border-color:#4a6ab5}
.bn-Baranowski{border-color:#9b5fa5}

/* â”€â”€ SVG TREE LINES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#treeSvg{position:absolute;top:0;left:0;pointer-events:none;z-index:0}
.tree-path{fill:none;stroke:#c4a882;stroke-width:2;opacity:.7}
.tree-path-direct{stroke:var(--amber);stroke-width:2.5;opacity:.85}
.couple-line{fill:none;stroke:var(--parchment);stroke-width:3;stroke-dasharray:none}

/* â”€â”€ DETAIL PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#detailPanel{
  position:fixed;bottom:0;left:0;right:0;z-index:150;
  background:var(--cream);
  border-radius:24px 24px 0 0;
  box-shadow:0 -6px 40px rgba(74,44,17,.25);
  transform:translateY(100%);
  transition:transform .38s cubic-bezier(.32,.72,0,1);
  max-height:92vh;
  display:flex;flex-direction:column;
}
#detailPanel.open{transform:translateY(0)}
.dp-handle{width:44px;height:5px;background:var(--parchment);border-radius:3px;margin:12px auto 0;flex-shrink:0}
.dp-scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding-bottom:30px}

/* Detail profile */
.dp-header{
  background:linear-gradient(135deg,var(--brown),var(--amber-dark));
  padding:16px 20px 18px;
  display:flex;gap:16px;align-items:flex-start;
}
.dp-photo{width:90px;height:90px;border-radius:14px;overflow:hidden;background:rgba(255,255,255,.15);flex-shrink:0;display:flex;align-items:center;justify-content:center}
.dp-photo img{width:100%;height:100%;object-fit:cover}
.dp-info{flex:1;min-width:0}
.dp-name{font-family:'Playfair Display',serif;font-size:22px;font-weight:700;color:var(--cream);line-height:1.2;margin-bottom:4px}
.dp-dates{font-size:13px;color:var(--amber-light);font-style:italic;line-height:1.5}
.dp-place{color:var(--amber-light);text-decoration:underline;text-underline-offset:2px}
.dp-place:hover{opacity:.9}
.dp-branches{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px}
.dp-btag{font-size:10px;padding:2px 8px;border-radius:50px;font-weight:600}
.dp-close{background:rgba(255,255,255,.2);border:none;border-radius:50%;width:34px;height:34px;color:white;font-size:17px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center}

/* Detail body */
.dp-body{padding:16px 20px}
.dp-section{margin-bottom:16px}
.dp-sec-title{font-family:'Playfair Display',serif;font-size:15px;font-weight:600;color:var(--amber-dark);margin-bottom:8px;padding-bottom:4px;border-bottom:1.5px solid var(--parchment)}
.dp-rel-list{display:flex;flex-wrap:wrap;gap:8px}
.dp-rel-chip{
  display:flex;align-items:center;gap:7px;
  background:var(--white);border:1.5px solid var(--parchment);
  border-radius:50px;padding:5px 12px 5px 7px;
  cursor:pointer;transition:border-color .2s;
  font-size:13px;
}
.dp-rel-chip:active{border-color:var(--amber)}
.dp-rel-av{width:28px;height:28px;border-radius:50%;overflow:hidden;background:var(--parchment);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.dp-bio{font-size:14px;line-height:1.7;color:var(--text)}
.dp-doc-item{display:flex;align-items:center;gap:10px;background:var(--white);border:1.5px solid var(--parchment);border-radius:12px;padding:10px 13px;margin-bottom:8px}

/* Mini tree in detail */
#miniTreeWrap{padding:0 16px 16px;overflow-x:auto;-webkit-overflow-scrolling:touch}
#miniTreeSvg{display:block;margin:0 auto}

/* Detail edit button */
.dp-edit-btn{
  display:block;width:calc(100% - 40px);margin:0 20px 10px;
  background:linear-gradient(135deg,var(--amber),var(--amber-dark));
  color:white;border:none;border-radius:14px;padding:14px;
  font-size:16px;font-family:'Lora',serif;font-weight:600;cursor:pointer;
  text-align:center;
}
.dp-edit-btn:active{opacity:.85}

/* â”€â”€ PIN OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#pinOv{
  position:fixed;inset:0;z-index:300;
  background:rgba(45,26,10,.8);
  display:flex;align-items:center;justify-content:center;
  opacity:0;pointer-events:none;transition:opacity .25s;
}
#pinOv.open{opacity:1;pointer-events:all}
.pin-box{
  background:var(--cream);border-radius:24px;padding:32px 28px;
  width:min(90vw,340px);text-align:center;
  box-shadow:0 8px 40px rgba(0,0,0,.4);
}
.pin-title{font-family:'Playfair Display',serif;font-size:22px;color:var(--brown);margin-bottom:6px}
.pin-sub{font-size:13px;color:var(--muted);margin-bottom:24px;font-style:italic}
.pin-dots{display:flex;gap:12px;justify-content:center;margin-bottom:24px}
.pin-dot{width:16px;height:16px;border-radius:50%;border:2.5px solid var(--amber-light);background:transparent;transition:background .15s}
.pin-dot.filled{background:var(--amber)}
.pin-pad{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;max-width:240px;margin:0 auto}
.pin-key{
  background:var(--white);border:2px solid var(--parchment);
  border-radius:14px;padding:16px;font-size:22px;font-family:'Lora',serif;
  cursor:pointer;text-align:center;font-weight:600;color:var(--brown);
  transition:background .15s;
}
.pin-key:active{background:var(--amber-light)}
.pin-err{color:#c0392b;font-size:13px;margin-top:12px;font-style:italic;min-height:20px}

/* â”€â”€ ADMIN PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#adminPanel{
  position:fixed;bottom:24px;right:20px;z-index:120;
  display:flex;flex-direction:column;align-items:flex-end;gap:10px;
}
.admin-fab{
  background:linear-gradient(135deg,var(--amber),var(--amber-dark));
  color:white;border:none;border-radius:50px;
  padding:13px 20px;font-size:15px;font-family:'Lora',serif;font-weight:600;
  cursor:pointer;box-shadow:0 5px 20px rgba(192,122,47,.4);
  white-space:nowrap;
}
.admin-fab:active{opacity:.85}
.admin-menu{
  display:flex;flex-direction:column;gap:8px;
  background:var(--cream);border-radius:16px;
  padding:12px;box-shadow:var(--shadow);
  border:1.5px solid var(--parchment);
}
.admin-menu-btn{
  background:var(--white);border:1.5px solid var(--parchment);
  border-radius:12px;padding:11px 16px;font-size:14px;
  font-family:'Lora',serif;cursor:pointer;text-align:left;
  color:var(--text);white-space:nowrap;
}
.admin-menu-btn:active{background:var(--parchment)}
.admin-menu-btn.danger{color:#c0392b;border-color:#f0a0a0}

/* â”€â”€ OVERLAY / SHEET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.overlay{
  position:fixed;inset:0;background:rgba(45,26,10,.65);
  z-index:250;display:flex;align-items:flex-end;justify-content:center;
  opacity:0;pointer-events:none;transition:opacity .3s;
}
.overlay.open{opacity:1;pointer-events:all}
.sheet{
  background:var(--cream);border-radius:24px 24px 0 0;
  width:100%;max-width:640px;max-height:92vh;
  overflow-y:auto;transform:translateY(100%);
  transition:transform .35s cubic-bezier(.32,.72,0,1);
  padding-bottom:40px;
}
.overlay.open .sheet{transform:translateY(0)}
.sheet-hdr{
  background:linear-gradient(135deg,var(--brown),var(--amber-dark));
  padding:18px 22px;border-radius:24px 24px 0 0;
  display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;z-index:5;
}
.sheet-title{font-family:'Playfair Display',serif;color:var(--cream);font-size:20px;font-weight:700}
.btn-x{background:rgba(255,255,255,.2);border:none;border-radius:50%;width:36px;height:36px;color:white;font-size:17px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.sheet-body{padding:18px 22px}

/* FORM */
.fg{margin-bottom:16px}
.fl{display:block;font-size:13px;font-weight:600;color:var(--amber-dark);margin-bottom:5px;text-transform:uppercase;letter-spacing:.4px}
.fi{width:100%;background:var(--white);border:2px solid var(--parchment);border-radius:13px;padding:12px 14px;font-size:15px;font-family:'Lora',serif;color:var(--text);outline:none;transition:border-color .2s}
.fi:focus{border-color:var(--amber)}
.fsel{width:100%;background:var(--white);border:2px solid var(--parchment);border-radius:13px;padding:12px 14px;font-size:15px;font-family:'Lora',serif;color:var(--text);outline:none}
.frow{display:flex;gap:10px}
.frow .fi{flex:1}
.fta{width:100%;background:var(--white);border:2px solid var(--parchment);border-radius:13px;padding:12px 14px;font-size:15px;font-family:'Lora',serif;color:var(--text);resize:vertical;min-height:80px;outline:none}
.fta:focus{border-color:var(--amber)}
.btn-save{display:block;width:100%;background:linear-gradient(135deg,var(--amber),var(--amber-dark));color:white;border:none;border-radius:14px;padding:15px;font-size:16px;font-family:'Lora',serif;font-weight:600;cursor:pointer;margin-top:8px}
.btn-save:active{opacity:.85}
.btn-pick{width:100%;background:var(--parchment);border:2px dashed var(--amber-light);border-radius:12px;padding:10px;font-size:14px;font-family:'Lora',serif;color:var(--amber-dark);cursor:pointer}
.unk-btn{background:var(--parchment);border:1.5px solid var(--amber-light);border-radius:8px;padding:7px 10px;font-size:12px;font-family:'Lora',serif;color:var(--muted);cursor:pointer;flex-shrink:0}
.parent-btn{display:flex;align-items:center;gap:8px;background:var(--white);border:2px solid var(--parchment);border-radius:12px;padding:9px 12px;cursor:pointer;margin-bottom:6px}
.parent-av{width:32px;height:32px;border-radius:50%;overflow:hidden;background:var(--parchment);display:flex;align-items:center;justify-content:center;flex-shrink:0}

/* Picker */
.picker-item{display:flex;align-items:center;gap:12px;padding:11px 16px;border-bottom:1px solid var(--parchment);cursor:pointer}
.picker-item:active{background:var(--parchment)}
.picker-av{width:40px;height:40px;border-radius:50%;overflow:hidden;background:var(--parchment);display:flex;align-items:center;justify-content:center;flex-shrink:0}

/* Photo upload */
.photo-up{border:2.5px dashed var(--amber-light);border-radius:14px;padding:20px;text-align:center;cursor:pointer;background:var(--white)}
.ph-prev{width:90px;height:90px;border-radius:50%;object-fit:cover;display:none;margin:0 auto 12px}

/* Confirm */
.confirm-box{background:var(--cream);border-radius:20px;padding:28px;width:min(90vw,340px);text-align:center;box-shadow:0 8px 40px rgba(0,0,0,.4)}
.confirm-btns{display:flex;gap:10px;margin-top:20px}
.btn-no{flex:1;background:var(--parchment);border:none;border-radius:12px;padding:13px;font-size:15px;font-family:'Lora',serif;cursor:pointer}
.btn-yes{flex:1;background:#c0392b;color:white;border:none;border-radius:12px;padding:13px;font-size:15px;font-family:'Lora',serif;cursor:pointer}

/* Avatar */
.av-grid{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:8px 0}
.av-opt{width:50px;height:50px;border-radius:50%;border:2.5px solid var(--parchment);cursor:pointer;overflow:hidden;display:flex;align-items:center;justify-content:center}
.av-opt.sel{border-color:var(--amber);box-shadow:0 0 0 2px rgba(192,122,47,.3)}

/* Bulk assign */
.bulk-row{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--parchment)}
.bpill{font-size:11px;padding:3px 9px;border-radius:50px;border:1.5px solid var(--parchment);background:var(--white);cursor:pointer;font-family:'Lora',serif}
.bpill.active-Monsigny{background:#B5D5C5;border-color:#5a9478;color:#2d6b50}
.bpill.active-Pillon{background:#F5C6A0;border-color:#c07a2f;color:#8b4a10}
.bpill.active-Bareau{background:#C5D5F0;border-color:#4a6ab5;color:#2a4a8b}
.bpill.active-Baranowski{background:#E8C5E8;border-color:#9b5fa5;color:#6b2a7a}

/* Toast */
.toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--brown);color:var(--cream);padding:11px 22px;border-radius:50px;font-size:14px;font-family:'Lora',serif;z-index:999;opacity:0;transition:all .3s;pointer-events:none;white-space:nowrap;max-width:90vw;text-align:center}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* Doc */
.doc-item{display:flex;align-items:center;gap:10px;background:var(--white);border:1.5px solid var(--parchment);border-radius:12px;padding:10px 13px;margin-bottom:8px}

/* Migration bar */
#migrateBar{display:none;background:linear-gradient(135deg,#5a9478,#3d7a5a);padding:13px 20px;gap:12px;align-items:center;position:fixed;top:72px;left:0;right:0;z-index:110}

/* GEDCOM overlay */
.ged-radio-label{display:flex;align-items:center;gap:10px;background:var(--parchment);border-radius:10px;padding:10px 12px;cursor:pointer;margin-bottom:6px}
</style>
</head>
<body>

<!-- HEADER -->
<header id="hdr">
  <div class="hdr-left">
    <div class="hdr-title">ğŸŒ³ Arbre GÃ©nÃ©alogique</div>
    <div class="hdr-sub" id="syncLbl">Synchronisation...</div>
  </div>
  <div class="hdr-right">
    <button class="hdr-btn" onclick="loadData()" title="Actualiser">ğŸ”„</button>
    <button class="hdr-btn" id="lockBtn" onclick="togglePin()" title="Administration">ğŸ”’</button>
  </div>
</header>

<!-- MIGRATION BAR -->
<div id="migrateBar">
  <div style="flex:1;color:white;font-size:13px">ğŸ“± DonnÃ©es locales trouvÃ©es. Exporter vers le cloud?</div>
  <button onclick="migrateToCloud()" style="background:white;color:#3d7a5a;border:none;border-radius:50px;padding:7px 14px;font-size:13px;font-family:'Lora',serif;cursor:pointer;font-weight:600">Exporter â˜ï¸</button>
  <button onclick="document.getElementById('migrateBar').style.display='none'" style="background:rgba(255,255,255,.2);color:white;border:none;border-radius:50%;width:28px;height:28px;cursor:pointer;font-size:14px">âœ•</button>
</div>

<!-- TREE -->
<div id="treeWrap">
  <div id="treeInner">
    <svg id="treeSvg"></svg>
    <!-- person nodes injected here -->
  </div>
</div>

<!-- DETAIL PANEL -->
<div id="detailPanel">
  <div class="dp-handle"></div>
  <div class="dp-scroll">
    <div id="dpContent"></div>
  </div>
</div>

<!-- ADMIN PANEL -->
<div id="adminPanel" style="display:none">
  <div class="admin-menu" id="adminMenu" style="display:none">
    <button class="admin-menu-btn" onclick="openForm(null)">â• Ajouter une personne</button>
    <button class="admin-menu-btn" onclick="openBulk()">ğŸŒ¿ Assigner branches</button>
    <button class="admin-menu-btn" onclick="openGedcom()">ğŸ“¥ Importer GEDCOM</button>
    <button class="admin-menu-btn" onclick="logout()" style="color:var(--muted)">ğŸ”’ Verrouiller</button>
  </div>
  <button class="admin-fab" onclick="toggleAdminMenu()">âš™ï¸ Admin</button>
</div>

<!-- PIN OVERLAY -->
<div id="pinOv">
  <div class="pin-box">
    <div class="pin-title">ğŸ” Administration</div>
    <div class="pin-sub">Code PIN pour modifier l'arbre</div>
    <div class="pin-dots" id="pinDots">
      <div class="pin-dot" id="pd0"></div>
      <div class="pin-dot" id="pd1"></div>
      <div class="pin-dot" id="pd2"></div>
      <div class="pin-dot" id="pd3"></div>
    </div>
    <div class="pin-pad">
      <button class="pin-key" onclick="pinKey('1')">1</button>
      <button class="pin-key" onclick="pinKey('2')">2</button>
      <button class="pin-key" onclick="pinKey('3')">3</button>
      <button class="pin-key" onclick="pinKey('4')">4</button>
      <button class="pin-key" onclick="pinKey('5')">5</button>
      <button class="pin-key" onclick="pinKey('6')">6</button>
      <button class="pin-key" onclick="pinKey('7')">7</button>
      <button class="pin-key" onclick="pinKey('8')">8</button>
      <button class="pin-key" onclick="pinKey('9')">9</button>
      <button class="pin-key" onclick="pinKey('â†')" style="font-size:18px">âŒ«</button>
      <button class="pin-key" onclick="pinKey('0')">0</button>
      <button class="pin-key" onclick="closePinOv()" style="font-size:13px;color:var(--muted)">Annuler</button>
    </div>
    <div class="pin-err" id="pinErr"></div>
  </div>
</div>

<!-- FORM OVERLAY -->
<div class="overlay" id="formOv" onclick="if(event.target===this)closeOv('formOv')">
  <div class="sheet">
    <div class="sheet-hdr">
      <div class="sheet-title" id="formTitle">Ajouter une personne</div>
      <button class="btn-x" onclick="closeOv('formOv')">âœ•</button>
    </div>
    <div class="sheet-body">
      <!-- PHOTO -->
      <div class="fg">
        <img id="phPrev" class="ph-prev">
        <div class="photo-up" onclick="document.getElementById('phIn').click()">
          <div style="font-size:32px;color:var(--amber)">ğŸ“·</div>
          <div style="font-size:13px;color:var(--muted);margin-top:6px">Ajouter une photo</div>
        </div>
        <input type="file" id="phIn" accept="image/*" style="display:none" onchange="handlePhoto(event)">
      </div>

      <!-- AVATAR -->
      <div class="fg">
        <label class="fl">ğŸ¨ Avatar</label>
        <div class="frow">
          <div>
            <div style="font-size:11px;color:var(--muted);margin-bottom:4px">Teint</div>
            <div class="av-grid" id="avSkins"></div>
          </div>
          <div>
            <div style="font-size:11px;color:var(--muted);margin-bottom:4px">Cheveux</div>
            <div class="av-grid" id="avHairs"></div>
          </div>
          <div>
            <div style="font-size:11px;color:var(--muted);margin-bottom:4px">Style</div>
            <div class="av-grid" id="avStyles"></div>
          </div>
        </div>
      </div>

      <!-- NAME -->
      <div class="fg">
        <label class="fl">PrÃ©nom</label>
        <input class="fi" id="fPre" placeholder="PrÃ©nom">
      </div>
      <div class="fg">
        <label class="fl">Nom de famille</label>
        <input class="fi" id="fNom" placeholder="Nom">
      </div>

      <!-- DATES -->
      <div class="fg">
        <label class="fl">ğŸ‚ Naissance</label>
        <div class="frow">
          <input class="fi" id="fNais" placeholder="JJ.MM.AAAA ou AAAA">
          <button type="button" class="unk-btn" onclick="setUnknown('fNais')">?</button>
        </div>
      </div>
      <div class="fg">
        <label class="fl">ğŸ“ Lieu de naissance</label>
        <input class="fi" id="fLN" placeholder="Ville, pays">
      </div>
      <div class="fg">
        <label class="fl">âœï¸ DÃ©cÃ¨s</label>
        <div class="frow">
          <input class="fi" id="fDec" placeholder="JJ.MM.AAAA ou AAAA">
          <button type="button" class="unk-btn" onclick="setUnknown('fDec')">?</button>
        </div>
      </div>
      <div class="fg">
        <label class="fl">ğŸ“ Lieu de dÃ©cÃ¨s</label>
        <input class="fi" id="fLD" placeholder="Ville, pays">
      </div>

      <!-- BRANCHES -->
      <div class="fg">
        <label class="fl">ğŸŒ¿ Branches</label>
        <div style="display:flex;flex-wrap:wrap;gap:8px" id="branchPills">
          <span class="bpill" data-b="Monsigny" onclick="toggleBranchPill(this)">Monsigny</span>
          <span class="bpill" data-b="Pillon" onclick="toggleBranchPill(this)">Pillon</span>
          <span class="bpill" data-b="Bareau" onclick="toggleBranchPill(this)">Bareau</span>
          <span class="bpill" data-b="Baranowski de Rawiez" onclick="toggleBranchPill(this)">Baranowski</span>
        </div>
      </div>

      <!-- PARTNER -->
      <div class="fg">
        <label class="fl">ğŸ’‘ Partenaire(s)</label>
        <div id="partnerList" style="display:flex;flex-direction:column;gap:6px;margin-bottom:6px"></div>
        <button type="button" class="btn-pick" onclick="openPicker('partner')">+ Ajouter un(e) partenaire</button>
      </div>

      <!-- PARENTS -->
      <div class="fg">
        <label class="fl">ğŸ‘¨ PÃ¨re</label>
        <div id="pereBtnWrap">
          <button type="button" class="btn-pick" onclick="openPicker('pere')" id="pereBtn">+ Choisir le pÃ¨re</button>
        </div>
      </div>
      <div class="fg">
        <label class="fl">ğŸ‘© MÃ¨re</label>
        <div id="mereBtnWrap">
          <button type="button" class="btn-pick" onclick="openPicker('mere')" id="mereBtn">+ Choisir la mÃ¨re</button>
        </div>
      </div>

      <!-- GENERATION OVERRIDE -->
      <div class="fg">
        <label class="fl">ğŸŒ³ GÃ©nÃ©ration (optionnel)</label>
        <div style="display:flex;gap:8px;align-items:center">
          <button type="button" onclick="changeGenOffset(-1)" style="background:var(--parchment);border:2px solid var(--amber-light);border-radius:10px;width:40px;height:40px;font-size:20px;cursor:pointer">âˆ’</button>
          <div style="flex:1;background:var(--white);border:2px solid var(--parchment);border-radius:12px;padding:10px;text-align:center;font-family:'Playfair Display',serif;font-size:15px" id="genOffsetDisplay">Automatique</div>
          <button type="button" onclick="changeGenOffset(+1)" style="background:var(--parchment);border:2px solid var(--amber-light);border-radius:10px;width:40px;height:40px;font-size:20px;cursor:pointer">+</button>
          <button type="button" onclick="resetGenOffset()" style="background:var(--parchment);border:none;border-radius:10px;padding:10px 12px;font-size:12px;font-family:'Lora',serif;color:var(--muted);cursor:pointer">Auto</button>
        </div>
      </div>

      <!-- DOCUMENTS -->
      <div class="fg">
        <label class="fl">ğŸ“„ Documents</label>
        <div id="docList"></div>
        <div class="photo-up" onclick="document.getElementById('docIn').click()" style="padding:14px">
          <div style="font-size:28px;color:var(--amber)">ğŸ“</div>
          <div style="font-size:13px;color:var(--muted);margin-top:4px">Ajouter un document (PDF, image...)</div>
        </div>
        <input type="file" id="docIn" accept=".pdf,image/*" style="display:none" onchange="handleDoc(event)">
      </div>

      <!-- BIO -->
      <div class="fg">
        <label class="fl">ğŸ“– Biographie</label>
        <textarea class="fta" id="fBio" placeholder="Souvenirs, histoire de vie..."></textarea>
      </div>
      <div class="fg">
        <label class="fl">âœ¨ Anecdotes</label>
        <textarea class="fta" id="fAne" placeholder="Petites histoires, moments drÃ´les..."></textarea>
      </div>

      <button class="btn-save" onclick="savePerson()">ğŸ’¾ Enregistrer</button>
      <button id="btnDelete" onclick="confirmDelete()" style="display:none;width:100%;background:none;border:2px solid #e0a0a0;border-radius:14px;padding:13px;font-size:15px;font-family:'Lora',serif;color:#c0392b;cursor:pointer;margin-top:8px">ğŸ—‘ï¸ Supprimer cette personne</button>
    </div>
  </div>
</div>

<!-- PICKER OVERLAY -->
<div class="overlay" id="pickerOv" onclick="if(event.target===this)closeOv('pickerOv')">
  <div class="sheet">
    <div class="sheet-hdr">
      <div class="sheet-title" id="pickerTitle">Choisir</div>
      <button class="btn-x" onclick="closeOv('pickerOv')">âœ•</button>
    </div>
    <div style="padding:12px 16px;position:sticky;top:64px;background:var(--cream);z-index:3">
      <input class="fi" id="pickerQ" placeholder="ğŸ” Rechercher..." oninput="renderPicker()">
    </div>
    <div id="pickerList"></div>
  </div>
</div>

<!-- CONFIRM OVERLAY -->
<div class="overlay ov-center" id="confirmOv">
  <div class="confirm-box">
    <div style="font-size:40px;margin-bottom:12px">âš ï¸</div>
    <div style="font-family:'Playfair Display',serif;font-size:17px;color:var(--brown);margin-bottom:8px">Confirmation</div>
    <div style="font-size:14px;color:var(--muted)" id="confirmTxt"></div>
    <div class="confirm-btns">
      <button class="btn-no" onclick="closeOv('confirmOv')">Annuler</button>
      <button class="btn-yes" id="btnYes">Supprimer</button>
    </div>
  </div>
</div>

<!-- BULK OVERLAY -->
<div class="overlay" id="bulkOv" onclick="if(event.target===this)closeOv('bulkOv')">
  <div class="sheet">
    <div class="sheet-hdr">
      <div class="sheet-title">ğŸŒ¿ Assigner branches</div>
      <button class="btn-x" onclick="closeOv('bulkOv')">âœ•</button>
    </div>
    <div style="padding:12px 16px;position:sticky;top:64px;background:var(--cream);z-index:3">
      <input class="fi" id="bulkQ" placeholder="ğŸ” Rechercher..." oninput="renderBulk()" style="margin-bottom:8px">
      <div style="display:flex;gap:6px;flex-wrap:wrap" id="bulkChips">
        <span class="bpill active-Bareau" onclick="setBulkF('',this)" data-f="">Toutes</span>
        <span class="bpill" onclick="setBulkF('none',this)" data-f="none">Sans branche</span>
        <span class="bpill" onclick="setBulkF('Monsigny',this)" data-f="Monsigny">Monsigny</span>
        <span class="bpill" onclick="setBulkF('Pillon',this)" data-f="Pillon">Pillon</span>
        <span class="bpill" onclick="setBulkF('Bareau',this)" data-f="Bareau">Bareau</span>
        <span class="bpill" onclick="setBulkF('Baranowski de Rawiez',this)" data-f="Baranowski">Baran.</span>
      </div>
      <div style="font-size:11px;color:var(--muted);margin-top:6px" id="bulkStats"></div>
    </div>
    <div id="bulkList" style="padding:0 16px"></div>
    <div style="padding:16px;position:sticky;bottom:0;background:var(--cream)">
      <button class="btn-save" style="margin-top:0" onclick="saveBulk()">ğŸ’¾ Enregistrer tout</button>
    </div>
  </div>
</div>

<!-- GEDCOM OVERLAY -->
<div class="overlay" id="gedcomOv" onclick="if(event.target===this)closeOv('gedcomOv')">
  <div class="sheet">
    <div class="sheet-hdr">
      <div>
        <div class="sheet-title">ğŸ“¥ Importer GEDCOM</div>
        <div style="font-size:12px;color:var(--amber-light);margin-top:3px">Fichier .ged depuis MyHeritage, Geneanet...</div>
      </div>
      <button class="btn-x" onclick="closeOv('gedcomOv')">âœ•</button>
    </div>
    <div class="sheet-body">
      <div id="gedStep1">
        <!-- Delete options -->
        <div style="background:#fff8e8;border-radius:14px;padding:14px 16px;margin-bottom:8px;display:flex;align-items:center;gap:10px">
          <div style="flex:1;font-size:13px;color:#8b5a00;font-family:'Lora',serif;">â†©ï¸ Annuler le dernier import uniquement</div>
          <button onclick="undoLastImport()" style="background:#c07a2f;color:white;border:none;border-radius:50px;padding:8px 14px;font-size:13px;font-family:'Lora',serif;cursor:pointer;flex-shrink:0">Annuler</button>
        </div>
        <div style="background:#fff0f0;border-radius:14px;padding:14px 16px;margin-bottom:14px;display:flex;align-items:center;gap:10px">
          <div style="flex:1;font-size:13px;color:#8b0000;font-family:'Lora',serif;">ğŸ—‘ï¸ Supprimer TOUS les imports GEDCOM</div>
          <button onclick="deleteGedcomPersons()" style="background:#c0392b;color:white;border:none;border-radius:50px;padding:8px 14px;font-size:13px;font-family:'Lora',serif;cursor:pointer;flex-shrink:0">Tout supprimer</button>
        </div>
        <div style="background:var(--white);border-radius:14px;padding:20px;text-align:center;margin-bottom:16px">
          <div style="font-size:48px;margin-bottom:10px">ğŸ“‚</div>
          <div style="font-family:'Playfair Display',serif;font-size:17px;color:var(--brown);margin-bottom:6px">Choisir un fichier .ged</div>
          <button onclick="document.getElementById('gedFile').click()" class="btn-save" style="margin-top:0;width:auto;padding:12px 28px">Choisir le fichier</button>
          <input type="file" id="gedFile" accept=".ged,.gedcom" style="display:none" onchange="parseGedcomFile(event)">
        </div>
        <div style="background:var(--parchment);border-radius:14px;padding:16px">
          <div style="font-family:'Playfair Display',serif;font-size:15px;color:var(--brown);margin-bottom:12px">ğŸ“– Comment exporter ?</div>
          <div style="margin-bottom:12px">
            <div style="font-weight:600;font-size:14px;color:var(--amber-dark);margin-bottom:4px">ğŸ”µ MyHeritage</div>
            <div style="font-size:13px;line-height:1.7">GÃ©rer l'arbre â†’ <b>Exporter l'arbre</b> â†’ GEDCOM</div>
          </div>
          <div>
            <div style="font-weight:600;font-size:14px;color:var(--amber-dark);margin-bottom:4px">ğŸŸ¢ Geneanet</div>
            <div style="font-size:13px;line-height:1.7">Mon Espace â†’ ton arbre â†’ <b>Exporter</b> â†’ Format GEDCOM</div>
          </div>
        </div>
      </div>

      <div id="gedStep2" style="display:none">
        <div id="gedSummary" style="background:var(--white);border-radius:14px;padding:16px;margin-bottom:14px;text-align:center"></div>
        <div style="background:var(--white);border-radius:14px;padding:16px;margin-bottom:14px">
          <div style="font-family:'Playfair Display',serif;font-size:15px;color:var(--brown);margin-bottom:12px">ğŸ” Que voulez-vous importer ?</div>
          <div style="margin-bottom:12px">
            <div style="font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Personne de rÃ©fÃ©rence</div>
            <input class="fi" id="gedRootSearch" placeholder="ğŸ” Chercher une personne..." oninput="filterGedRoot()" style="margin-bottom:6px">
            <select class="fsel" id="gedRootSelect" style="margin-bottom:0" onchange="updateGedPreview()">
              <option value="">â€” Choisir â€”</option>
            </select>
            <div style="display:flex;gap:10px;margin-top:8px">
              <div style="flex:1">
                <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Profondeur ancÃªtres</div>
                <select class="fsel" id="gedAncDepth" onchange="updateGedPreview()">
                  <option value="0">IllimitÃ©e</option>
                  <option value="1">1 gÃ©nÃ©ration</option>
                  <option value="2">2 gÃ©nÃ©rations</option>
                  <option value="3" selected>3 gÃ©nÃ©rations</option>
                  <option value="4">4 gÃ©nÃ©rations</option>
                  <option value="5">5 gÃ©nÃ©rations</option>
                  <option value="6">6 gÃ©nÃ©rations</option>
                  <option value="7">7 gÃ©nÃ©rations</option>
                  <option value="8">8 gÃ©nÃ©rations</option>
                </select>
              </div>
              <div style="flex:1">
                <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Profondeur descendants</div>
                <select class="fsel" id="gedDescDepth" onchange="updateGedPreview()">
                  <option value="0">IllimitÃ©e</option>
                  <option value="1">1 gÃ©nÃ©ration</option>
                  <option value="2">2 gÃ©nÃ©rations</option>
                  <option value="3" selected>3 gÃ©nÃ©rations</option>
                  <option value="4">4 gÃ©nÃ©rations</option>
                  <option value="5">5 gÃ©nÃ©rations</option>
                  <option value="6">6 gÃ©nÃ©rations</option>
                  <option value="7">7 gÃ©nÃ©rations</option>
                  <option value="8">8 gÃ©nÃ©rations</option>
                </select>
              </div>
            </div>
            <label style="display:flex;gap:10px;align-items:center;margin-top:10px;font-size:13px;color:var(--muted)">
              <input type="checkbox" id="gedIncludeSpouses" checked onchange="updateGedPreview()" style="width:18px;height:18px;accent-color:var(--amber)">
              Inclure conjoint(e)s (recommandÃ©)
            </label>
          </div>
          <label class="ged-radio-label"><input type="radio" name="gedMode" value="all" checked onchange="updateGedPreview()" style="width:18px;height:18px;accent-color:var(--amber)"><div><div style="font-size:14px;font-weight:600">Tout importer</div><div style="font-size:12px;color:var(--muted)">Toutes les personnes du fichier</div></div></label>
          <label class="ged-radio-label"><input type="radio" name="gedMode" value="ancestors" onchange="updateGedPreview()" style="width:18px;height:18px;accent-color:var(--amber)"><div><div style="font-size:14px;font-weight:600">â¬†ï¸ AncÃªtres directs</div></div></label>
          <label class="ged-radio-label"><input type="radio" name="gedMode" value="descendants" onchange="updateGedPreview()" style="width:18px;height:18px;accent-color:var(--amber)"><div><div style="font-size:14px;font-weight:600">â¬‡ï¸ Descendants directs</div></div></label>
          <label class="ged-radio-label"><input type="radio" name="gedMode" value="both" onchange="updateGedPreview()" style="width:18px;height:18px;accent-color:var(--amber)"><div><div style="font-size:14px;font-weight:600">â¬†ï¸â¬‡ï¸ AncÃªtres + Descendants</div></div></label>
          <label class="ged-radio-label"><input type="radio" name="gedMode" value="manual" onchange="updateGedPreview()" style="width:18px;height:18px;accent-color:var(--amber)"><div><div style="font-size:14px;font-weight:600">âœ‹ SÃ©lection manuelle</div></div></label>
        </div>
        <div style="font-family:'Playfair Display',serif;font-size:14px;color:var(--brown);margin-bottom:8px">AperÃ§u : <span id="gedSelCount">0</span> personne(s)</div>
        <input class="fi" id="gedPersonSearch" placeholder="ğŸ” Rechercher dans la liste..." oninput="renderGedList()" style="margin-bottom:8px">
        <div id="gedPreview" style="max-height:240px;overflow-y:auto;background:var(--white);border-radius:14px;padding:10px;margin-bottom:14px"></div>
        <div style="display:flex;gap:10px">
          <button onclick="gedReset()" style="flex:1;background:var(--parchment);border:none;border-radius:13px;padding:14px;font-size:15px;font-family:'Lora',serif;cursor:pointer">â† Retour</button>
          <button onclick="gedImport()" class="btn-save" style="flex:2;margin-top:0">âœ… Importer</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ============================================================
// CONSTANTS & DATA
// ============================================================
// PWA: service worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}

const PIN_CODE = '2225';
const STORAGE_KEY = 'arbre-v5';
const BIN_ID  = '69975946d0ea881f40c79dfb';
const BIN_KEY = '$2a$10$V1K8NkM0TF2TJs.85JhsO.2TU/8SHOE5ChbUCU8ZI0rHVUKHKyhQK';
const BIN_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
const BRANCHES = ['Monsigny','Pillon','Bareau','Baranowski de Rawiez'];
const BC = {
  'Monsigny':{bg:'#B5D5C5',text:'#2d6b50',border:'#5a9478'},
  'Pillon':{bg:'#F5C6A0',text:'#8b4a10',border:'#c07a2f'},
  'Bareau':{bg:'#C5D5F0',text:'#2a4a8b',border:'#4a6ab5'},
  'Baranowski de Rawiez':{bg:'#E8C5E8',text:'#6b2a7a',border:'#9b5fa5'},
};
const HAIRSTYLES = {
  court:   c=>`<ellipse cx="50" cy="26" rx="21" ry="9" fill="${c}"/>`,
  long:    c=>`<ellipse cx="50" cy="26" rx="21" ry="9" fill="${c}"/><rect x="29" y="26" width="7" height="28" rx="4" fill="${c}"/><rect x="64" y="26" width="7" height="28" rx="4" fill="${c}"/>`,
  boucle:  c=>`<circle cx="31" cy="27" r="10" fill="${c}"/><circle cx="43" cy="21" r="10" fill="${c}"/><circle cx="57" cy="21" r="10" fill="${c}"/><circle cx="69" cy="27" r="10" fill="${c}"/>`,
  chignon: c=>`<ellipse cx="50" cy="26" rx="21" ry="9" fill="${c}"/><circle cx="50" cy="14" r="8" fill="${c}"/>`,
  chauve:  ()=>'',
  tresses: c=>`<ellipse cx="50" cy="26" rx="21" ry="9" fill="${c}"/><rect x="30" y="28" width="6" height="32" rx="3" fill="${c}"/><rect x="64" y="28" width="6" height="32" rx="3" fill="${c}"/>`,
};
const SKIN_COLORS  = ['#FDBCB4','#F1C27D','#E0AC69','#C68642','#8D5524','#FFE0BD','#D4A574'];
const HAIR_COLORS  = ['#1a0a00','#4a2c11','#8B4513','#c07a2f','#D4A017','#708090','#f0f0f0'];
const HAIR_STYLES  = ['court','long','boucle','chignon','chauve','tresses'];

let persons = [];
let isUnlocked = false;
let pinInput = '';
let adminMenuOpen = false;
let selectedPersonId = null;
let _genCache = null;

// Form state
let editingId = null;
let photoData = null;
let formPereId = null;
let formMereId = null;
let formPartnerIds = [];
let formAv = {skin:'#FDBCB4', hair:'#4a2c11', style:'court'};
let formGenOffset = null;
let formDocs = [];
let pickerTarget = null;
let bulkChanges = {};
let bulkFilter = '';

// GEDCOM state
let gedAllPersons = [];
let gedSelected = new Set();

// ============================================================
// CLOUD SYNC
// ============================================================
async function loadData() {
  showSync('â³ Chargement...');
  try {
    const r = await fetch(BIN_URL + '/latest', { headers:{'X-Master-Key':BIN_KEY} });
    if (r.ok) {
      const data = await r.json();
      const cloud = data.record.persons || [];
      let local = [];
      try { const l = localStorage.getItem(STORAGE_KEY); local = l ? JSON.parse(l) : []; } catch {}
      let old = [];
      try { const l = localStorage.getItem('arbre-v3'); old = l ? JSON.parse(l) : []; } catch {}
      const bestLocal = local.length >= old.length ? local : old;
      if (cloud.length === 0 && bestLocal.length > 0) {
        persons = bestLocal; renderTree();
        showSync('âš ï¸ DonnÃ©es locales');
        setTimeout(()=>{ document.getElementById('migrateBar').style.display='flex'; }, 500);
        return;
      }
      persons = cloud;
      showSync('âœ… SynchronisÃ©'); setTimeout(hideSync, 2500);
    } else throw new Error();
  } catch {
    try { const l = localStorage.getItem(STORAGE_KEY); persons = l ? JSON.parse(l) : demo(); } catch { persons = demo(); }
    showSync('âš ï¸ Hors ligne'); setTimeout(hideSync, 3000);
  }
  _genCache = null; renderTree();
}

async function migrateToCloud() {
  document.getElementById('migrateBar').style.display = 'none';
  showSync('ğŸ”„ Export...');
  try {
    const r = await fetch(BIN_URL, { method:'PUT', headers:{'Content-Type':'application/json','X-Master-Key':BIN_KEY}, body:JSON.stringify({persons}) });
    if (r.ok) { showSync('âœ… ExportÃ© !'); setTimeout(hideSync,2500); showToast('ğŸ‰ '+persons.length+' personnes exportÃ©es !'); }
  } catch { showSync('âš ï¸ Erreur'); setTimeout(hideSync,3000); }
}

async function saveData() {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(persons)); } catch {}
  showSync('ğŸ”„ Sync...');
  try {
    const r = await fetch(BIN_URL, { method:'PUT', headers:{'Content-Type':'application/json','X-Master-Key':BIN_KEY}, body:JSON.stringify({persons}) });
    if (r.ok) { showSync('âœ… SynchronisÃ©'); setTimeout(hideSync,2500); }
    else throw new Error();
  } catch { showSync('âš ï¸ Local seulement'); setTimeout(hideSync,3000); }
}

function showSync(m){ const e=document.getElementById('syncLbl'); e.textContent=m; e.style.opacity='1'; }
function hideSync(){ const e=document.getElementById('syncLbl'); if(e) e.style.opacity='0'; }

function demo() {
  return [
    {id:'p1',pre:'HervÃ© Gilles',nom:'Bareau',nais:'20.12.1940',dec:'',lieuN:'Paris',lieuD:'',photo:'',bio:'',ane:'',branches:['Bareau'],pereId:null,mereId:null,partnerIds:[],av:{skin:'#FDBCB4',hair:'#4a2c11',style:'court'}},
    {id:'p2',pre:'MichÃ¨le Marie-Louise',nom:'Monsigny',nais:'30.09.1935',dec:'',lieuN:'Paris',lieuD:'',photo:'',bio:'',ane:'',branches:['Monsigny'],pereId:null,mereId:null,partnerIds:[],av:{skin:'#F1C27D',hair:'#1a0a00',style:'long'}},
    {id:'p3',pre:'Alexandrine',nom:'Bareau',nais:'18.09.1974',dec:'',lieuN:'Winterthur',lieuD:'',photo:'',bio:'',ane:'',branches:['Bareau','Monsigny'],pereId:'p1',mereId:'p2',partnerIds:[],av:{skin:'#FDBCB4',hair:'#8B4513',style:'long'}},
    {id:'p4',pre:'GÃ©raldine',nom:'Bareau',nais:'20.04.1976',dec:'',lieuN:'Winterthur',lieuD:'',photo:'',bio:'',ane:'',branches:['Bareau','Monsigny'],pereId:'p1',mereId:'p2',partnerIds:[],av:{skin:'#FDBCB4',hair:'#c07a2f',style:'boucle'}},
  ];
}

// ============================================================
// GENERATION CALCULATION
// ============================================================
function buildGenCache() {
  _genCache = {};
  const gen = {};

  function topDown(id, visited) {
    if (!id) return undefined;
    if (gen[id] !== undefined) return gen[id];
    if (visited.has(id)) return undefined;
    visited.add(id);
    const p = persons.find(x=>x.id===id);
    if (!p) return undefined;
    if (!p.pereId && !p.mereId) { gen[id]=0; return 0; }
    const pg = p.pereId ? topDown(p.pereId, new Set(visited)) : undefined;
    const mg = p.mereId ? topDown(p.mereId, new Set(visited)) : undefined;
    const vals = [pg,mg].filter(v=>v!==undefined);
    const g = vals.length ? Math.max(...vals)+1 : 0;
    gen[id]=g; return g;
  }
  persons.forEach(p=>topDown(p.id, new Set()));

  // Bottom-up for founders without parents
  persons.forEach(p => {
    if (p.pereId || p.mereId) return;
    const children = persons.filter(c=>c.pereId===p.id||c.mereId===p.id);
    const cg = children.map(c=>gen[c.id]).filter(v=>v!==undefined);
    if (cg.length) gen[p.id] = Math.min(...cg)-1;
  });

  // Couple alignment (founders only)
  persons.forEach(p => {
    if (p.pereId||p.mereId) return;
    getStrictPartners(p).forEach(pid => {
      const partner = persons.find(x=>x.id===pid);
      if (partner && (partner.pereId||partner.mereId) && gen[pid]!==undefined)
        gen[p.id] = gen[pid];
    });
  });

  // Normalize to 0
  const vals = Object.values(gen).filter(v=>v!==undefined);
  const minG = vals.length ? Math.min(...vals) : 0;
  persons.forEach(p => { _genCache[p.id] = (gen[p.id]!==undefined ? gen[p.id]-minG : 0); });

  // Validation: parent always strictly above child
  for (let i=0; i<5; i++) {
    let fixed=false;
    persons.forEach(p => {
      const cg = _genCache[p.id]??0;
      [p.pereId,p.mereId].forEach(pid => {
        if (!pid) return;
        if ((_genCache[pid]??0) >= cg) { _genCache[pid]=cg-1; fixed=true; }
      });
    });
    if (!fixed) break;
  }
  // Re-normalize
  const vals2 = Object.values(_genCache);
  const min2 = Math.min(...vals2);
  if (min2!==0) Object.keys(_genCache).forEach(id=>{ _genCache[id]-=min2; });
}

function getGeneration(p) {
  if (!_genCache) buildGenCache();
  return (_genCache[p.id]??0) + (p.genOffset||0);
}

// ============================================================
// STRICT PARTNER DETECTION
// ============================================================
function getStrictPartners(p) {
  const parentIds = new Set([p.pereId,p.mereId].filter(Boolean));
  const childIds  = new Set(persons.filter(c=>c.pereId===p.id||c.mereId===p.id).map(c=>c.id));
  const result    = new Set();
  const safe = id => id && !parentIds.has(id) && !childIds.has(id) && id!==p.id;
  (p.partnerIds||[]).forEach(pid=>{ if(safe(pid)) result.add(pid); });
  persons.forEach(x=>{ if((x.partnerIds||[]).includes(p.id)&&safe(x.id)) result.add(x.id); });
  persons.forEach(c=>{
    if (!c.pereId||!c.mereId) return;
    if (c.pereId!==p.id&&c.mereId!==p.id) return;
    const other = c.pereId===p.id ? c.mereId : c.pereId;
    if (safe(other)) result.add(other);
  });
  return result;
}

// ============================================================
// AVATAR
// ============================================================
function avatarSvg(p, size=60) {
  const av = p.av || {skin:'#FDBCB4', hair:'#4a2c11', style:'court'};
  const hair = HAIRSTYLES[av.style||'court']?.(av.hair||'#4a2c11') || '';
  return `<svg viewBox="0 0 100 100" width="${size}" height="${size}" xmlns="http://www.w3.org/2000/svg">
    <circle cx="50" cy="50" r="50" fill="${av.skin||'#FDBCB4'}"/>
    ${hair}
    <ellipse cx="50" cy="38" rx="18" ry="20" fill="${av.skin||'#FDBCB4'}"/>
    <ellipse cx="43" cy="37" rx="4" ry="5" fill="white"/>
    <ellipse cx="57" cy="37" rx="4" ry="5" fill="white"/>
    <circle cx="43" cy="37" r="2.5" fill="#2d1a0a"/>
    <circle cx="57" cy="37" r="2.5" fill="#2d1a0a"/>
    <path d="M 43 47 Q 50 52 57 47" stroke="#2d1a0a" stroke-width="1.5" fill="none"/>
    <ellipse cx="50" cy="65" rx="22" ry="18" fill="${av.skin||'#FDBCB4'}"/>
  </svg>`;
}

function personImgHtml(p, size=60) {
  if (p.photo && p.photo.length > 10)
    return `<img src="${p.photo}" style="width:${size}px;height:${size}px;object-fit:cover;border-radius:${size<40?'50%':'8px'}" alt="">`;
  return avatarSvg(p, size);
}

function fmtYears(p) {
  const b = p.nais ? (p.nais==='?' ? '?' : p.nais.split('.').pop()||p.nais) : '';
  const d = p.dec  ? (p.dec==='?'  ? '?' : p.dec.split('.').pop()||p.dec)   : '';
  if (!b && !d) return '';
  if (b && d) return `${b} â€“ ${d}`;
  if (b) return `* ${b}`;
  return `â€  ${d}`;
}

function getBranches(p) { return p.branches||[]; }

// ============================================================
// TREE LAYOUT
// ============================================================
const CARD_W = 110, CARD_H = 130, COUPLE_GAP = 12, UNIT_GAP = 44, GEN_H = 210, PAD = 60;

function buildTreeSet() {
  const alex = persons.find(p => p.pre.toLowerCase().includes('alexandrine') && p.nom.toLowerCase().includes('bareau'));
  if (!alex && persons.length === 0) return { treeIds: new Set(), rootId: null };
  const root = alex || persons[0];

  const treeIds = new Set();

  // Ancestors (recursive parents)
  function addAnc(id, vis=new Set()) {
    if (!id || vis.has(id)) return; vis.add(id); treeIds.add(id);
    const p = persons.find(x=>x.id===id); if(!p) return;
    if (p.pereId) addAnc(p.pereId, new Set(vis));
    if (p.mereId) addAnc(p.mereId, new Set(vis));
  }
  addAnc(root.id);

  // Descendants (recursive children)
  function addDesc(id, vis=new Set()) {
    if (!id || vis.has(id)) return; vis.add(id); treeIds.add(id);
    persons.filter(c=>c.pereId===id||c.mereId===id).forEach(c=>addDesc(c.id, new Set(vis)));
  }
  addDesc(root.id);

  // Partners of everyone in tree
  [...treeIds].forEach(id => {
    const p = persons.find(x=>x.id===id); if(!p) return;
    getStrictPartners(p).forEach(pid => treeIds.add(pid));
  });

  return { treeIds, rootId: root.id };
}

function layoutTree(treeIds, rootId) {
  if (!_genCache) buildGenCache();

  // Group by generation
  const byGen = {};
  treeIds.forEach(id => {
    const p = persons.find(x=>x.id===id); if(!p) return;
    const g = getGeneration(p);
    if (!byGen[g]) byGen[g] = [];
    byGen[g].push(id);
  });

  const gens = Object.keys(byGen).map(Number).sort((a,b)=>a-b);

  // For each generation, create units (couples or singles)
  // keeping couples that BOTH are in the tree together
  const units = {}; // gen -> [{ids:[...], cx:0}]
  const placed = new Set();

  gens.forEach(g => {
    const ids = byGen[g];
    placed.clear();
    const genUnits = [];

    ids.forEach(id => {
      if (placed.has(id)) return;
      placed.add(id);
      const p = persons.find(x=>x.id===id); if(!p) return;
      const partners = [...getStrictPartners(p)].filter(pid => ids.includes(pid));
      if (partners.length > 0) {
        const pid = partners[0];
        placed.add(pid);
        genUnits.push({ ids:[id, pid], w: CARD_W*2 + COUPLE_GAP });
      } else {
        genUnits.push({ ids:[id], w: CARD_W });
      }
    });
    units[g] = genUnits;
  });

  // Position units - try to center parents over their children
  // Simple approach: center each row, then adjust based on children positions
  const positions = {}; // id -> {x, y}

  // First pass: assign centered x positions per generation
  gens.forEach(g => {
    const genUnits = units[g];
    if (!genUnits || !genUnits.length) return;
    const totalW = genUnits.reduce((s,u)=>s+u.w,0) + Math.max(0,genUnits.length-1)*UNIT_GAP;
    let x = -totalW/2;
    genUnits.forEach(unit => {
      const cx = x + unit.w/2;
      if (unit.ids.length === 2) {
        positions[unit.ids[0]] = { x, y: g*GEN_H };
        positions[unit.ids[1]] = { x: x+CARD_W+COUPLE_GAP, y: g*GEN_H };
      } else {
        positions[unit.ids[0]] = { x: x, y: g*GEN_H };
      }
      x += unit.w + UNIT_GAP;
    });
  });

  // Second pass: for each couple unit, reposition to center over their children in tree
  // Do this bottom-up (from deepest generation upward)
  const sortedGens = [...gens].reverse(); // deepest first
  sortedGens.forEach(g => {
    const genUnits = units[g]; if(!genUnits) return;

    genUnits.forEach(unit => {
      // Find direct children of this unit in tree (next generation)
      const parentIds = new Set(unit.ids);
      const children = [...treeIds].filter(cid => {
        const c = persons.find(x=>x.id===cid); if(!c) return false;
        return (c.pereId && parentIds.has(c.pereId)) || (c.mereId && parentIds.has(c.mereId));
      });

      if (children.length === 0) return;

      // Get average x of children
      const childXs = children.map(cid => {
        const pos = positions[cid];
        return pos ? pos.x + CARD_W/2 : null;
      }).filter(x=>x!==null);

      if (!childXs.length) return;
      const avgChildX = childXs.reduce((s,x)=>s+x,0)/childXs.length;
      const unitCenter = avgChildX;
      const unitLeft = unitCenter - unit.w/2;
      const shift = unitLeft - positions[unit.ids[0]].x;

      if (Math.abs(shift) < 5) return;

      // Apply shift to this unit
      unit.ids.forEach((id,i) => {
        if (positions[id]) positions[id].x += shift;
      });
    });

    // After repositioning, resolve overlaps in this generation
    const allInGen = genUnits.flatMap(u=>u.ids);
    // Sort by x, push apart if too close
    const sortedUnits = [...genUnits].sort((a,b)=>(positions[a.ids[0]]?.x||0)-(positions[b.ids[0]]?.x||0));
    for (let i=1; i<sortedUnits.length; i++) {
      const prev = sortedUnits[i-1];
      const cur  = sortedUnits[i];
      const prevRight = (positions[prev.ids[prev.ids.length-1]]?.x||0) + CARD_W;
      const curLeft   = positions[cur.ids[0]]?.x||0;
      if (curLeft < prevRight + UNIT_GAP) {
        const overlap = prevRight + UNIT_GAP - curLeft;
        cur.ids.forEach(id => { if(positions[id]) positions[id].x += overlap; });
      }
    }
  });

  // Calculate bounds
  let minX=Infinity, maxX=-Infinity, minY=Infinity, maxY=-Infinity;
  Object.values(positions).forEach(pos => {
    minX=Math.min(minX,pos.x); maxX=Math.max(maxX,pos.x+CARD_W);
    minY=Math.min(minY,pos.y); maxY=Math.max(maxY,pos.y+CARD_H);
  });

  // Offset so all positive
  const offX = PAD - minX;
  const offY = PAD - minY;
  Object.values(positions).forEach(pos => { pos.x+=offX; pos.y+=offY; });

  const totalW = maxX-minX + PAD*2;
  const totalH = maxY-minY + PAD*2 + 40;

  return { positions, totalW, totalH, rootId };
}

// ============================================================
// TREE RENDERING
// ============================================================
function renderTree() {
  const { treeIds, rootId } = buildTreeSet();

  if (treeIds.size === 0) {
    document.getElementById('treeInner').innerHTML = '<div style="text-align:center;padding:80px 40px;color:var(--muted)"><div style="font-size:56px;margin-bottom:16px">ğŸŒ±</div><div style="font-family:\'Playfair Display\',serif;font-size:22px;color:var(--brown);margin-bottom:8px">Arbre vide</div><div style="font-size:15px">Ajoutez des personnes via l\'admin âš™ï¸</div></div>';
    return;
  }

  const { positions, totalW, totalH } = layoutTree(treeIds, rootId);

  // Build DOM
  const inner = document.getElementById('treeInner');
  inner.innerHTML = '';
  inner.style.width  = totalW + 'px';
  inner.style.height = totalH + 'px';

  // SVG lines
  const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('id','treeSvg');
  svg.setAttribute('width', totalW);
  svg.setAttribute('height', totalH);
  inner.appendChild(svg);

  // Draw connections
  treeIds.forEach(id => {
    const p = persons.find(x=>x.id===id); if(!p) return;
    const children = [...treeIds].filter(cid=>{
      const c = persons.find(x=>x.id===cid);
      return c && (c.pereId===id || c.mereId===id);
    });

    children.forEach(cid => {
      const pPos = positions[id];
      const cPos = positions[cid];
      if (!pPos || !cPos) return;

      // Mid-point of parent bottom
      const px = pPos.x + CARD_W/2;
      const py = pPos.y + CARD_H;
      // Mid-point of child top
      const cx = cPos.x + CARD_W/2;
      const cy = cPos.y;

      const midY = (py + cy) / 2;
      const path = document.createElementNS('http://www.w3.org/2000/svg','path');
      path.setAttribute('d', `M ${px} ${py} C ${px} ${midY}, ${cx} ${midY}, ${cx} ${cy}`);
      path.setAttribute('class', 'tree-path');
      svg.appendChild(path);
    });
  });

  // Draw couple connectors
  const drawnCouples = new Set();
  treeIds.forEach(id => {
    const p = persons.find(x=>x.id===id); if(!p) return;
    getStrictPartners(p).forEach(pid => {
      if (!treeIds.has(pid)) return;
      const key = [id,pid].sort().join('|');
      if (drawnCouples.has(key)) return;
      drawnCouples.add(key);
      const p1 = positions[id], p2 = positions[pid];
      if (!p1||!p2) return;
      const left = Math.min(p1.x,p2.x)+CARD_W;
      const right = Math.max(p1.x,p2.x);
      const y = p1.y + CARD_H/2 - 5;
      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1',left); line.setAttribute('y1',y);
      line.setAttribute('x2',right); line.setAttribute('y2',y);
      line.setAttribute('stroke','#e8c4a0'); line.setAttribute('stroke-width','2.5');
      line.setAttribute('stroke-dasharray','5,4');
      svg.appendChild(line);
    });
  });

  // Render person cards
  treeIds.forEach(id => {
    const p = persons.find(x=>x.id===id); if(!p) return;
    const pos = positions[id]; if(!pos) return;

    const isRoot = id === rootId;
    const branches = getBranches(p);
    const firstBranch = branches[0]||'';
    const bKey = firstBranch.split(' ')[0];

    const div = document.createElement('div');
    div.className = `pnode${bKey?' bn-'+bKey:''}${isRoot?' root-node':''}${id===selectedPersonId?' selected':''}`;
    div.style.left = pos.x + 'px';
    div.style.top  = pos.y + 'px';
    div.dataset.id = id;
    div.onclick = () => openDetail(id);
    div.style.zIndex = '1';

    const isAnc = !isRoot && isAncestorOf(rootId, id);
    const ancBanner = isAnc ? `<div class="ancestor-banner">â­ ANCÃŠTRE</div>` : '';
    const rootBadge = isRoot ? `<div class="pnode-root-badge">â­</div>` : '';

    div.innerHTML = `
      ${ancBanner}
      <div class="pnode-img">${personImgHtml(p, 110)}</div>
      <div class="pnode-body">
        ${rootBadge}
        <div class="pnode-name">${p.pre}<br>${p.nom}</div>
        <div class="pnode-years">${fmtYears(p)}</div>
      </div>`;
    inner.appendChild(div);
  });

  // Scroll to root person
  const rootPos = positions[rootId];
  if (rootPos) {
    setTimeout(() => {
      const wrap = document.getElementById('treeWrap');
      const targetX = rootPos.x + CARD_W/2 - wrap.clientWidth/2;
      const targetY = rootPos.y + CARD_H/2 - wrap.clientHeight/2;
      wrap.scrollLeft = Math.max(0, targetX);
      wrap.scrollTop  = Math.max(0, targetY);
    }, 100);
  }
}

function isAncestorOf(rootId, checkId, visited=new Set()) {
  if (!rootId || visited.has(rootId)) return false;
  visited.add(rootId);
  const root = persons.find(x=>x.id===rootId); if(!root) return false;
  if (root.pereId === checkId || root.mereId === checkId) return true;
  return (root.pereId && isAncestorOf(root.pereId, checkId, new Set(visited))) ||
         (root.mereId && isAncestorOf(root.mereId, checkId, new Set(visited)));
}

// ============================================================
// DETAIL PANEL
// ============================================================
function openDetail(id) {
  selectedPersonId = id;
  // Update selected styling
  document.querySelectorAll('.pnode').forEach(el => {
    el.classList.toggle('selected', el.dataset.id === id);
  });

  const p = persons.find(x=>x.id===id);
  if (!p) return;

  const branches = getBranches(p);
  const branchBadges = branches.map(b => {
    const bc = BC[b]||{}; const bk = b.split(' ')[0];
    return `<span class="dp-btag" style="background:${bc.bg||'#ddd'};color:${bc.text||'#333'}">${bk}</span>`;
  }).join('');

  const photoHtml = p.photo && p.photo.length > 10
    ? `<img src="${p.photo}" style="width:100%;height:100%;object-fit:cover">`
    : `<div style="width:90px;height:90px;display:flex;align-items:center;justify-content:center">${avatarSvg(p,80)}</div>`;

  // Birth / death info
  const mapsA = (place)=> place ? ` Â· <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place)}" target="_blank" rel="noopener" class="dp-place">${place}</a>` : '';
  let datesHtml = '';
  if (p.nais) datesHtml += `ğŸ‚ ${p.nais==='?'?'Date inconnue':p.nais}${mapsA(p.lieuN)}`;
  if (p.dec) datesHtml += (datesHtml?'<br>':'') + `âœï¸ ${p.dec==='?'?'Date inconnue':p.dec}${mapsA(p.lieuD)}`;

  // Relations
 mere  = p.mereId ? persons.find(x=>x.id===p.mereId) : null;
  const partners = [...getStrictPartners(p)].map(pid=>persons.find(x=>x.id===pid)).filter(Boolean);
  const children = persons.filter(c=>c.pereId===id||c.mereId===id);
  const siblings = persons.filter(s => s.id!==id && ((p.pereId&&s.pereId===p.pereId)||(p.mereId&&s.mereId===p.mereId)));

  const relChip = (rel) => `<div class="dp-rel-chip" onclick="openDetail('${rel.id}')">
    <div class="dp-rel-av">${personImgHtml(rel,28)}</div>
    <span>${rel.pre} ${rel.nom}</span>
  </div>`;

  let relHtml = '';
  if (partners.length) relHtml += `<div class="dp-section"><div class="dp-sec-title">ğŸ’‘ Partenaire(s)</div><div class="dp-rel-list">${partners.map(relChip).join('')}</div></div>`;
  if (pere||mere) {
    const ps = [pere,mere].filter(Boolean);
    relHtml += `<div class="dp-section"><div class="dp-sec-title">ğŸ‘¨ğŸ‘© Parents</div><div class="dp-rel-list">${ps.map(relChip).join('')}</div></div>`;
  }
  if (children.length) relHtml += `<div class="dp-section"><div class="dp-sec-title">ğŸ‘¶ Enfants (${children.length})</div><div class="dp-rel-list">${children.map(relChip).join('')}</div></div>`;
  if (siblings.length) relHtml += `<div class="dp-section"><div class="dp-sec-title">ğŸ‘« FrÃ¨res & SÅ“urs (${siblings.length})</div><div class="dp-rel-list">${siblings.map(relChip).join('')}</div></div>`;

  // Bio + docs
  let bioHtml = '';
  if (p.bio) bioHtml += `<div class="dp-section"><div class="dp-sec-title">ğŸ“– Biographie</div><div class="dp-bio">${p.bio}</div></div>`;
  if (p.ane) bioHtml += `<div class="dp-section"><div class="dp-sec-title">âœ¨ Anecdotes</div><div class="dp-bio">${p.ane}</div></div>`;

  let docsHtml = '';
  if (p.docs && p.docs.length) {
    docsHtml = `<div class="dp-section"><div class="dp-sec-title">ğŸ“„ Documents (${p.docs.length})</div>`;
    p.docs.forEach((doc,i) => {
      const icon = doc.type&&doc.type.includes('pdf') ? 'ğŸ“•' : 'ğŸ–¼ï¸';
      docsHtml += `<div class="doc-item"><div style="font-size:24px">${icon}</div><div style="flex:1;min-width:0"><div style="font-size:13px;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${doc.name}</div><div style="font-size:11px;color:var(--muted)">${doc.size||''}</div></div><button onclick="viewDoc(${i},'${id}')" style="background:none;border:none;font-size:20px;cursor:pointer">ğŸ‘ï¸</button></div>`;
    });
    docsHtml += '</div>';
  }

  const editBtn = isUnlocked
    ? `<button class="dp-edit-btn" onclick="closeDetail();setTimeout(()=>openForm('${id}'),200)">âœï¸ Modifier</button>`
    : '';

  document.getElementById('dpContent').innerHTML = `
    <div class="dp-header">
      <div class="dp-photo">${photoHtml}</div>
      <div class="dp-info">
        <div class="dp-name">${p.pre} ${p.nom}</div>
        <div class="dp-dates">${datesHtml||'Dates inconnues'}</div>
        <div class="dp-branches">${branchBadges}</div>
      </div>
      <button class="dp-close" onclick="closeDetail()">âœ•</button>
    </div>
    <div class="dp-body">
      ${relHtml}
      ${bioHtml}
      ${docsHtml}
    </div>
    ${editBtn}
    <div id="miniTreeWrap"></div>
  `;

  renderMiniTree(id);

  const panel = document.getElementById('detailPanel');
  panel.classList.add('open');
}

function closeDetail() {
  document.getElementById('detailPanel').classList.remove('open');
  selectedPersonId = null;
  document.querySelectorAll('.pnode').forEach(el=>el.classList.remove('selected'));
}

// Mini tree in detail
function renderMiniTree(id) {
  const p = persons.find(x=>x.id===id); if(!p) return;
  const wrap = document.getElementById('miniTreeWrap'); if(!wrap) return;

  const pere    = p.pereId ? persons.find(x=>x.id===p.pereId) : null;
  const mere    = p.mereId ? persons.find(x=>x.id===p.mereId) : null;
  const partners= [...getStrictPartners(p)].map(pid=>persons.find(x=>x.id===pid)).filter(Boolean);
  const children= persons.filter(c=>c.pereId===id||c.mereId===id);
  const siblings= persons.filter(s=>s.id!==id&&((p.pereId&&s.pereId===p.pereId)||(p.mereId&&s.mereId===p.mereId))).slice(0,4);

  const MW=86, MH=100, MGAP=14, MGAPY=80;
  const personCard = (pr, isMain=false, label='') => ({person:pr, isMain, label});

  // Row 0: parents
  const parRow = [pere,mere].filter(Boolean);
  // Row 1: [siblings..., main person + partner(s)]
  // Row 2: children

  const toCard = (pr, isMain=false) => {
    if (!pr) return '';
    const border = isMain ? '3px solid var(--amber)' : '1.5px solid var(--parchment)';
    const bg = isMain ? 'var(--amber-light)' : 'var(--white)';
    const label = isMain ? `<div style="font-size:7px;text-align:center;background:var(--amber);color:white;padding:1px 0">â— Cette personne</div>` : '';
    return `<div onclick="openDetail('${pr.id}')" style="width:${MW}px;background:var(--white);border-radius:10px;border:${border};overflow:hidden;cursor:pointer;flex-shrink:0">
      ${label}
      <div style="width:100%;aspect-ratio:1;background:var(--parchment);display:flex;align-items:center;justify-content:center;overflow:hidden">${personImgHtml(pr,MW)}</div>
      <div style="padding:4px 6px;background:${isMain?'#fff9f0':'var(--white)'}">
        <div style="font-family:'Playfair Display',serif;font-size:9.5px;font-weight:600;line-height:1.3;color:var(--brown)">${pr.pre}<br>${pr.nom}</div>
        <div style="font-size:8px;color:var(--muted)">${fmtYears(pr)}</div>
      </div>
    </div>`;
  };

  // Build SVG mini tree
  // Positions: parents top row centered, main + partner middle row, children bottom row
  const allGroups = [];
  if (parRow.length) allGroups.push({row:0, items:parRow.map(pr=>({id:pr.id,card:toCard(pr)}))});
  const midItems = [...siblings.map(s=>({id:s.id,card:toCard(s)})),
    {id:p.id,card:toCard(p,true)},
    ...partners.map(pt=>({id:pt.id,card:toCard(pt)}))];
  allGroups.push({row:1, items:midItems});
  if (children.length) allGroups.push({row:2, items:children.slice(0,6).map(c=>({id:c.id,card:toCard(c)}))});

  const maxPerRow = Math.max(...allGroups.map(g=>g.items.length));
  const totalW = Math.max(300, maxPerRow*(MW+MGAP)+MGAP);
  const totalH = allGroups.length * (MH+MGAPY) - MGAPY + 20;

  // Assign positions
  const pos = {};
  allGroups.forEach(grp => {
    const rowW = grp.items.length*(MW+MGAP)-MGAP;
    let x = (totalW-rowW)/2;
    grp.items.forEach(item => {
      pos[item.id] = {x, y: grp.row*(MH+MGAPY)+10};
      x += MW+MGAP;
    });
  });

  // Draw SVG paths
  let paths = '';
  // Parent â†’ main person
  parRow.forEach(pr => {
    const pp = pos[pr.id], cp = pos[p.id];
    if (!pp||!cp) return;
    const x1=pp.x+MW/2, y1=pp.y+MH, x2=cp.x+MW/2, y2=cp.y;
    const my=(y1+y2)/2;
    paths += `<path d="M ${x1} ${y1} C ${x1} ${my}, ${x2} ${my}, ${x2} ${y2}" fill="none" stroke="#c4a882" stroke-width="1.5" opacity=".7"/>`;
  });
  // Main â†’ children
  children.slice(0,6).forEach(c => {
    const pp=pos[p.id], cp=pos[c.id];
    if (!pp||!cp) return;
    const x1=pp.x+MW/2, y1=pp.y+MH, x2=cp.x+MW/2, y2=cp.y;
    const my=(y1+y2)/2;
    paths += `<path d="M ${x1} ${y1} C ${x1} ${my}, ${x2} ${my}, ${x2} ${y2}" fill="none" stroke="#c4a882" stroke-width="1.5" opacity=".7"/>`;
  });
  // Partner connector
  partners.forEach(pt => {
    const pp=pos[p.id], pp2=pos[pt.id];
    if (!pp||!pp2) return;
    const left=Math.min(pp.x,pp2.x)+MW, right=Math.max(pp.x,pp2.x);
    const y=pp.y+MH/2-5;
    paths += `<line x1="${left}" y1="${y}" x2="${right}" y2="${y}" stroke="#e8c4a0" stroke-width="2" stroke-dasharray="4,3"/>`;
  });

  // Build HTML
  let rowsHtml = '';
  allGroups.forEach(grp => {
    const y = grp.row*(MH+MGAPY)+10;
    const rowW = grp.items.length*(MW+MGAP)-MGAP;
    const startX = (totalW-rowW)/2;
    rowsHtml += `<div style="position:absolute;left:${startX}px;top:${y}px;display:flex;gap:${MGAP}px">
      ${grp.items.map(item=>item.card).join('')}
    </div>`;
  });

  wrap.innerHTML = `<div style="font-family:'Playfair Display',serif;font-size:15px;color:var(--amber-dark);margin:8px 20px 8px">ğŸŒ¿ Arbre familial</div>
    <div style="position:relative;width:${totalW}px;height:${totalH}px;margin:0 auto;overflow:visible">
      <svg style="position:absolute;top:0;left:0;pointer-events:none" width="${totalW}" height="${totalH}">${paths}</svg>
      ${rowsHtml}
    </div>`;
}

function viewDoc(i, pid) {
  const p=persons.find(x=>x.id===pid); if(!p||!p.docs) return;
  const doc=p.docs[i]; if(!doc) return;
  const win=window.open();
  if (doc.type&&doc.type.includes('pdf')) win.document.write(`<iframe src="${doc.data}" style="width:100%;height:100%;border:none"></iframe>`);
  else win.document.write(`<img src="${doc.data}" style="max-width:100%;display:block;margin:auto">`);
}

// ============================================================
// PIN / ADMIN
// ============================================================
function togglePin() {
  if (isUnlocked) { logout(); return; }
  document.getElementById('pinOv').classList.add('open');
  pinInput = '';
  updatePinDots();
}
function closePinOv() {
  document.getElementById('pinOv').classList.remove('open');
  pinInput=''; updatePinDots();
}
function pinKey(k) {
  if (k==='â†') { pinInput=pinInput.slice(0,-1); updatePinDots(); return; }
  if (pinInput.length>=4) return;
  pinInput+=k; updatePinDots();
  if (pinInput.length===4) {
    if (pinInput===PIN_CODE) {
      isUnlocked=true;
      document.getElementById('lockBtn').textContent='ğŸ”“';
      document.getElementById('lockBtn').classList.add('active');
      document.getElementById('adminPanel').style.display='flex';
      closePinOv();
      showToast('ğŸ”“ Administration activÃ©e');
    } else {
      document.getElementById('pinErr').textContent='Code incorrect âŒ';
      setTimeout(()=>{ pinInput=''; updatePinDots(); document.getElementById('pinErr').textContent=''; },1000);
    }
  }
}
function updatePinDots() {
  for (let i=0;i<4;i++) {
    const dot=document.getElementById('pd'+i);
    if (dot) dot.classList.toggle('filled',i<pinInput.length);
  }
}
function logout() {
  isUnlocked=false;
  document.getElementById('lockBtn').textContent='ğŸ”’';
  document.getElementById('lockBtn').classList.remove('active');
  document.getElementById('adminPanel').style.display='none';
  adminMenuOpen=false;
  document.getElementById('adminMenu').style.display='none';
  showToast('ğŸ”’ VerrouillÃ©');
}
function toggleAdminMenu() {
  adminMenuOpen=!adminMenuOpen;
  document.getElementById('adminMenu').style.display=adminMenuOpen?'flex':'none';
}

// ============================================================
// FORM
// ============================================================
const SKINS=['#FDBCB4','#F1C27D','#E0AC69','#C68642','#8D5524','#FFE0BD'];
const HCOLS=['#1a0a00','#4a2c11','#8B4513','#c07a2f','#D4A017','#708090','#f0f0f0'];
const HSTYL=['court','long','boucle','chignon','chauve','tresses'];
const HICON={'court':'ğŸ”¹','long':'ğŸ”»','boucle':'ğŸŒ€','chignon':'â¬†ï¸','chauve':'â—‹','tresses':'â‰¡'};

function initAvForm() {
  const av = formAv;
  // Skins
  document.getElementById('avSkins').innerHTML = SKINS.map(c=>`<div class="av-opt${av.skin===c?' sel':''}" style="background:${c};width:34px;height:34px" onclick="setAvSkin('${c}',this)"></div>`).join('');
  // Hair colors
  document.getElementById('avHairs').innerHTML = HCOLS.map(c=>`<div class="av-opt${av.hair===c?' sel':''}" style="background:${c};width:34px;height:34px" onclick="setAvHair('${c}',this)"></div>`).join('');
  // Styles
  document.getElementById('avStyles').innerHTML = HSTYL.map(s=>`<div class="av-opt${av.style===s?' sel':''}" style="background:var(--parchment);font-size:14px;width:36px;height:36px" onclick="setAvStyle('${s}',this)">${HICON[s]||s[0]}</div>`).join('');
}
function setAvSkin(c,el){formAv.skin=c;document.querySelectorAll('#avSkins .av-opt').forEach(x=>x.classList.remove('sel'));el.classList.add('sel');}
function setAvHair(c,el){formAv.hair=c;document.querySelectorAll('#avHairs .av-opt').forEach(x=>x.classList.remove('sel'));el.classList.add('sel');}
function setAvStyle(s,el){formAv.style=s;document.querySelectorAll('#avStyles .av-opt').forEach(x=>x.classList.remove('sel'));el.classList.add('sel');}

function openForm(id) {
  if (!isUnlocked) { showToast('ğŸ”’ Veuillez vous connecter'); return; }
  editingId=id; photoData=null; formPereId=null; formMereId=null; formPartnerIds=[]; formAv={skin:'#FDBCB4',hair:'#4a2c11',style:'court'}; formGenOffset=null; formDocs=[];
  document.getElementById('formTitle').textContent = id ? 'Modifier' : 'Ajouter une personne';
  document.getElementById('btnDelete').style.display = id ? 'block' : 'none';
  document.getElementById('phPrev').style.display = 'none';
  document.getElementById('phPrev').src = '';
  ['fPre','fNom','fNais','fDec','fLN','fLD','fBio','fAne'].forEach(i=>document.getElementById(i).value='');
  document.querySelectorAll('#branchPills .bpill').forEach(el=>el.classList.remove('active-Monsigny','active-Pillon','active-Bareau','active-Baranowski'));

  if (id) {
    const p = persons.find(x=>x.id===id); if(!p) return;
    document.getElementById('fPre').value=p.pre||'';
    document.getElementById('fNom').value=p.nom||'';
    document.getElementById('fNais').value=p.nais||'';
    document.getElementById('fDec').value=p.dec||'';
    document.getElementById('fLN').value=p.lieuN||'';
    document.getElementById('fLD').value=p.lieuD||'';
    document.getElementById('fBio').value=p.bio||'';
    document.getElementById('fAne').value=p.ane||'';
    if (p.photo&&p.photo.length>10) { photoData=p.photo; document.getElementById('phPrev').src=p.photo; document.getElementById('phPrev').style.display='block'; }
    formAv={...(p.av||{skin:'#FDBCB4',hair:'#4a2c11',style:'court'})};
    formPereId=p.pereId||null; formMereId=p.mereId||null;
    formPartnerIds=p.partnerIds?[...p.partnerIds]:[];
    formGenOffset=p.genOffset!==undefined?p.genOffset:null;
    formDocs=p.docs?[...p.docs]:[];
    (p.branches||[]).forEach(b=>{
      const pill=document.querySelector(`#branchPills [data-b="${b}"]`);
      if(pill){const key=b.split(' ')[0];pill.classList.add('active-'+key);}
    });
  }
  initAvForm(); updateParentBtns(); updatePartnerList(); updateGenOffsetDisplay(); renderDocList();
  openOv('formOv');
}

function toggleBranchPill(el) {
  const b=el.dataset.b, key=b.split(' ')[0];
  if (el.classList.contains('active-'+key)) el.classList.remove('active-'+key);
  else el.classList.add('active-'+key);
}

function getFormBranches() {
  return BRANCHES.filter(b=>{
    const key=b.split(' ')[0];
    const pill=document.querySelector(`#branchPills [data-b="${b}"]`);
    return pill&&pill.classList.contains('active-'+key);
  });
}

function updateParentBtns() {
  const pereEl=document.getElementById('pereBtnWrap'), mereEl=document.getElementById('mereBtnWrap');
  if (formPereId) {
    const pp=persons.find(x=>x.id===formPereId);
    pereEl.innerHTML=pp?`<div class="parent-btn" onclick="openPicker('pere')"><div class="parent-av">${personImgHtml(pp,32)}</div><div style="flex:1;font-size:14px">${pp.pre} ${pp.nom}</div><button type="button" onclick="event.stopPropagation();formPereId=null;updateParentBtns()" style="background:none;border:none;color:#c0392b;font-size:18px;cursor:pointer">âœ•</button></div>`:'<button type="button" class="btn-pick" onclick="openPicker(\'pere\')">+ Choisir le pÃ¨re</button>';
  } else pereEl.innerHTML='<button type="button" class="btn-pick" onclick="openPicker(\'pere\')">+ Choisir le pÃ¨re</button>';
  if (formMereId) {
    const mp=persons.find(x=>x.id===formMereId);
    mereEl.innerHTML=mp?`<div class="parent-btn" onclick="openPicker('mere')"><div class="parent-av">${personImgHtml(mp,32)}</div><div style="flex:1;font-size:14px">${mp.pre} ${mp.nom}</div><button type="button" onclick="event.stopPropagation();formMereId=null;updateParentBtns()" style="background:none;border:none;color:#c0392b;font-size:18px;cursor:pointer">âœ•</button></div>`:'<button type="button" class="btn-pick" onclick="openPicker(\'mere\')">+ Choisir la mÃ¨re</button>';
  } else mereEl.innerHTML='<button type="button" class="btn-pick" onclick="openPicker(\'mere\')">+ Choisir la mÃ¨re</button>';
}

function updatePartnerList() {
  const el=document.getElementById('partnerList'); if(!el) return;
  el.innerHTML=formPartnerIds.map(pid=>{
    const p=persons.find(x=>x.id===pid); if(!p) return '';
    return `<div style="display:flex;align-items:center;gap:8px;background:var(--white);border:2px solid var(--amber-light);border-radius:12px;padding:8px 12px">
      <div style="width:32px;height:32px;border-radius:50%;overflow:hidden;background:var(--parchment);display:flex;align-items:center;justify-content:center">${personImgHtml(p,32)}</div>
      <div style="flex:1;font-size:14px;font-family:'Playfair Display',serif">ğŸ’‘ ${p.pre} ${p.nom}</div>
      <button type="button" onclick="formPartnerIds=formPartnerIds.filter(i=>i!=='${pid}');updatePartnerList()" style="background:none;border:none;color:#c0392b;font-size:18px;cursor:pointer">âœ•</button>
    </div>`;
  }).join('');
}

let formGenOffsetVal = null;
function changeGenOffset(d){formGenOffset=(formGenOffset||0)+d;updateGenOffsetDisplay();}
function resetGenOffset(){formGenOffset=null;updateGenOffsetDisplay();}
function updateGenOffsetDisplay(){
  const el=document.getElementById('genOffsetDisplay'); if(!el) return;
  if(!formGenOffset){el.textContent='Automatique';el.style.color='var(--muted)';el.style.fontWeight='400';}
  else{const s=formGenOffset>0?'+':'';el.textContent=`${s}${formGenOffset} gÃ©nÃ©ration${Math.abs(formGenOffset)>1?'s':''}`;el.style.color='var(--amber-dark)';el.style.fontWeight='600';}
}

function setUnknown(fid){const el=document.getElementById(fid);el.value=el.value==='?'?'':'?';}

function handlePhoto(e){
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=ev=>{
    const img=new Image(); img.onload=()=>{
      const canvas=document.createElement('canvas');
      const MAX=300; let w=img.width,h=img.height;
      if(w>h){if(w>MAX){h=Math.round(h*MAX/w);w=MAX;}}
      else{if(h>MAX){w=Math.round(w*MAX/h);h=MAX;}}
      canvas.width=w;canvas.height=h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      photoData=canvas.toDataURL('image/jpeg',0.7);
      document.getElementById('phPrev').src=photoData;
      document.getElementById('phPrev').style.display='block';
    };
    img.src=ev.target.result;
  };
  reader.readAsDataURL(file);
}

function handleDoc(e){
  const file=e.target.files[0]; if(!file) return;
  if(file.size>2*1024*1024){showToast('âš ï¸ Max 2MB');return;}
  const reader=new FileReader();
  reader.onload=ev=>{
    formDocs.push({name:file.name,type:file.type,size:formatSize(file.size),data:ev.target.result});
    renderDocList(); document.getElementById('docIn').value=''; showToast('ğŸ“ Document ajoutÃ©');
  };
  reader.readAsDataURL(file);
}
function formatSize(b){if(b<1024)return b+'B';if(b<1048576)return(b/1024).toFixed(1)+'KB';return(b/1048576).toFixed(1)+'MB';}
function renderDocList(){
  const el=document.getElementById('docList'); if(!el) return;
  el.innerHTML=formDocs.map((doc,i)=>`<div class="doc-item">
    <div style="font-size:22px">${doc.type&&doc.type.includes('pdf')?'ğŸ“•':'ğŸ–¼ï¸'}</div>
    <div style="flex:1;min-width:0"><div style="font-size:13px;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${doc.name}</div><div style="font-size:11px;color:var(--muted)">${doc.size}</div></div>
    <button onclick="formDocs.splice(${i},1);renderDocList()" style="background:none;border:none;font-size:18px;cursor:pointer;color:#c0392b">ğŸ—‘ï¸</button>
  </div>`).join('');
}

function savePerson(){
  const pre=document.getElementById('fPre').value.trim();
  const nom=document.getElementById('fNom').value.trim();
  if(!pre){showToast('âš ï¸ PrÃ©nom requis');return;}
  const data={
    pre, nom,
    nais:document.getElementById('fNais').value.trim(),
    dec:document.getElementById('fDec').value.trim(),
    lieuN:document.getElementById('fLN').value.trim(),
    lieuD:document.getElementById('fLD').value.trim(),
    bio:document.getElementById('fBio').value.trim(),
    ane:document.getElementById('fAne').value.trim(),
    photo:photoData||'',
    branches:getFormBranches(),
    partnerIds:[...formPartnerIds],
    pereId:formPereId,
    mereId:formMereId,
    av:{...formAv},
    docs:[...formDocs],
  };
  if(formGenOffset!==null&&formGenOffset!==0) data.genOffset=formGenOffset;
  else data.genOffset=undefined;

  if(editingId){
    const idx=persons.findIndex(p=>p.id===editingId);
    persons[idx]={...persons[idx],...data};
    showToast('âœ… EnregistrÃ© !');
  } else {
    data.id='p'+Date.now();
    persons.push(data);
    showToast('ğŸ‰ Personne ajoutÃ©e !');
  }
  _genCache=null; saveData(); closeOv('formOv'); renderTree();
}

function confirmDelete(){
  const p=persons.find(x=>x.id===editingId); if(!p) return;
  document.getElementById('confirmTxt').textContent=`Supprimer ${p.pre} ${p.nom} ?`;
  document.getElementById('btnYes').onclick=()=>{
    persons=persons.filter(x=>x.id!==editingId).map(x=>({...x,
      pereId:x.pereId===editingId?null:x.pereId,
      mereId:x.mereId===editingId?null:x.mereId,
      partnerIds:(x.partnerIds||[]).filter(i=>i!==editingId)
    }));
    _genCache=null; saveData(); closeOv('confirmOv'); closeOv('formOv'); renderTree(); showToast('ğŸ—‘ï¸ SupprimÃ©');
  };
  closeOv('formOv'); setTimeout(()=>openOv('confirmOv'),200);
}

// ============================================================
// PICKER
// ============================================================
function openPicker(target){
  pickerTarget=target;
  document.getElementById('pickerTitle').textContent=target==='pere'?'Choisir le pÃ¨re':target==='mere'?'Choisir la mÃ¨re':'Choisir un(e) partenaire';
  document.getElementById('pickerQ').value='';
  renderPicker(); openOv('pickerOv');
}
function renderPicker(){
  const q=(document.getElementById('pickerQ').value||'').toLowerCase();
  const list=[...persons].filter(p=>!q||(p.pre+' '+p.nom).toLowerCase().includes(q)).sort((a,b)=>a.pre.localeCompare(b.pre,'fr'));
  document.getElementById('pickerList').innerHTML=list.map(p=>`<div class="picker-item" onclick="selectPerson('${p.id}')">
    <div class="picker-av">${personImgHtml(p,40)}</div>
    <div><div style="font-family:'Playfair Display',serif;font-size:15px;font-weight:600">${p.pre} ${p.nom}</div>
    <div style="font-size:12px;color:var(--muted)">${fmtYears(p)}</div></div>
  </div>`).join('')||'<div style="padding:24px;text-align:center;color:var(--muted)">Aucun rÃ©sultat</div>';
}
function selectPerson(id){
  if(pickerTarget==='partner'){
    if(!formPartnerIds.includes(id))formPartnerIds.push(id);
    closeOv('pickerOv'); updatePartnerList(); return;
  }
  if(pickerTarget==='pere') formPereId=id;
  else if(pickerTarget==='mere') formMereId=id;
  closeOv('pickerOv'); updateParentBtns();
}

// ============================================================
// BULK ASSIGN
// ============================================================
function openBulk(){
  if(!isUnlocked){showToast('ğŸ”’ Veuillez vous connecter');return;}
  bulkChanges={}; bulkFilter='';
  document.getElementById('bulkQ').value='';
  renderBulk(); openOv('bulkOv');
}
function setBulkF(f,el){
  bulkFilter=f;
  document.querySelectorAll('#bulkChips .bpill').forEach(x=>x.className='bpill');
  const key=f?f.split(' ')[0]:'Bareau';
  el.classList.add('active-'+key);
  renderBulk();
}
function renderBulk(){
  const q=(document.getElementById('bulkQ').value||'').toLowerCase();
  const noB=persons.filter(p=>(bulkChanges[p.id]||getBranches(p)).length===0).length;
  document.getElementById('bulkStats').textContent=`${persons.length} personnes Â· ${noB} sans branche`;
  let list=[...persons].filter(p=>!q||(p.pre+' '+p.nom).toLowerCase().includes(q));
  const getB=p=>bulkChanges[p.id]!==undefined?bulkChanges[p.id]:getBranches(p);
  if(bulkFilter==='none') list=list.filter(p=>getB(p).length===0);
  else if(bulkFilter) list=list.filter(p=>getB(p).includes(bulkFilter));
  list.sort((a,b)=>a.pre.localeCompare(b.pre,'fr'));
  document.getElementById('bulkList').innerHTML=list.map(p=>{
    const curB=getB(p);
    return `<div class="bulk-row">
      <div style="width:36px;height:36px;border-radius:50%;overflow:hidden;background:var(--parchment);display:flex;align-items:center;justify-content:center;flex-shrink:0">${personImgHtml(p,36)}</div>
      <div style="flex:1;min-width:0"><div style="font-size:14px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${p.pre} ${p.nom}</div><div style="font-size:11px;color:var(--muted)">${fmtYears(p)}</div></div>
      <div style="display:flex;flex-wrap:wrap;gap:4px">
        ${BRANCHES.map(b=>{const k=b.split(' ')[0];const lb=b==='Baranowski de Rawiez'?'Baran.':b;const a=curB.includes(b);return`<span class="bpill${a?' active-'+k:''}" onclick="toggleBulk('${p.id}','${b}',this)">${lb}</span>`}).join('')}
      </div>
    </div>`;
  }).join('')||'<div style="padding:24px;text-align:center;color:var(--muted)">Aucun rÃ©sultat</div>';
}
function toggleBulk(pid,branch,el){
  const p=persons.find(x=>x.id===pid);
  let cur=bulkChanges[pid]!==undefined?[...bulkChanges[pid]]:[...getBranches(p)];
  if(cur.includes(branch))cur=cur.filter(b=>b!==branch);else cur.push(branch);
  bulkChanges[pid]=cur;
  const key=branch.split(' ')[0];
  el.className='bpill'+(cur.includes(branch)?' active-'+key:'');
}
function saveBulk(){
  const count=Object.keys(bulkChanges).length;
  if(!count){showToast('â„¹ï¸ Aucune modification');return;}
  persons=persons.map(p=>bulkChanges[p.id]!==undefined?{...p,branches:bulkChanges[p.id]}:p);
  _genCache=null; saveData(); renderTree();
  showToast(`âœ… ${count} personne${count>1?'s':''} mise${count>1?'s':''} Ã  jour !`);
  closeOv('bulkOv');
}

// ============================================================
// OVERLAY UTILS
// ============================================================
function openOv(id){document.getElementById(id).classList.add('open')}
function closeOv(id){document.getElementById(id).classList.remove('open')}
function showToast(msg,dur){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),dur||2500);
}

// ============================================================
// GEDCOM IMPORT
// ============================================================
function openGedcom(){
  if(!isUnlocked){showToast('ğŸ”’ Veuillez vous connecter');return;}
  gedReset(); openOv('gedcomOv');
}
function gedReset(){
  gedAllPersons=[]; gedSelected=new Set();
  document.getElementById('gedStep1').style.display='block';
  document.getElementById('gedStep2').style.display='none';
  document.getElementById('gedFile').value='';
}
function parseGedcomFile(e){
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=ev=>{
    try{
      gedAllPersons=parseGedcomText(ev.target.result);
      const sel=document.getElementById('gedRootSelect');
      sel.innerHTML='<option value="">â€” Choisir â€”</option>'+
        [...gedAllPersons].sort((a,b)=>a.pre.localeCompare(b.pre,'fr'))
          .map(p=>`<option value="${p.id}">${p.pre} ${p.nom}${p.nais?' ('+p.nais+')':''}</option>`).join('');
      document.getElementById('gedSummary').innerHTML=`<div style="font-size:36px;margin-bottom:6px">ğŸ‰</div><div style="font-family:'Playfair Display',serif;font-size:18px;color:var(--brown)">${gedAllPersons.length} personnes trouvÃ©es</div>`;
      document.getElementById('gedStep1').style.display='none';
      document.getElementById('gedStep2').style.display='block';
      updateGedPreview();
    }catch(err){showToast('âŒ Erreur: '+err.message);}
  };
  reader.readAsText(file,'UTF-8');
}
function filterGedRoot(){
  const q=document.getElementById('gedRootSearch').value.toLowerCase();
  const sel=document.getElementById('gedRootSelect');
  [...sel.options].forEach(opt=>{opt.style.display=(!q||opt.textContent.toLowerCase().includes(q))?'':'none';});
}
function getGedAncestors(id,result,rem,includeSpouses){
  if(!id||result.has(id))return;
  result.add(id);
  const p=gedAllPersons.find(x=>x.id===id); if(!p)return;
  if(includeSpouses) (p.partnerIds||[]).forEach(pid=>result.add(pid));
  if(rem===0) return;
  const next = (rem===null) ? null : Math.max(0, rem-1);
  if(p.pereId)getGedAncestors(p.pereId,result,next,includeSpouses);
  if(p.mereId)getGedAncestors(p.mereId,result,next,includeSpouses);
}
function getGedDescendants(id,result,rem,includeSpouses){
  if(!id||result.has(id))return;
  result.add(id);
  const p=gedAllPersons.find(x=>x.id===id);
  if(p && includeSpouses) (p.partnerIds||[]).forEach(pid=>result.add(pid));
  if(rem===0) return;
  const next = (rem===null) ? null : Math.max(0, rem-1);
  gedAllPersons.filter(x=>x.pereId===id||x.mereId===id).forEach(c=>getGedDescendants(c.id,result,next,includeSpouses));
}
function updateGedPreview(){
  const mode=document.querySelector('input[name="gedMode"]:checked').value;
  const rootId=document.getElementById('gedRootSelect').value;
  const ancDepth=parseInt(document.getElementById('gedAncDepth')?.value||'0',10);
  const descDepth=parseInt(document.getElementById('gedDescDepth')?.value||'0',10);
  const includeSpouses=!!document.getElementById('gedIncludeSpouses')?.checked;
  const ancRem = ancDepth===0 ? null : ancDepth;
  const descRem = descDepth===0 ? null : descDepth;

  let filtered=new Set();
  if(mode==='all')gedAllPersons.forEach(p=>filtered.add(p.id));
  else if(mode==='ancestors'){
    if(rootId){getGedAncestors(rootId,filtered,ancRem,includeSpouses);filtered.add(rootId);}
  }
  else if(mode==='descendants'){
    if(rootId)getGedDescendants(rootId,filtered,descRem,includeSpouses);
  }
  else if(mode==='both'){
    if(rootId){
      getGedAncestors(rootId,filtered,ancRem,includeSpouses);
      getGedDescendants(rootId,filtered,descRem,includeSpouses);
      filtered.add(rootId);
    }
  }
  else if(mode==='manual')filtered=new Set(gedSelected);

  if(mode!=='manual')gedSelected=new Set(filtered);
  document.getElementById('gedSelCount').textContent=gedSelected.size;
  const sq=document.getElementById('gedPersonSearch'); if(sq)sq.value='';
  renderGedList();
}
function renderGedList(){
  const q=(document.getElementById('gedPersonSearch')||{value:''}).value.toLowerCase();
  const mode=document.querySelector('input[name="gedMode"]:checked').value;
  const filtered=q?gedAllPersons.filter(p=>(p.pre+' '+p.nom).toLowerCase().includes(q)):gedAllPersons;
  document.getElementById('gedPreview').innerHTML=filtered.map(p=>`<div style="display:flex;align-items:center;gap:10px;padding:8px 6px;border-bottom:1px solid var(--parchment);${gedSelected.has(p.id)?'':'opacity:.4'}">
    <input type="checkbox" ${gedSelected.has(p.id)?'checked':''} onchange="toggleGedPerson('${p.id}',this)" style="width:20px;height:20px;accent-color:var(--amber);flex-shrink:0">
    <div style="flex:1;min-width:0">
      <div style="font-family:'Playfair Display',serif;font-size:14px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${p.pre} ${p.nom}</div>
      <div style="font-size:12px;color:var(--muted)">${fmtYears(p)}${p.pereId||p.mereId?' Â· ğŸ”—':''}</div>
    </div>
  </div>`).join('')||'<div style="padding:20px;text-align:center;color:var(--muted)">Aucun rÃ©sultat</div>';
}
function toggleGedPerson(id,cb){
  if(cb.checked)gedSelected.add(id);else gedSelected.delete(id);
  document.getElementById('gedSelCount').textContent=gedSelected.size;
  renderGedList();
}
function gedImport(){
  const toImport=gedAllPersons.filter(p=>gedSelected.has(p.id));
  if(!toImport.length){showToast('âš ï¸ Aucune personne sÃ©lectionnÃ©e');return;}
  let added=0,skipped=0;
  const lastIds=[];
  toImport.forEach(np=>{
    const exists=persons.find(e=>e.pre===np.pre&&e.nom===np.nom&&e.nais===np.nais);
    if(!exists){persons.push(np);lastIds.push(np.id);added++;}else skipped++;
  });
  try{localStorage.setItem('lastGedImport',JSON.stringify(lastIds));}catch{}
  _genCache=null; saveData(); renderTree();
  closeOv('gedcomOv');
  showToast(`ğŸ‰ ${added} importÃ©es !${skipped?' ('+skipped+' doublons)':''}`,4000);
}
function undoLastImport(){
  let lastIds=[];
  try{lastIds=JSON.parse(localStorage.getItem('lastGedImport')||'[]');}catch{}
  if(!lastIds.length){showToast('â„¹ï¸ Aucun import rÃ©cent');return;}
  const lastSet=new Set(lastIds);
  const count=persons.filter(p=>lastSet.has(p.id)).length;
  if(!count){showToast('â„¹ï¸ DÃ©jÃ  supprimÃ©es');return;}
  document.getElementById('confirmTxt').textContent=`Annuler le dernier import : ${count} personne(s).`;
  document.getElementById('btnYes').onclick=()=>{
    persons=persons.filter(p=>!lastSet.has(p.id)).map(p=>({...p,pereId:lastSet.has(p.pereId)?null:p.pereId,mereId:lastSet.has(p.mereId)?null:p.mereId,partnerIds:(p.partnerIds||[]).filter(i=>!lastSet.has(i))}));
    localStorage.removeItem('lastGedImport');
    _genCache=null;saveData();renderTree();closeOv('confirmOv');closeOv('gedcomOv');showToast(`â†©ï¸ ${count} annulÃ©es`);
  };
  closeOv('gedcomOv'); setTimeout(()=>openOv('confirmOv'),200);
}
function deleteGedcomPersons(){
  const gedCount=persons.filter(p=>p.id.startsWith('ged_')).length;
  if(!gedCount){showToast('â„¹ï¸ Aucune personne GEDCOM');return;}
  document.getElementById('confirmTxt').textContent=`Supprimer ${gedCount} personne(s) GEDCOM ?`;
  document.getElementById('btnYes').onclick=()=>{
    const gedIds=new Set(persons.filter(p=>p.id.startsWith('ged_')).map(p=>p.id));
    persons=persons.filter(p=>!gedIds.has(p.id)).map(p=>({...p,pereId:gedIds.has(p.pereId)?null:p.pereId,mereId:gedIds.has(p.mereId)?null:p.mereId,partnerIds:(p.partnerIds||[]).filter(i=>!gedIds.has(i))}));
    localStorage.removeItem('lastGedImport');
    _genCache=null;saveData();renderTree();closeOv('confirmOv');closeOv('gedcomOv');showToast(`ğŸ—‘ï¸ ${gedCount} supprimÃ©es`);
  };
  closeOv('gedcomOv'); setTimeout(()=>openOv('confirmOv'),200);
}
function parseGedcomText(text){
  const lines=text.split(/\r?\n/);
  const indiMap={},famMap={};
  let cur=null,curType=null,curTag=null;
  for(let line of lines){
    line=line.trim();if(!line)continue;
    const m=line.match(/^(\d+)\s+(\S+)(?:\s+(.*))?$/);if(!m)continue;
    const level=parseInt(m[1]),tag=m[2],val=m[3]||'';
    if(level===0){
      curTag=null;
      if(tag.startsWith('@')&&val==='INDI'){curType='INDI';cur={id:tag.replace(/@/g,''),events:{}};indiMap[cur.id]=cur;}
      else if(tag.startsWith('@')&&val==='FAM'){curType='FAM';cur={id:tag.replace(/@/g,''),children:[]};famMap[cur.id]=cur;}
      else{cur=null;curType=null;}
      continue;
    }
    if(!cur)continue;
    if(curType==='INDI'){
      if(level===1&&tag==='NAME'){const sn=val.match(/\/([^/]*)\//);cur.nom=sn?sn[1].trim():val.split(' ').pop();cur.pre=sn?val.replace(/\/[^/]*\//,'').replace(/\//g,'').trim():val.split(' ').slice(0,-1).join(' ');if(!cur.pre)cur.pre=val.replace(/\//g,'').trim();}
      if(level===1&&tag==='SEX')cur.sex=val;
      if(level===1&&(tag==='BIRT'||tag==='DEAT')){curTag=tag;if(!cur.events[curTag])cur.events[curTag]={};}
      if(level===2&&curTag){if(tag==='DATE')cur.events[curTag].date=val;if(tag==='PLAC')cur.events[curTag].plac=val;}
      if(level===1&&tag!=='BIRT'&&tag!=='DEAT')curTag=null;
      if(level===1&&tag==='FAMS')cur.fams=(cur.fams||[]).concat(val.replace(/@/g,''));
      if(level===1&&tag==='FAMC')cur.famc=(cur.famc||[]).concat(val.replace(/@/g,''));
    }
    if(curType==='FAM'){
      if(level===1&&tag==='HUSB')cur.husb=val.replace(/@/g,'');
      if(level===1&&tag==='WIFE')cur.wife=val.replace(/@/g,'');
      if(level===1&&tag==='CHIL')cur.children.push(val.replace(/@/g,''));
    }
  }
  const idMap={};
  const result=Object.values(indiMap).map(p=>{
    const nid='ged_'+p.id.replace(/[^a-zA-Z0-9]/g,'_');
    idMap[p.id]=nid;
    const b=p.events['BIRT']||{},d=p.events['DEAT']||{};
    return{id:nid,pre:p.pre||'?',nom:p.nom||'',nais:fmtGedDate(b.date||''),dec:fmtGedDate(d.date||''),lieuN:b.plac||'',lieuD:d.plac||'',bio:'',ane:'',photo:'',branches:[],partnerIds:[],pereId:null,mereId:null,av:{skin:'#FDBCB4',hair:'#4a2c11',style:p.sex==='F'?'long':'court'},docs:[]};
  });
  Object.values(famMap).forEach(fam=>{
    const hn=fam.husb?idMap[fam.husb]:null,wn=fam.wife?idMap[fam.wife]:null;
    if(hn&&wn){const h=result.find(x=>x.id===hn),w=result.find(x=>x.id===wn);if(h&&!h.partnerIds.includes(wn))h.partnerIds.push(wn);if(w&&!w.partnerIds.includes(hn))w.partnerIds.push(hn);}
    fam.children.forEach(cg=>{const cn=idMap[cg],c=result.find(x=>x.id===cn);if(c){if(hn&&!c.pereId)c.pereId=hn;if(wn&&!c.mereId)c.mereId=wn;}});
  });
  return result;
}
function fmtGedDate(d){
  if(!d)return'';
  const mo={JAN:'01',FEB:'02',MAR:'03',APR:'04',MAY:'05',JUN:'06',JUL:'07',AUG:'08',SEP:'09',OCT:'10',NOV:'11',DEC:'12'};
  const m=d.match(/(\d{1,2})\s+([A-Z]{3})\s+(\d{4})/);
  if(m)return m[1].padStart(2,'0')+'.'+(mo[m[2]]||'??')+'.'+m[3];
  const y=d.match(/(\d{4})/);return y?y[1]:d;
}

// ============================================================
// TOUCH: close detail on backdrop tap
// ============================================================
document.getElementById('treeWrap').addEventListener('click', e => {
  if (!e.target.closest('.pnode')) closeDetail();
});

// Close admin menu when tapping elsewhere
document.addEventListener('click', e => {
  if (adminMenuOpen && !e.target.closest('#adminPanel')) {
    adminMenuOpen=false;
    document.getElementById('adminMenu').style.display='none';
  }
});

// ============================================================
// INIT
// ============================================================
window.addEventListener('load', loadData);
</script>
</body>
</html>
