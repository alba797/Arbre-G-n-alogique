<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Arbre G√©n√©alogique</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Lora:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --cream:#fdf6ed; --parchment:#f5e9d3; --amber:#c07a2f;
  --amber-dark:#8b5320; --amber-light:#e8a455; --brown:#4a2c11;
  --text:#2d1a0a; --text-muted:#7a5c3d; --white:#fff;
  --shadow:0 4px 20px rgba(74,44,17,.15); --radius:16px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Lora',Georgia,serif;background:var(--cream);color:var(--text);min-height:100vh;font-size:17px}

/* HEADER */
header{background:linear-gradient(135deg,var(--brown),var(--amber-dark));padding:20px 20px 16px;position:sticky;top:0;z-index:100;box-shadow:0 2px 16px rgba(0,0,0,.3)}
.header-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.header-title{font-family:'Playfair Display',serif;color:var(--cream);font-size:24px;font-weight:700}
.header-sub{font-size:13px;color:var(--amber-light);font-style:italic}
.btn-add{background:var(--amber-light);color:var(--brown);border:none;border-radius:50px;padding:10px 20px;font-size:15px;font-weight:600;font-family:'Lora',serif;cursor:pointer;white-space:nowrap}
.search-wrap{display:flex;align-items:center;background:rgba(255,255,255,.15);border:1.5px solid rgba(255,255,255,.3);border-radius:50px;padding:8px 16px;gap:8px}
.search-wrap input{background:transparent;border:none;outline:none;color:var(--cream);font-size:16px;font-family:'Lora',serif;flex:1;min-width:0}
.search-wrap input::placeholder{color:rgba(253,246,237,.6)}

/* SORT */
.sort-bar{padding:12px 16px 4px;display:flex;gap:8px;align-items:center;overflow-x:auto;scrollbar-width:none}
.sort-bar::-webkit-scrollbar{display:none}
.sort-label{font-size:13px;color:var(--text-muted);white-space:nowrap}
.chip{background:var(--white);border:2px solid var(--parchment);border-radius:50px;padding:6px 14px;font-size:13px;font-family:'Lora',serif;color:var(--text-muted);cursor:pointer;white-space:nowrap}
.chip.active{background:var(--amber);border-color:var(--amber);color:var(--white);font-weight:600}

.stats-bar{padding:6px 16px 12px;color:var(--text-muted);font-size:13px;font-style:italic}

/* GRID */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:14px;padding:0 14px 110px}
.card{background:var(--white);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;cursor:pointer;animation:fadeIn .3s ease both}
.card:active{transform:scale(.97)}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.card-photo{width:100%;aspect-ratio:1;background:var(--parchment);display:flex;align-items:center;justify-content:center;font-size:52px;overflow:hidden}
.card-photo img{width:100%;height:100%;object-fit:cover}
.card-info{padding:10px 12px 12px}
.card-name{font-family:'Playfair Display',serif;font-size:15px;font-weight:600;line-height:1.3;margin-bottom:3px}
.card-years{font-size:12px;color:var(--text-muted);font-style:italic}
.card-gen{display:inline-block;margin-top:5px;background:var(--parchment);color:var(--amber-dark);font-size:11px;padding:2px 8px;border-radius:50px}

.fab{position:fixed;bottom:24px;right:20px;background:linear-gradient(135deg,var(--amber),var(--amber-dark));color:var(--white);border:none;border-radius:50px;padding:16px 24px;font-size:16px;font-family:'Lora',serif;font-weight:600;box-shadow:0 6px 24px rgba(192,122,47,.45);cursor:pointer;z-index:90}

.empty{text-align:center;padding:60px 30px;color:var(--text-muted);grid-column:1/-1}
.empty-icon{font-size:64px;margin-bottom:16px}
.empty-title{font-family:'Playfair Display',serif;font-size:22px;color:var(--brown);margin-bottom:8px}

/* OVERLAYS */
.overlay{position:fixed;inset:0;background:rgba(45,26,10,.65);z-index:200;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s}
.overlay.open{opacity:1;pointer-events:all}
.overlay-center{align-items:center}
.sheet{background:var(--cream);border-radius:24px 24px 0 0;width:100%;max-width:600px;max-height:92vh;overflow-y:auto;transform:translateY(100%);transition:transform .35s cubic-bezier(.32,.72,0,1);padding-bottom:40px}
.overlay.open .sheet{transform:translateY(0)}
.handle{width:44px;height:5px;background:var(--parchment);border-radius:3px;margin:12px auto 0}

/* DETAIL */
.dp-wrap{position:relative}
.dp{width:100%;height:240px;background:var(--parchment);display:flex;align-items:center;justify-content:center;font-size:90px;margin-top:12px;overflow:hidden}
.dp img{width:100%;height:100%;object-fit:cover}
.btn-x{position:absolute;top:16px;right:16px;background:rgba(255,255,255,.9);border:none;border-radius:50%;width:38px;height:38px;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:10}
.db{padding:20px 24px}
.d-name{font-family:'Playfair Display',serif;font-size:28px;font-weight:700;color:var(--brown);margin-bottom:4px}
.d-dates{font-size:15px;color:var(--text-muted);font-style:italic;margin-bottom:14px}
.sec-title{font-family:'Playfair Display',serif;font-size:16px;color:var(--amber-dark);margin:16px 0 10px;border-bottom:1.5px solid var(--parchment);padding-bottom:4px}
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:4px}
.ii{background:var(--white);border-radius:12px;padding:12px 14px}
.il{font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px}
.iv{font-size:15px;font-weight:500}
.bio{font-size:15px;line-height:1.75;white-space:pre-line;margin-bottom:4px}
.d-actions{display:flex;gap:12px;margin-top:16px}
.btn-edit{flex:1;background:var(--amber);color:var(--white);border:none;border-radius:14px;padding:15px;font-size:16px;font-family:'Lora',serif;font-weight:600;cursor:pointer}
.btn-del{background:var(--white);color:#c0392b;border:2px solid #fadbd8;border-radius:14px;padding:15px 18px;font-size:16px;font-family:'Lora',serif;cursor:pointer}

/* PERSON LINKS in detail */
.plink{display:flex;align-items:center;gap:12px;background:var(--white);border-radius:14px;padding:10px 14px;cursor:pointer;margin-bottom:8px;transition:background .2s}
.plink:active{background:var(--parchment)}
.pl-av{width:46px;height:46px;border-radius:50%;background:var(--parchment);display:flex;align-items:center;justify-content:center;font-size:24px;overflow:hidden;flex-shrink:0}
.pl-av img{width:100%;height:100%;object-fit:cover}
.pl-name{font-family:'Playfair Display',serif;font-size:15px;font-weight:600}
.pl-years{font-size:12px;color:var(--text-muted);font-style:italic}
.pl-arr{margin-left:auto;color:var(--amber);font-size:22px}

/* FORM */
.fh{background:linear-gradient(135deg,var(--brown),var(--amber-dark));padding:20px 24px;color:var(--cream);border-radius:24px 24px 0 0;display:flex;align-items:center;justify-content:space-between}
.f-title{font-family:'Playfair Display',serif;font-size:22px;font-weight:700}
.btn-xw{background:rgba(255,255,255,.2);border:none;border-radius:50%;width:36px;height:36px;color:white;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.fb{padding:20px 24px}
.fg{margin-bottom:18px}
.fl{display:block;font-size:13px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.fi,.fta,.fsel{width:100%;background:var(--white);border:2px solid var(--parchment);border-radius:12px;padding:13px 16px;font-size:16px;font-family:'Lora',serif;color:var(--text);outline:none;-webkit-appearance:none}
.fi:focus,.fta:focus,.fsel:focus{border-color:var(--amber)}
.fta{min-height:120px;resize:vertical;line-height:1.6}
.f2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.photo-up{border:2.5px dashed var(--amber-light);border-radius:16px;padding:24px;text-align:center;cursor:pointer;background:var(--white)}
.ph-prev{width:100%;max-height:200px;object-fit:cover;border-radius:12px;margin-top:12px}
.btn-save{width:100%;background:linear-gradient(135deg,var(--amber),var(--amber-dark));color:var(--white);border:none;border-radius:16px;padding:18px;font-size:18px;font-family:'Lora',serif;font-weight:700;cursor:pointer;margin-top:8px;box-shadow:0 4px 16px rgba(192,122,47,.4)}

/* PARENT PICKER in form */
.parent-row{display:flex;align-items:center;gap:10px;background:var(--white);border-radius:12px;padding:10px 14px;margin-bottom:8px}
.btn-pick-parent{flex:1;background:var(--parchment);border:2px dashed var(--amber-light);border-radius:12px;padding:12px;font-size:15px;font-family:'Lora',serif;color:var(--text-muted);cursor:pointer;text-align:left}
.btn-pick-parent.chosen{background:var(--white);border:2px solid var(--amber);color:var(--text)}
.btn-clear-p{background:none;border:none;color:#c0392b;font-size:20px;cursor:pointer}

/* PICKER SHEET */
.picker-sheet{background:var(--white);border-radius:24px 24px 0 0;width:100%;max-width:600px;max-height:70vh;overflow-y:auto;transform:translateY(100%);transition:transform .35s cubic-bezier(.32,.72,0,1)}
.overlay.open .picker-sheet{transform:translateY(0)}
.picker-header{padding:16px 20px;border-bottom:1.5px solid var(--parchment);display:flex;align-items:center;gap:12px}
.picker-title{font-family:'Playfair Display',serif;font-size:18px;color:var(--brown);flex:1}
.picker-search{flex:2;background:var(--parchment);border:none;border-radius:50px;padding:8px 14px;font-size:15px;font-family:'Lora',serif;outline:none}
.picker-list{padding:12px 16px 40px}
.picker-item{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:12px;cursor:pointer;margin-bottom:6px}
.picker-item:active{background:var(--parchment)}
.picker-av{width:40px;height:40px;border-radius:50%;background:var(--parchment);display:flex;align-items:center;justify-content:center;font-size:22px;overflow:hidden;flex-shrink:0}
.picker-av img{width:100%;height:100%;object-fit:cover}

/* CONFIRM */
.cbox{background:var(--white);border-radius:24px;padding:32px 28px;margin:20px;max-width:380px;width:calc(100% - 40px);text-align:center;transform:scale(.9);transition:transform .3s}
.overlay.open .cbox{transform:scale(1)}
.c-title{font-family:'Playfair Display',serif;font-size:22px;color:var(--brown);margin:12px 0 8px}
.c-text{font-size:15px;color:var(--text-muted);margin-bottom:24px;line-height:1.6}
.c-btns{display:flex;gap:12px}
.btn-cy{flex:1;background:#c0392b;color:#fff;border:none;border-radius:14px;padding:14px;font-size:16px;font-family:'Lora',serif;cursor:pointer}
.btn-cn{flex:1;background:var(--parchment);color:var(--text);border:none;border-radius:14px;padding:14px;font-size:16px;font-family:'Lora',serif;cursor:pointer}

.map-link{color:var(--amber);text-decoration:none;font-weight:600}
.map-link:hover{text-decoration:underline}
.toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--brown);color:var(--cream);padding:12px 24px;border-radius:50px;font-size:15px;opacity:0;pointer-events:none;transition:all .3s;white-space:nowrap;z-index:999}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
</style>
</head>
<body>

<header>
  <div class="header-top">
    <div>
      <div class="header-title">üå≥ Arbre G√©n√©alogique</div>
      <div class="header-sub" id="subTitle">Famille</div>
    </div>
    <button class="btn-add" onclick="openForm(null)">+ Ajouter</button>
  </div>
  <div class="search-wrap">
    <span style="color:var(--amber-light)">üîç</span>
    <input type="search" id="searchInput" placeholder="Rechercher..." oninput="renderCards()" autocomplete="off">
  </div>
</header>

<div class="sort-bar">
  <span class="sort-label">Trier par :</span>
  <div class="chip active" onclick="setSort('prenom',this)">Pr√©nom A‚ÄìZ</div>
  <div class="chip" onclick="setSort('nom',this)">Nom A‚ÄìZ</div>
  <div class="chip" onclick="setSort('naissance',this)">Date de naissance</div>
</div>

<div class="stats-bar" id="statsBar"></div>
<div class="grid" id="grid"></div>
<button class="fab" onclick="openForm(null)">+ Ajouter une personne</button>

<!-- DETAIL -->
<div class="overlay" id="detailOverlay" onclick="closeOverlay('detailOverlay')">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="handle"></div>
    <div class="dp-wrap">
      <div class="dp" id="dPhoto"></div>
      <button class="btn-x" onclick="closeOverlay('detailOverlay')">‚úï</button>
    </div>
    <div class="db">
      <div class="d-name" id="dName"></div>
      <div class="d-dates" id="dDates"></div>
      <div id="dInfoGrid" class="info-grid"></div>
      <div id="dBio"></div>
      <div id="dParents"></div>
      <div id="dChildren"></div>
      <div id="dPartners"></div>
      <div class="d-actions">
        <button class="btn-edit" id="btnEdit">‚úèÔ∏è Modifier</button>
        <button class="btn-del" id="btnDel">üóëÔ∏è</button>
      </div>
    </div>
  </div>
</div>

<!-- FORM -->
<div class="overlay" id="formOverlay" onclick="closeOverlay('formOverlay')">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="fh">
      <div class="f-title" id="formTitle">Ajouter une personne</div>
      <button class="btn-xw" onclick="closeOverlay('formOverlay')">‚úï</button>
    </div>
    <div class="fb">
      <!-- Photo -->
      <div class="fg">
        <label class="fl">üì∑ Photo</label>
        <div class="photo-up" onclick="document.getElementById('photoInput').click()">
          <div style="font-size:38px;color:var(--amber)">üì∏</div>
          <div style="font-size:14px;color:var(--text-muted);margin-top:6px">Choisir depuis la galerie</div>
          <img id="photoPreview" class="ph-prev" style="display:none">
        </div>
        <input type="file" id="photoInput" accept="image/*" style="display:none" onchange="handlePhoto(event)">
      </div>
      <!-- Name -->
      <div class="f2">
        <div class="fg"><label class="fl">Pr√©nom(s) *</label><input class="fi" id="fPrenom" placeholder="ex. Marie"></div>
        <div class="fg"><label class="fl">Nom</label><input class="fi" id="fNom" placeholder="ex. Dupont"></div>
      </div>
      <!-- Dates -->
      <div class="f2">
        <div class="fg"><label class="fl">üéÇ N√©(e) le</label><input class="fi" id="fNaissance" placeholder="JJ.MM.AAAA"></div>
        <div class="fg"><label class="fl">‚úù D√©c√©d√©(e) le</label><input class="fi" id="fDeces" placeholder="JJ.MM.AAAA"></div>
      </div>
      <!-- Lieux -->
      <div class="f2">
        <div class="fg"><label class="fl">üìç Lieu de naissance</label><input class="fi" id="fLieuN" placeholder="ex. Paris"></div>
        <div class="fg"><label class="fl">üìç Lieu de d√©c√®s</label><input class="fi" id="fLieuD" placeholder="ex. Lyon"></div>
      </div>

      <!-- PARENTS -->
      <div class="fg">
        <label class="fl">üë® P√®re</label>
        <div style="display:flex;align-items:center;gap:8px">
          <button type="button" class="btn-pick-parent" id="btnPickPere" onclick="openPicker('pere')">‚Äî Choisir le p√®re ‚Äî</button>
          <button type="button" class="btn-clear-p" id="btnClearPere" onclick="clearParent('pere')" style="display:none">‚úï</button>
        </div>
      </div>
      <div class="fg">
        <label class="fl">üë© M√®re</label>
        <div style="display:flex;align-items:center;gap:8px">
          <button type="button" class="btn-pick-parent" id="btnPickMere" onclick="openPicker('mere')">‚Äî Choisir la m√®re ‚Äî</button>
          <button type="button" class="btn-clear-p" id="btnClearMere" onclick="clearParent('mere')" style="display:none">‚úï</button>
        </div>
      </div>

      <!-- Bio / Anecdotes -->
      <div class="fg"><label class="fl">üìñ Biographie</label><textarea class="fta" id="fBio" placeholder="Souvenirs, histoire de vie..."></textarea></div>
      <div class="fg"><label class="fl">‚ú® Anecdotes</label><textarea class="fta" id="fAnecdotes" placeholder="Petites histoires, moments dr√¥les..."></textarea></div>

      <button class="btn-save" onclick="savePerson()">üíæ Enregistrer</button>
    </div>
  </div>
</div>

<!-- PARENT PICKER -->
<div class="overlay" id="pickerOverlay" onclick="closeOverlay('pickerOverlay')">
  <div class="picker-sheet" onclick="event.stopPropagation()">
    <div class="picker-header">
      <div class="picker-title" id="pickerTitle">Choisir</div>
      <input class="picker-search" id="pickerSearch" type="text" placeholder="üîç Rechercher..." oninput="renderPickerList()">
      <button class="btn-xw" style="background:var(--parchment);color:var(--text)" onclick="closeOverlay('pickerOverlay')">‚úï</button>
    </div>
    <div class="picker-list" id="pickerList"></div>
  </div>
</div>

<!-- CONFIRM -->
<div class="overlay overlay-center" id="confirmOverlay">
  <div class="cbox">
    <div style="font-size:48px">‚ö†Ô∏è</div>
    <div class="c-title">Supprimer ?</div>
    <div class="c-text" id="confirmText"></div>
    <div class="c-btns">
      <button class="btn-cn" onclick="closeOverlay('confirmOverlay')">Annuler</button>
      <button class="btn-cy" id="btnConfirmYes">Supprimer</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============================================================
// DATA
// ============================================================
let persons = [];
let sortMode = 'prenom';
let editingId = null;
let photoData = null;
let pickerTarget = null; // 'pere' | 'mere'
let formPereId = null;
let formMereId = null;

const KEY = 'arbre-v3';

async function loadData() {
  try {
    const r = await window.storage.get(KEY);
    if (r && r.value) persons = JSON.parse(r.value);
    else persons = initDemo();
  } catch {
    try { const l = localStorage.getItem(KEY); persons = l ? JSON.parse(l) : initDemo(); } catch { persons = initDemo(); }
  }
  updateSubtitle();
  renderCards();
}

async function saveData() {
  const j = JSON.stringify(persons);
  try { await window.storage.set(KEY, j); } catch {}
  try { localStorage.setItem(KEY, j); } catch {}
}

function initDemo() {
  // Donn√©es import√©es depuis ton Google Sheets
  return [
    { id:'2', prenom:'Herv√© Gilles', nom:'Bareau',    naissance:'20.12.1940', deces:'', lieuN:'Paris',      lieuD:'', photo:'', bio:'', anecdotes:'', pereId:null, mereId:null },
    { id:'3', prenom:'Mich√®le Marie-Louise', nom:'Monsigny', naissance:'30.09.1935', deces:'', lieuN:'Paris', lieuD:'', photo:'', bio:'', anecdotes:'', pereId:null, mereId:null },
    { id:'1', prenom:'Alexandrine', nom:'Bareau',     naissance:'18.09.1974', deces:'', lieuN:'Winterthur', lieuD:'', photo:'', bio:'', anecdotes:'', pereId:'2', mereId:'3' },
    { id:'4', prenom:'G√©raldine',   nom:'Bareau',     naissance:'20.04.1976', deces:'', lieuN:'Winterthur', lieuD:'', photo:'', bio:'', anecdotes:'', pereId:'2', mereId:'3' },
    { id:'5', prenom:'Virginie',    nom:'Flesch',     naissance:'23.11.1956', deces:'', lieuN:'Winterthur', lieuD:'', photo:'', bio:'', anecdotes:'', pereId:null, mereId:'3' },
  ];
}

function updateSubtitle() {
  const noms = [...new Set(persons.map(p=>p.nom).filter(Boolean))];
  document.getElementById('subTitle').textContent = noms.length ? noms.slice(0,3).join(' ¬∑ ') : 'Notre famille';
}

// ============================================================
// RENDER CARDS
// ============================================================
function getEmoji(p) {
  const fem = ['a','e','ie','ine','elle','ette','√®ne','oise','ine'];
  const n = (p.prenom||'').toLowerCase().split(' ')[0];
  const f = fem.some(e => n.endsWith(e));
  const dead = !!p.deces;
  const age = calcAge(p.naissance);
  if (dead && age > 60) return f ? 'üëµ' : 'üë¥';
  if (dead) return f ? 'üë©' : 'üë®';
  if (age < 12) return f ? 'üëß' : 'üë¶';
  if (age > 70) return f ? 'üëµ' : 'üë¥';
  return f ? 'üë©' : 'üë®';
}

function calcAge(b) {
  if (!b) return 50;
  const p = b.split('.');
  if (p.length < 3) return 50;
  return new Date().getFullYear() - parseInt(p[2]);
}

function birthYear(p) {
  if (!p.naissance) return null;
  const parts = p.naissance.split('.');
  return parts.length >= 3 ? parseInt(parts[2]) : null;
}

function formatYears(p) {
  const b = p.naissance || '';
  const d = p.deces || '';
  if (b && d) return `* ${b}  ‚úù ${d}`;
  if (b) return `* ${b}`;
  return '';
}

function renderCards() {
  const q = document.getElementById('searchInput').value.toLowerCase().trim();
  let list = persons.filter(p => {
    const full = (p.prenom+' '+p.nom).toLowerCase();
    return !q || full.includes(q) || (p.lieuN||'').toLowerCase().includes(q);
  });

  // Sort
  list.sort((a,b) => {
    if (sortMode === 'naissance') {
      const ay = birthYear(a) || 9999, by = birthYear(b) || 9999;
      return ay - by;
    }
    if (sortMode === 'nom') return (a.nom||'').localeCompare(b.nom||'', 'fr');
    return a.prenom.localeCompare(b.prenom, 'fr');
  });

  document.getElementById('statsBar').textContent = list.length === persons.length
    ? `${persons.length} personne${persons.length>1?'s':''} dans l'arbre`
    : `${list.length} sur ${persons.length} personnes`;

  const grid = document.getElementById('grid');
  if (!list.length) {
    grid.innerHTML = `<div class="empty"><div class="empty-icon">${q?'üîç':'üå±'}</div><div class="empty-title">${q?'Aucun r√©sultat':'Arbre vide'}</div></div>`;
    return;
  }

  grid.innerHTML = list.map((p,i) => `
    <div class="card" style="animation-delay:${Math.min(i*.04,.6)}s" onclick="openDetail('${p.id}')">
      <div class="card-photo">${p.photo?`<img src="${p.photo}" alt="${p.prenom}">`:`${getEmoji(p)}`}</div>
      <div class="card-info">
        <div class="card-name">${p.prenom} ${p.nom}</div>
        <div class="card-years">${formatYears(p)}</div>
        ${p.lieuN?`<div class="card-gen">üìç ${p.lieuN}</div>`:''}
      </div>
    </div>`).join('');
}

function setSort(mode, el) {
  sortMode = mode;
  document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  renderCards();
}

// ============================================================
// DETAIL
// ============================================================
function openDetail(id) {
  const p = persons.find(x=>x.id===id);
  if (!p) return;

  // Photo
  document.getElementById('dPhoto').innerHTML = p.photo
    ? `<img src="${p.photo}" alt="${p.prenom}">`
    : `<span style="font-size:90px">${getEmoji(p)}</span>`;

  document.getElementById('dName').textContent = `${p.prenom} ${p.nom}`;
  document.getElementById('dDates').textContent = formatYears(p);

  // Info grid
  let info = '';
  if (p.lieuN) info += `<div class="ii"><div class="il">üìç Lieu de naissance</div><div class="iv"><a href="https://www.google.com/maps/search/${encodeURIComponent(p.lieuN)}" target="_blank" class="map-link">${p.lieuN} üó∫Ô∏è</a></div></div>`;
  if (p.lieuD) info += `<div class="ii"><div class="il">üìç Lieu de d√©c√®s</div><div class="iv"><a href="https://www.google.com/maps/search/${encodeURIComponent(p.lieuD)}" target="_blank" class="map-link">${p.lieuD} üó∫Ô∏è</a></div></div>`;
  document.getElementById('dInfoGrid').innerHTML = info;

  // Bio + Anecdotes
  let bioHtml = '';
  if (p.bio) bioHtml += `<div class="sec-title">üìñ Biographie</div><div class="bio">${p.bio}</div>`;
  if (p.anecdotes) bioHtml += `<div class="sec-title">‚ú® Anecdotes</div><div class="bio">${p.anecdotes}</div>`;
  document.getElementById('dBio').innerHTML = bioHtml;

  // PARENTS
  const pere = p.pereId ? persons.find(x=>x.id===p.pereId) : null;
  const mere = p.mereId ? persons.find(x=>x.id===p.mereId) : null;
  let parentsHtml = '';
  if (pere || mere) {
    parentsHtml = `<div class="sec-title">üë®üë© Parents</div>`;
    if (pere) parentsHtml += personLink(pere, 'üë® P√®re');
    if (mere) parentsHtml += personLink(mere, 'üë© M√®re');
  }
  document.getElementById('dParents').innerHTML = parentsHtml;

  // CHILDREN ‚Äî persons where pereId or mereId === p.id
  const children = persons.filter(x => x.pereId===p.id || x.mereId===p.id);
  let childHtml = '';
  if (children.length) {
    childHtml = `<div class="sec-title">üë∂ Enfants (${children.length})</div>`;
    children.sort((a,b)=>{ const ay=birthYear(a)||9999,by=birthYear(b)||9999; return ay-by; });
    childHtml += children.map(c => personLink(c, formatYears(c))).join('');
  }
  document.getElementById('dChildren').innerHTML = childHtml;

  // PARTENAIRE ‚Äî share same child ‚Üí common children
  // Find persons who share a child with p
  const partnerIds = new Set();
  children.forEach(c => {
    if (c.pereId && c.pereId !== p.id) partnerIds.add(c.pereId);
    if (c.mereId && c.mereId !== p.id) partnerIds.add(c.mereId);
  });
  let partHtml = '';
  if (partnerIds.size) {
    partHtml = `<div class="sec-title">üíë Partenaire(s)</div>`;
    partnerIds.forEach(pid => {
      const pp = persons.find(x=>x.id===pid);
      if (pp) partHtml += personLink(pp, formatYears(pp));
    });
  }
  document.getElementById('dPartners').innerHTML = partHtml;

  // Siblings ‚Äî same father or mother, not p itself
  // (optionally add later)

  document.getElementById('btnEdit').onclick = () => { closeOverlay('detailOverlay'); setTimeout(()=>openForm(p.id),200); };
  document.getElementById('btnDel').onclick = () => doConfirmDelete(p.id, `${p.prenom} ${p.nom}`);
  openOverlay('detailOverlay');
}

function personLink(p, subtitle) {
  return `<div class="plink" onclick="switchDetail('${p.id}')">
    <div class="pl-av">${p.photo?`<img src="${p.photo}">`:`${getEmoji(p)}`}</div>
    <div>
      <div class="pl-name">${p.prenom} ${p.nom}</div>
      <div class="pl-years">${subtitle}</div>
    </div>
    <div class="pl-arr">‚Ä∫</div>
  </div>`;
}

function switchDetail(id) {
  closeOverlay('detailOverlay');
  setTimeout(()=>openDetail(id),280);
}

// ============================================================
// FORM
// ============================================================
function openForm(id) {
  editingId = id; photoData = null; formPereId = null; formMereId = null;

  if (id) {
    const p = persons.find(x=>x.id===id);
    document.getElementById('formTitle').textContent = 'Modifier';
    document.getElementById('fPrenom').value = p.prenom||'';
    document.getElementById('fNom').value = p.nom||'';
    document.getElementById('fNaissance').value = p.naissance||'';
    document.getElementById('fDeces').value = p.deces||'';
    document.getElementById('fLieuN').value = p.lieuN||'';
    document.getElementById('fLieuD').value = p.lieuD||'';
    document.getElementById('fBio').value = p.bio||'';
    document.getElementById('fAnecdotes').value = p.anecdotes||'';
    photoData = p.photo||null;
    if (p.photo) { document.getElementById('photoPreview').src=p.photo; document.getElementById('photoPreview').style.display='block'; }
    else document.getElementById('photoPreview').style.display='none';
    formPereId = p.pereId||null;
    formMereId = p.mereId||null;
  } else {
    document.getElementById('formTitle').textContent = 'Ajouter une personne';
    ['fPrenom','fNom','fNaissance','fDeces','fLieuN','fLieuD','fBio','fAnecdotes'].forEach(i=>document.getElementById(i).value='');
    document.getElementById('photoPreview').style.display='none';
  }
  updateParentButtons();
  openOverlay('formOverlay');
}

function updateParentButtons() {
  const pere = formPereId ? persons.find(x=>x.id===formPereId) : null;
  const mere = formMereId ? persons.find(x=>x.id===formMereId) : null;
  const bp = document.getElementById('btnPickPere');
  const bm = document.getElementById('btnPickMere');
  bp.textContent = pere ? `üë® ${pere.prenom} ${pere.nom}` : '‚Äî Choisir le p√®re ‚Äî';
  bp.className = 'btn-pick-parent' + (pere?' chosen':'');
  bm.textContent = mere ? `üë© ${mere.prenom} ${mere.nom}` : '‚Äî Choisir la m√®re ‚Äî';
  bm.className = 'btn-pick-parent' + (mere?' chosen':'');
  document.getElementById('btnClearPere').style.display = pere?'block':'none';
  document.getElementById('btnClearMere').style.display = mere?'block':'none';
}

function clearParent(which) {
  if (which==='pere') formPereId=null; else formMereId=null;
  updateParentButtons();
}

function handlePhoto(e) {
  const file=e.target.files[0]; if(!file) return;
  const r=new FileReader();
  r.onload=ev=>{ photoData=ev.target.result; document.getElementById('photoPreview').src=photoData; document.getElementById('photoPreview').style.display='block'; };
  r.readAsDataURL(file);
}

function savePerson() {
  const prenom = document.getElementById('fPrenom').value.trim();
  if (!prenom) { showToast('‚ö†Ô∏è Veuillez saisir le pr√©nom'); return; }
  const data = {
    prenom,
    nom: document.getElementById('fNom').value.trim(),
    naissance: document.getElementById('fNaissance').value.trim(),
    deces: document.getElementById('fDeces').value.trim(),
    lieuN: document.getElementById('fLieuN').value.trim(),
    lieuD: document.getElementById('fLieuD').value.trim(),
    bio: document.getElementById('fBio').value.trim(),
    anecdotes: document.getElementById('fAnecdotes').value.trim(),
    photo: photoData||'',
    pereId: formPereId,
    mereId: formMereId,
  };
  if (editingId) {
    const idx=persons.findIndex(p=>p.id===editingId);
    persons[idx]={...persons[idx],...data};
    showToast('‚úÖ Enregistr√© !');
  } else {
    data.id='p'+Date.now();
    persons.push(data);
    showToast('üéâ Personne ajout√©e !');
  }
  saveData(); updateSubtitle(); closeOverlay('formOverlay'); renderCards();
}

// ============================================================
// PARENT PICKER
// ============================================================
function openPicker(target) {
  pickerTarget = target;
  document.getElementById('pickerTitle').textContent = target==='pere' ? 'Choisir le p√®re' : 'Choisir la m√®re';
  document.getElementById('pickerSearch').value = '';
  renderPickerList();
  openOverlay('pickerOverlay');
}

function renderPickerList() {
  const q = document.getElementById('pickerSearch').value.toLowerCase().trim();
  const exclude = editingId;
  const list = persons.filter(p => p.id!==exclude && (!q || (p.prenom+' '+p.nom).toLowerCase().includes(q)));
  list.sort((a,b)=>a.prenom.localeCompare(b.prenom,'fr'));
  document.getElementById('pickerList').innerHTML = list.map(p => `
    <div class="picker-item" onclick="selectParent('${p.id}')">
      <div class="picker-av">${p.photo?`<img src="${p.photo}">`:`${getEmoji(p)}`}</div>
      <div>
        <div style="font-family:'Playfair Display',serif;font-size:15px;font-weight:600">${p.prenom} ${p.nom}</div>
        <div style="font-size:12px;color:var(--text-muted)">${formatYears(p)}</div>
      </div>
    </div>`).join('') || '<div style="padding:20px;color:var(--text-muted);text-align:center">Aucun r√©sultat</div>';
}

function selectParent(id) {
  if (pickerTarget==='pere') formPereId=id; else formMereId=id;
  closeOverlay('pickerOverlay');
  updateParentButtons();
}

// ============================================================
// DELETE
// ============================================================
function doConfirmDelete(id, name) {
  document.getElementById('confirmText').textContent = `"${name}" sera d√©finitivement supprim√©(e) de l'arbre.`;
  document.getElementById('btnConfirmYes').onclick = () => {
    // Remove person, and unlink children
    persons = persons.filter(p=>p.id!==id).map(p=>({
      ...p,
      pereId: p.pereId===id ? null : p.pereId,
      mereId: p.mereId===id ? null : p.mereId,
    }));
    saveData(); updateSubtitle();
    closeOverlay('confirmOverlay'); closeOverlay('detailOverlay');
    renderCards(); showToast('üóëÔ∏è Personne supprim√©e');
  };
  closeOverlay('detailOverlay');
  setTimeout(()=>openOverlay('confirmOverlay'),200);
}

// ============================================================
// UTILS
// ============================================================
function openOverlay(id){document.getElementById(id).classList.add('open');document.body.style.overflow='hidden'}
function closeOverlay(id){document.getElementById(id).classList.remove('open');document.body.style.overflow=''}
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500)}

loadData();
</script>
</body>
</html>
